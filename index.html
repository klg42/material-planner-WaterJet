<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>Material &amp; Lamination Planner</title>
<style>

/* ===== Filter materials - match calculator neumorphic dark style ===== */
.filter-section{
  margin-top: 14px;
  padding: 14px 14px 12px;
  border-radius: 18px;
  background: rgba(18, 24, 32, 0.55);
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow:
    0 18px 40px rgba(0,0,0,0.35),
    inset 0 1px 0 rgba(255,255,255,0.06);
}
.filter-section .filter-title{
  font-size: 18px;
  font-weight: 700;
  color: rgba(255,255,255,0.92);
  margin: 0 0 10px 2px;
  letter-spacing: 0.2px;
}

.filter-title-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 8px;
}
.filter-actions{
  display:flex;
  align-items:center;
  gap:8px;
}
.filter-hide-btn{
  height: 28px;
  padding: 0 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: #e7edf6;
  font-size: 13px;
  line-height: 28px;
}
.filter-hide-btn:active{
  transform: translateY(1px);
}
.filter-clear-btn{
  height: 28px;
  padding: 0 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.88);
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.2px;
}
.filter-clear-btn:active{
  transform: scale(0.98);
}
.filter-grid{
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px 10px;
}
.filter-row{
  display: contents;
}
.filter-select{
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 40px;
  padding: 0 38px 0 14px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.09);
  background:
    linear-gradient(180deg, rgba(26,33,43,0.95), rgba(18,24,32,0.95));
  color: rgba(235,240,246,0.95);
  font-size: 14px;
  font-weight: 600;
  outline: none;
  box-shadow:
    0 10px 18px rgba(0,0,0,0.28),
    inset 0 1px 0 rgba(255,255,255,0.06),
    inset 0 -1px 0 rgba(0,0,0,0.35);
}
.filter-select:disabled{
  opacity: 0.45;
}
.filter-select:focus{
  border-color: rgba(80, 180, 255, 0.55);
  box-shadow:
    0 10px 18px rgba(0,0,0,0.28),
    0 0 0 3px rgba(80,180,255,0.18),
    inset 0 1px 0 rgba(255,255,255,0.06),
    inset 0 -1px 0 rgba(0,0,0,0.35);
}
/* custom chevron */
.filter-wrap{
  position: relative;
}
.filter-wrap::after{
  content: "";
  position: absolute;
  right: 14px;
  top: 50%;
  width: 8px;
  height: 8px;
  margin-top: -5px;
  border-right: 2px solid rgba(255,255,255,0.55);
  border-bottom: 2px solid rgba(255,255,255,0.55);
  transform: rotate(45deg);
  pointer-events: none;
}
/* iOS option list is system UI; keep options readable for desktop */
.filter-select option{
  color: #0b0f14;
}

:root {
  --bg:#070b12;
  --card:#0d1421;
  --border: rgba(255,255,255,.10);
  --muted: rgba(255,255,255,.55);
  --text: rgba(255,255,255,.92);
  --accent:#4cc3ff;
  --danger:#ff3b30;
  --shadow: 0 16px 38px rgba(0,0,0,.45);
  --radius: 18px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background: radial-gradient(1200px 700px at 20% -10%, rgba(76,195,255,.18), transparent 55%),
              radial-gradient(900px 600px at 95% 0%, rgba(255,59,48,.10), transparent 50%),
              var(--bg);
  color:var(--text);
  font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
}
.wrap{padding:18px 14px 28px;}
h1{margin:6px 0 14px; font-size:22px; letter-spacing:.2px;}
.topbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px;}
.btn{
  border:1px solid var(--border);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  color:var(--text);
  padding:10px 12px;
  border-radius:14px;
  font-size:14px;
  line-height:1;
  box-shadow: 0 8px 18px rgba(0,0,0,.25);
}
.btn.primary{background: linear-gradient(180deg, rgba(76,195,255,.35), rgba(76,195,255,.16)); border-color: rgba(76,195,255,.45);}
.btn.danger{background: linear-gradient(180deg, rgba(255,59,48,.30), rgba(255,59,48,.14)); border-color: rgba(255,59,48,.55);}
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
  margin:12px 0;
}
.itemHead{
  display:flex; gap:10px; padding:12px; align-items:center;
  border-bottom:1px solid var(--border);
  background: linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,0));
}
.pill{padding:8px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:13px; white-space:nowrap;}
.itemNo{flex:1;}
input[type="text"]{
  width:100%;
  background: rgba(255,255,255,.03);
  border:1px solid var(--border);
  color:var(--text);
  border-radius:14px;
  padding:10px 12px;
  font-size:16px; /* prevent iOS zoom */
  outline:none;
}
input[type="text"]::placeholder{color: rgba(255,255,255,.35);}
/* Force placeholders to align left (without affecting typed text) */
input::placeholder, textarea::placeholder{ text-align:left; }
input:placeholder-shown, textarea:placeholder-shown{ text-align:left !important; }


.tableWrap{padding:10px 10px 12px;}
table{width:100%; border-collapse:separate; border-spacing:0 8px; table-layout:fixed;}
th{text-align:left; font-size:12px; color:var(--muted); font-weight:600; padding:0 8px 6px;}
td{padding:0 6px;}

.field{
  width:100%;
  background: rgba(255,255,255,.03);
  border:1px solid var(--border);
  color:var(--text);
  border-radius:14px;
  padding:10px 10px;
  font-size:16px; /* prevent iOS zoom */
  line-height:1.1;
  outline:none;
}
select.field{-webkit-appearance: menulist; appearance: menulist;}
.field:disabled{opacity:.55;}
.small{text-align:center;}

/* Column widths */
.col-mat{width: 26%;}
.col-col{width: 18%;}
.col-thk{width: 14%;}
.col-psh{width: 14%;}
.col-note{width: 28%;}

@media (max-width:420px){
  .col-mat{width: 28%;}
  .col-col{width: 16%;}
  .col-thk{width: 14%;}
  .col-psh{width: 12%;}
  .col-note{width: 30%;}
  .field{padding:9px 9px;}
}

.footerHint{margin-top:10px; color: var(--muted); font-size:12px;}

/* === v2.02 compact readable layout === */
.tableWrap{padding:10px 8px 12px;}
/* Replace table layout with grid to control widths on iOS */
.gridHeader, .gridRow{
  display:grid;
  grid-template-columns: 1.4fr 1.2fr 0.8fr 0.7fr; /* Material, Color, Thk, P/Sh, Note */
  gap:6px;
  align-items:center;
}
.gridHeader{
  padding:0 4px 6px;
}
.gridHeader div{
  font-size:12px;
  color:var(--muted);
  font-weight:600;
}
.gridRow{
  margin:8px 0;
}
.gridRow .field{
  padding:8px 8px;
  font-size:14px; /* smaller but readable, still >= 14 */
  border-radius:12px;
}
.gridRow select.field{
  padding-right: 28px;
  min-width: 0;
}
.gridRow input.field{
  min-width: 0;
}
.gridRow .small{text-align:center;}
/* Prevent iOS zoom by keeping >=16 on focus: use transform trick */
.gridRow .field:focus{
  font-size:16px;
}
/* Make selects show short placeholder without truncation issues */
.field{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
/* Note field: lighter */
.noteField{color:rgba(255,255,255,.75);}
@media (max-width:420px){
  .gridHeader, .gridRow{
    grid-template-columns: 1.4fr 1.2fr 0.8fr 0.7fr;
    gap:6px;
  }
  .gridRow .field{font-size:13.5px; padding:8px 7px;}
  .gridRow .field:focus{font-size:16px;}
}


/* Layer selector */
.layerBox{display:flex; align-items:center; margin-left:8px;}
.layerSel{
  appearance:none;
  -webkit-appearance:none;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  color: rgba(255,255,255,0.85);
  padding: 10px 34px 10px 12px;
  border-radius: 14px;
  font-size: 14px;
  line-height: 1;
  position: relative;
}
.layerSel{
  background-image: linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.6) 50%),
                    linear-gradient(135deg, rgba(255,255,255,0.6) 50%, transparent 50%);
  background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%;
  background-size: 6px 6px, 6px 6px;
  background-repeat: no-repeat;
}
@media (max-width:420px){
  .layerSel{padding:10px 32px 10px 10px; font-size:13.5px;}
}


.itemIndex{
  min-width: 42px;
  height: 28px;
  border-radius: 14px;
  background: rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.85);
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
  touch-action: none;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:600;
  margin-right:10px;
 font-size:14px;  font-size:16px; 
  padding: 0 6px;}


/* Adaptive spacing */
@media (max-width: 480px){
  .rows{ row-gap: 4px; }
  .row{ padding: 4px 0; }
}
@media (min-width: 768px){
  .rows{ row-gap: 12px; }
  .row{ padding: 10px 0; }
}


.flashClear{
  box-shadow: 0 0 0 2px rgba(255,255,255,0.18), 0 0 18px rgba(0,200,255,0.22) !important;
}



/* Disable text selection while dragging */
body.dragging, body.dragging *{ -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }

/* Prevent iOS text callout/magnifier on long-press for row fields */
.noCallout{
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}

/* === Programs area: prevent text selection (iOS long-press) ===
   Disable selection also inside form controls. */
#programsWrap, #programList{
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}
#programsWrap input, #programsWrap textarea, #programsWrap select,
#programList input, #programList textarea, #programList select{
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}


/* === Item No Picker (1..15) === */
.modalOverlay{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.55);
  display:none;
  align-items:flex-end;
  justify-content:center;
  padding: 14px 12px calc(14px + env(safe-area-inset-bottom));
  z-index: 9999;
}
.modalOverlay.show{display:flex;}
.modalSheet{
  width:min(520px, 100%);
  background: linear-gradient(180deg, rgba(20,30,45,.96), rgba(10,15,25,.96));
  border:1px solid rgba(255,255,255,.14);
  border-radius: 18px;
  box-shadow: 0 22px 60px rgba(0,0,0,.55);
  overflow:hidden;
}
.modalTitle{
  padding: 12px 14px 10px;
  font-weight:700;
  letter-spacing:.2px;
  border-bottom:1px solid rgba(255,255,255,.10);
}
.pickerGrid{
  padding: 12px;
  display:grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
}
.pickerBtn{
  height: 44px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  color: rgba(255,255,255,.92);
  font-size: 16px;
  font-weight: 700;
}
.pickerBtn.on{
  border-color: rgba(76,195,255,.55);
  background: rgba(76,195,255,.18);
  box-shadow: 0 0 0 2px rgba(76,195,255,.18) inset;
}
.modalActions{
  display:flex;
  gap:10px;
  padding: 12px;
  border-top:1px solid rgba(255,255,255,.10);
}
.modalActions .btn{flex:1;}
.modalPreview{
  padding: 0 14px 10px;
  color: rgba(255,255,255,.75);
  font-size: 13px;
}


/* ItemNo Picker Modal */
.itemNoInput{ caret-color: transparent; -webkit-user-select:none; user-select:none; touch-action:manipulation; }
#itemNoPickerPanel button{ touch-action:manipulation; }
#itemNoPickerModal{position:fixed;inset:0;display:none;align-items:center;justify-content:flex-end;padding:16px;padding-bottom:calc(160px + env(safe-area-inset-bottom));background:rgba(0,0,0,.45);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);z-index:99999;}
#itemNoPickerModal.show{ display:flex; }
#itemNoPickerPanel{ width:min(520px, 96vw); margin:0 0 14px; background:rgba(20,28,38,.98); border:1px solid rgba(255,255,255,.10);
  border-radius:18px; padding:14px; box-shadow:0 18px 40px rgba(0,0,0,.55); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
#itemNoPickerTitle{ font-size:13px; opacity:.85; margin:0 0 10px; letter-spacing:.2px; }
.itemNoTopBar{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:0 0 10px;}
.itemNoTopBtns{display:flex; gap:8px;}
.topMiniBtn{height:32px; padding:0 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:#e9f2ff; font-weight:700; font-size:13px; touch-action:manipulation;}
.topMiniBtn:active{transform:scale(.98);}
.itemNoBtn.hidden{opacity:.55; outline:1px dashed rgba(255,255,255,.18); }

#itemNoPickerGrid{ display:grid; grid-template-columns:repeat(5, 1fr); gap:10px; }
.itemNoBtn{ height:44px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:#e9f2ff; font-weight:700; font-size:16px; }
.itemNoBtn.on{ background:rgba(50,190,255,.22); border-color:rgba(50,190,255,.55); }
.itemNoBtn.disabled{opacity:.35; filter:grayscale(1); cursor:not-allowed;}
.itemNoBtn.conflict{background:rgba(255,180,0,.16); border-color:rgba(255,180,0,.55);}
#itemNoPickerActions{ display:flex; gap:10px; justify-content:space-between; margin-top:12px; }
#itemNoPickerActions button{ flex:1; height:44px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:#e9f2ff; font-weight:700; touch-action:manipulation; }
#itemNoPickerActions .danger{ background:rgba(255,70,70,.16); border-color:rgba(255,70,70,.35); }
#itemNoPickerActions .primary{ background:rgba(50,190,255,.18); border-color:rgba(50,190,255,.40); }


.modalOpen{overflow:hidden;touch-action:none;}

/* Prevent background scroll + toolbar flicker on iOS when modal open */
body.scrollLocked{
  position: fixed;
  left: 0; right: 0;
  width: 100%;
  overflow: hidden;
  overscroll-behavior: none;
}

/* Meta row: Order # (main + sub) + Qty, set (total) */
.metaRow{
  display:flex;
  flex-direction:column; /* stack Order and Qty so Qty input stays near its label */
  align-items:flex-start;
  gap:12px;
}

.metaLeft{
  display:flex;
  align-items:center;
  gap:10px;
  min-width: 0;
}


/* Bigger label for Order */
#orderTap{
  font-size:30px;
  font-weight:800;
  opacity:.98;
}

/* Bigger label for Qty */
#qtyTap{
  font-size:26px;
  font-weight:700;
  opacity:.95;
}

.metaOrderInputs{
  display:flex;
  align-items:center;
  /* more space so the dash is clearly visible between Order and Sub */
  gap:10px;
  min-width: 0;
}
.metaInput{
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color:#fff;
  font-size:16px; /* prevent iOS zoom */
  outline:none;
  text-align:center;
}

/* Order field bigger font (requested) */
#orderMain.metaInput{ font-size: 16px !important; }
.metaInput:focus{ border-color: rgba(255,255,255,.28); }
.metaMain{ width: calc(8ch + 35px); }
.metaSub { width: 3ch; }
.metaQty{ width: 140px; flex: 0 0 140px; }

.metaDash { color: rgba(255,255,255,0.55); font-weight:700; font-size:18px; line-height:1; margin:0 2px; }

.metaRight{
  display:flex;
  align-items:center;
  gap:10px;
}

@media (max-width:420px){
  /* keep right field visible; allow slight wrap if needed */
  .metaRow{ flex-wrap:wrap; align-items:center; }
  .metaRight{ margin-left:auto; }
}


/* Calculate validation */
.invalidField{
  border-color: rgba(255,59,48,.60) !important;
  box-shadow: 0 0 0 3px rgba(255,59,48,.14) !important;
}


/* Cut list */
.cutSectionTitle{
  font-weight: 800;
  font-size: 14px;
  margin-top: 8px;
  margin-bottom: 10px;
  color: rgba(255,255,255,.88);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.cutSectionTitle .smallBtn{
  font-weight:700;
  font-size:12px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.25);
  background: rgba(255,255,255,.08);
  color: rgba(255,255,255,.92);
}
.cutSectionTitle .smallBtn:active{ transform: scale(.98); }

.cutGroup{
  margin-top:14px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
}
.cutTitle{
  display:flex;
  align-items:flex-start;
  gap:10px;
  font-weight:800;
  margin-bottom:6px;
  font-size: 12px;
}

.cutMeta{
  color: rgba(255,255,255,.72);
  font-size:12px;
  margin-bottom:10px;
}
.cutTable{
  width:100%;
  border-collapse: collapse;
  overflow:hidden;
  border-radius: 12px;
}
.cutTable th, .cutTable td{
  padding: 10px 12px;
  border-bottom:1px solid rgba(255,255,255,.10);
  font-size:13px;
}
.cutTable th{
  text-align:left;
  color: rgba(255,255,255,.70);
  font-weight:700;
}
.cutTable td.num{ text-align:right; font-variant-numeric: tabular-nums; }
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.80);
  font-size:12px;
}


.badge{font-size:11px;padding:2px 6px;}

/* Cut list compact + one-line */
.cutGroup{
  padding:10px !important;
  border-radius:12px !important;
  margin-top:10px !important;
}
.cutTitle{
  display:flex !important;
  align-items:center !important;
  justify-content:space-between !important;
  gap:10px !important;
  font-size:12px !important;
  line-height:1.2 !important;
  white-space:nowrap !important;
  overflow:hidden !important;
}
.cutTitle .cutLeft{
  flex:1 1 auto;
  min-width:0;
  display:-webkit-box;
  -webkit-box-orient:vertical;
  -webkit-line-clamp:2;
  overflow:hidden;
  white-space:normal;
  font-size:12px;
  line-height:1.2;
}
.cutTitle .badge{
  flex:0 0 auto;
  font-size:13px !important;
  padding:2px 7px !important;
}


/* Cutting title bigger + more spacing */
.cutSectionTitle{
  font-size: 18px !important;
  margin-top: 14px !important;
  margin-bottom: 14px !important;
}
/* Rows максимально компактно */
.cutGroup{
  padding:8px !important;
  border-radius:10px !important;
  margin-top:8px !important;
}
.cutTitle{
  gap:8px !important;
}
.cutTitle .badge{
  font-size:14px !important;
  padding:2px 8px !important;
}


.planSelect{
  margin-top:6px;
  width:100%;
 
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  color: rgba(255,255,255,.92);
  font-weight:700;
  font-size:12px;
  outline:none;
  -webkit-appearance: none;
  appearance: none;
}
.planSelect:disabled{opacity:.45;}


/* Allow wrapping up to 2 lines in Cutting plan items */
.cutLeft{
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  white-space: normal;
}


/* --- Filter materials (before Calculate) --- */
#filterBox{
  margin: 10px 0 12px;
  padding: 12px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(10,14,20,.35);
  backdrop-filter: blur(10px);
}
#filterBox .filterTitle{
  font-weight: 800;
  letter-spacing: .2px;
  font-size: 16px;
  margin: 0 0 10px;
  color: rgba(255,255,255,.9);
}
.filterRow{
  display: grid;
  grid-template-columns: 1.15fr 0.95fr 0.7fr;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}
.filterRow:last-child{ margin-bottom: 0; }
.filterRow select{
  width: 100%;
}
.filterRow .hintSmall{
  font-size: 12px;
  color: rgba(255,255,255,.45);
  margin-top: 6px;
}
@media (max-width: 430px){
  .filterRow{ grid-template-columns: 1.2fr 1fr 0.75fr; gap: 8px; }
}


/* --- Compact filter rows (extra small) --- */
.filter-section label{
  font-size:10px;
  line-height:1.1;
}

.filter-title{
  font-size:11px;
  margin-bottom:4px;
}

.filter-row{
  gap:6px;
}

.filter-row select,
.filter-row input{
  height:26px;
  font-size:10px;
  padding:2px 8px;
  border-radius:8px;
}

.filter-section{
  padding:8px;
}

/* --- Ultra compact filter rows --- */
.filter-section .filter-select,
.filter-section select{
  height: 14px !important;
  font-size: 8px !important;
  padding: 0 6px !important;
  line-height: 14px !important;
}
.filter-section label,
.filter-section .filter-title{
  font-size: 8px !important;
}
.filter-section{
  padding: 8px !important;
}


/* --- Filter materials typography adjustment --- */
.filter-section .filter-select,
.filter-section select{
  height: 14px !important;
  font-size: 9px !important;
  padding: 0 6px !important;
  line-height: 14px !important;
}

/* Title same style as Cutting plan */
.filter-section .filter-title{
  font-size: 16px !important;
  font-weight: 700 !important;
  letter-spacing: 0.2px;
}


/* --- Filter materials final typography --- */
.filter-section .filter-select,
.filter-section select{
  height: 14px !important;
  font-size: 10px !important;
  line-height: 14px !important;
}

/* Title size */
.filter-section .filter-title{
  font-size: 18px !important;
  font-weight: 700 !important;
}


/* Sub-order help button + modal */
.helpBtn{
  height: 28px;
  min-width: 28px;
  padding: 0 8px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.92);
  font-weight: 700;
  line-height: 1;
  cursor: pointer;
}
.helpBtn:active{ transform: scale(0.98); }
.helpModal{
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(6px);
  z-index: 9999;
}
.helpModal.show{ display: flex; }
.helpModalContent{
  width: min(760px, 100%);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(18,22,30,0.92);
  box-shadow: 0 20px 70px rgba(0,0,0,0.45);
  padding: 14px 14px 16px;
  max-height: 86vh;
  overflow: hidden;
}
.helpModalHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  margin-bottom: 10px;
}
.helpModalTitle{
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 0.2px;
}
.helpModalClose{
  height: 30px;
  min-width: 30px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.90);
  cursor:pointer;
}
.helpModalText{
  font-size: 14px;
  line-height: 1.35;
  color: rgba(255,255,255,0.86);
  max-height: 68vh;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  padding-right: 6px;
}

/* Help accordion */
.helpAccordion{display:flex; flex-direction:column; gap:10px;}
.accItem{border:1px solid rgba(255,255,255,0.10); border-radius:14px; background:rgba(10,12,18,0.35); overflow:hidden;}
.accHeader{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:12px 12px;
  color:rgba(255,255,255,0.92);
  background:rgba(255,255,255,0.04);
  border:0;
  cursor:pointer;
  font-weight:700;
  letter-spacing:0.2px;
}
.accHeader:active{transform:translateY(1px);}
.accChevron{opacity:0.75; font-weight:900;}
.accPanel{display:none; padding:12px 12px 14px; color:rgba(255,255,255,0.86);}
.accItem.open .accPanel{display:block;}
.accItem.open .accChevron{transform:rotate(180deg);}

@media (prefers-reduced-motion: no-preference){
  .accChevron{transition:transform .18s ease;}
}

/* Help sections (tabs) */
.helpTabs{display:none !important;}
.helpTab{padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.06); color:rgba(255,255,255,0.88); cursor:pointer; font-size:13px;}
.helpTab.active{background:rgba(90,170,255,0.18); border-color:rgba(90,170,255,0.35);}
.helpSectionTitle{font-weight:700; margin:6px 0 6px;}

/* STEP5d: summary layout - name left, qty right */
.pickRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.pickRow .txt{flex:1; text-align:left;}
.pickRow .badge{flex:0 0 auto; text-align:right;}


/* STEP5e: Plate sum layout - name left (wrap), qty right */
.cutTitleSummary{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
.cutTitleSummary .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2;}
.cutTitleSummary .badge{flex:0 0 auto; white-space:nowrap;}


/* STEP6: pick rows layout */
.pickRow{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:16px; background:rgba(255,255,255,0.06); margin:10px 0;}
.pickRow .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2; text-align:left;}
.pickRow .badge{flex:0 0 auto; white-space:nowrap; opacity:.95;}


/* Material to pick - Operator ISO view */
.isoBlock{margin:12px 0; padding:10px 12px; border-radius:16px; background:rgba(255,255,255,0.06);}
.isoHead{font-weight:700; letter-spacing:.2px; margin-bottom:8px; opacity:.95;}
.isoPlate{padding:8px 10px; margin:8px 0; border-radius:14px; background:rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.08);}
.isoPlateTitle{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; opacity:.9; margin-bottom:6px;}
.isoLine{display:block; margin:2px 0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; opacity:.95;}
.isoThk{color: rgba(255,200,120,0.95);}
/* Summary rows: name left, count right, allow wrapping */
.pickRow{display:flex; align-items:center; justify-content:space-between; gap:10px;}
.pickRow .txt{flex:1 1 auto; min-width:0; white-space:normal; overflow:visible;}
.pickRow .num{flex:0 0 auto; white-space:nowrap;}


/* Force Plate sum: name LEFT, plates RIGHT (even if other CSS overrides) */
.pickRow{flex-direction:row !important;}
.pickRow .txt{order:1 !important; text-align:left !important;}
.pickRow .num{order:2 !important; text-align:right !important;}


/* --- Operator ISO enhanced --- */
.isoGroupTitle{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 15px;
  opacity: 0.95;
  margin: 10px 0 8px;
}
.isoPlateTitle{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 15px;
  margin: 10px 0 4px;
  opacity: 0.95;
}
.isoBullets{
  margin: 0 0 8px 0;
  padding-left: 18px;
}
.isoBullets li{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 15px;
  line-height: 1.35;
  margin: 2px 0;
}
.isoFooter{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 14px;
  margin-top: 10px;
  opacity: 0.8;
}


/* --- Preparation (reserved placeholder) --- */
.prepCard{
  background: rgba(0,0,0,0.02);
  border: 1px dashed rgba(0,0,0,0.25);
  border-radius: 10px;
  padding: 12px;
  margin-top: 10px;
}
.prepHint{
  font-size: 13px;
  opacity: 0.75;
  line-height: 1.3;
}
.prepEmpty{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  font-size: 14px;
  opacity: 0.75;
  margin-top: 6px;
}


/* ===== Print: force solid black text (avoid gray from rgba) ===== */
@media print{
  :root{ --text:#000; --muted:#000; }
  body{
    background:#fff !important;
    color:#000 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
    .printHide{ display:none !important; }
/* Remove transparent/rgba text that can look gray on print */
  *{ color:#000 !important; text-shadow:none !important; box-shadow:none !important; }
  .card, .filter-section{
    background:#fff !important;
    border:1px solid #000 !important;
  }
  th{ color:#000 !important; }
  input, select, textarea{
    color:#000 !important;
    border:1px solid #000 !important;
    background:#fff !important;
  }
  /* PRINT: force all program rows open (even if Compact collapsed) */
  .itemCard .tableWrap{display:block !important;}
  .itemCard.pos-collapsed .tableWrap{display:block !important;}
  .itemCard.pos-collapsed{padding-bottom:16px !important;}


  /* Hide help button on print */
  .helpBtn, #helpBtn{ display:none !important; }
}



/* ============================= */
/* Ultra density: Programs block */
/* (iPhone-friendly, reduce height/spacing) */
/* ============================= */
#items .itemCard { padding: 10px 10px; }
#items .itemHead { padding: 8px 10px; gap: 10px; }
#items .itemTag { font-size: 13px; padding: 4px 10px; border-radius: 999px; }
#items .gridHeader { font-size: 12px; margin: 8px 0 6px; }
#items .gridRow { gap: 8px; padding: 10px; }
#items .field, #items select.field {
  height: 28px;
  padding: 0 10px;
  font-size: 14px;
  line-height: 28px;
  border-radius: 14px;
}
#items select.field { padding-right: 28px; }
#items .btn { height: 30px; padding: 0 12px; font-size: 14px; border-radius: 15px; }
#items .btnSmall { height: 28px; padding: 0 10px; font-size: 13px; border-radius: 14px; }
#items .btnDanger { height: 30px; }
#items .layerSelect { height: 30px; }

/* Compact the Add Position row */
#addItemRow { gap: 10px; }
#addItemRow .btn { height: 32px; padding: 0 14px; }

/* Programs view toggle (Full / Compact) */
.posViewButtons{display:flex;gap:8px;align-items:center;margin-left:auto;}
.posViewBtn{height:32px;padding:0 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text);font-weight:700;letter-spacing:.2px;}
.posViewBtn.active{background:rgba(126, 193, 255, .18);border-color:rgba(126, 193, 255, .38);}

/* Collapse program rows (Compact view) */
.itemCard.pos-collapsed .tableWrap{display:none;}
.itemCard.pos-collapsed .itemHead{margin-bottom:0;}

/* Collapse program rows except the header in Compact view */
.itemCard.pos-collapsed .tableWrap{display:none;}
.itemCard.pos-collapsed{padding-bottom:10px;}

/* Slightly reduce vertical spacing between programs */
#items > .itemCard { margin-top: 10px; }

/* === EXTREME TIGHT PATCH (Compact + Super) === */
body.mode-compact .gridHeader{
  padding:0 2px 1px !important;
}
body.mode-compact .gridHeader, 
body.mode-compact .gridRow{
  gap:1px !important;
}
body.mode-compact .gridRow{
  margin:2px 0 !important;
}
body.mode-compact .gridHeader div{
  line-height:1.0 !important;
  margin:0 !important;
  padding:0 !important;
}

/* Super even tighter */
body.mode-super .gridHeader{
  padding:0 2px 1px !important;
}
body.mode-super .gridHeader, 
body.mode-super .gridRow{
  gap:1px !important;
}
body.mode-super .gridRow{
  margin:1px 0 !important;
}
body.mode-super .gridHeader div{
  line-height:1.0 !important;
  margin:0 !important;
  padding:0 !important;
}

/* Reduce any leftover vertical spacing inside material section wrapper */
body.mode-compact .tableWrap,
body.mode-compact .material-block,
body.mode-compact .material-section{
  padding-top:1px !important;
  padding-bottom:1px !important;
}
body.mode-super .tableWrap,
body.mode-super .material-block,
body.mode-super .material-section{
  padding-top:1px !important;
  padding-bottom:1px !important;
}


/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* --- Qty label + input sizing (Layout A tweak) --- */
#qtyTap{font-size:18px !important; letter-spacing:0.2px;}
#qtyTotal.metaQty{flex:0 0 220px !important; width:220px !important; max-width:220px !important;}
@media (max-width:420px){
  #qtyTotal.metaQty{flex:0 0 200px !important; width:200px !important; max-width:200px !important;}
}

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}

/* === META LAYOUT (Order / Qty) – hard left alignment === */
/* The long label "Qty (total):" was pushing the input to the right.
   Enforce a fixed label column width for BOTH rows,
   so inputs start at the same X position (close to the label). */
.metaRow{
  justify-content: flex-start !important;
}

.metaRow .metaLabel{
  flex: 0 0 112px !important;  /* label column width */
  text-align: left !important;
  white-space: nowrap;
}

/* Header card: keep Order/Qty labels tight to following fields (no fixed label column width) */
.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel{
  flex: 0 0 auto !important;
  width: auto !important;
  max-width: none !important;
}


/* Keep input groups from stretching */
.metaRow .metaOrderInputs,
.metaRow .metaQtyWrap{
  flex: 0 0 auto !important;
}

/* Make Qty input shorter and keep it next to the label */
.metaQty{
  width: 220px !important;
  max-width: 220px !important;
}


/* QTY MOVELEFT OVERRIDES */
.qty-row{justify-content:flex-start !important;}
#qtyTap{min-width:120px;}
#qtyTotal{flex:0 0 120px !important; width:120px !important; max-width:120px !important; margin-left:4px !important;}

/* === META (Order / Qty) CLEAN LAYOUT OVERRIDES ===
   Goal: consistent left alignment, no auto-push of Qty input, predictable widths, easy to tweak.
*/
.meta-row{display:flex;align-items:center;justify-content:flex-start;gap:12px;}
.metaLabel{min-width:110px;line-height:1.1;text-align:left;}
/* Order row */
#orderMain{flex:0 0 140px !important; width:140px !important; max-width:140px !important;}
#orderSub{flex:0 0 70px !important; width:70px !important; max-width:70px !important;}
/* Qty row */
#qtyTotal{flex:0 0 120px !important; width:120px !important; max-width:120px !important; margin-left:4px !important;}
/* Placeholders + values: hard-left */
#orderMain,#orderSub,#qtyTotal{flex:0 0 120px !important; width:120px !important; max-width:120px !important; margin-left:4px !important;}
#orderMain::placeholder,#orderSub::placeholder,#qtyTotal::placeholder{ text-align:left !important;}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* === Preparation list font override (user requested) === */
.preparation-list,
.preparation-list * {
  font-size: 10px !important;
  line-height: 1.15 !important;
}


/* Material to pick scale (requested: from ~1.3 to 1.2) */
#matPick{
  zoom: 1.2;
}
/* Fallback for browsers where zoom is ignored */
@supports not (zoom: 1) {
  #matPick{
    transform: scale(1.2);
    transform-origin: top left;
  }
}

/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}



/* Import list checkbox */
.ocrCheckbox{
  display:flex;
  align-items:center;
  gap:8px;
  margin-right:auto;
  color:#fff;
  font-size:14px;
}
.ocrCheckbox input{
  width:16px;
  height:16px;
  accent-color:#1e88e5;
}


.ocrModalFooter{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.ocrFooterRow{
  display:flex;
  justify-content:flex-start;
}
.ocrFooterActions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
}


.ocrCheckboxTop{
  margin: 8px 0 12px 0;
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
  color:#fff;
}


/* Global Out-per-plate: disabled per-row input look */
input.field.small.disabled{
  opacity: 0.55;
  filter: saturate(0.8);
}


/* --- Order/Sub inactive when empty (like Qty total) --- */
.metaInput.orderInactive{
  opacity:0.55;
}
.metaInput.orderInactive::placeholder{
  color: transparent; /* hide placeholder text */
}


@media print{
  .printHide{ display:none !important; }
}


.print-btn{touch-action:manipulation;-webkit-tap-highlight-color:transparent;}
</style>
<style>
/* === sub + help spacing & parity === */
.metaSub { height: 34px; font-size: 14px; }
.helpBtn {
  height: 34px;
  min-height: 34px;
  font-size: 14px;
  line-height: 1;
  padding: 0 10px;
  margin-left: 16px; /* increased gap between sub and ? */
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* STEP5d: summary layout - name left, qty right */
.pickRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.pickRow .txt{flex:1; text-align:left;}
.pickRow .badge{flex:0 0 auto; text-align:right;}


/* STEP5e: Plate sum layout - name left (wrap), qty right */
.cutTitleSummary{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
.cutTitleSummary .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2;}
.cutTitleSummary .badge{flex:0 0 auto; white-space:nowrap;}


/* STEP6: pick rows layout */
.pickRow{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:16px; background:rgba(255,255,255,0.06); margin:10px 0;}
.pickRow .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2; text-align:left;}
.pickRow .badge{flex:0 0 auto; white-space:nowrap; opacity:.95;}


/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}

/* === META LAYOUT (Order / Qty) – hard left alignment === */
/* The long label "Qty (total):" was pushing the input to the right.
   Enforce a fixed label column width for BOTH rows,
   so inputs start at the same X position next to the label. */
.metaRow{
  justify-content: flex-start !important;
  align-items: center !important;
}

.metaRow .metaLabel{
  flex: 0 0 112px !important;  /* label column width */
  text-align: left !important;
  white-space: nowrap !important;
}

/* Move Qty input right after the label and shorten it */
.metaRow.qty-row .metaQty{
  margin-left: 0 !important;
  width: 240px !important;
  max-width: 240px !important;
}

/* Also keep Order input group starting at the same X */
.metaRow.order-row .metaOrderInputs{
  margin-left: 0 !important;
}

/* On narrow screens, allow the label to wrap rather than pushing the input away */
@media (max-width: 420px){
  .metaRow .metaLabel{ white-space: normal !important; }
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Width adjustments per request === */
/* Make Order field same as sub, then shift widths: sub -15px, order +15px */
.metaMain { width: 55px !important; } /* base same as sub */
.metaSub  { width: 40px !important; } /* sub reduced by 15 */
.metaMain { width: 70px !important; } /* order increased by 15 */

/* STEP5d: summary layout - name left, qty right */
.pickRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.pickRow .txt{flex:1; text-align:left;}
.pickRow .badge{flex:0 0 auto; text-align:right;}


/* STEP5e: Plate sum layout - name left (wrap), qty right */
.cutTitleSummary{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
.cutTitleSummary .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2;}
.cutTitleSummary .badge{flex:0 0 auto; white-space:nowrap;}


/* STEP6: pick rows layout */
.pickRow{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:16px; background:rgba(255,255,255,0.06); margin:10px 0;}
.pickRow .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2; text-align:left;}
.pickRow .badge{flex:0 0 auto; white-space:nowrap; opacity:.95;}


/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style id="orderSizingV3">
/* === Requested sizing (Order/Sub/?/Qty) === */
.metaMain{ width: 140px !important; }
.metaSub{ width: 60px !important; }

/* Gap between Order and Sub (within the order inputs group) */
.metaOrderInputs{ gap: 12px !important; }

/* Gap between Sub and ? + ensure same typography */
.helpBtn{
  font-size: 16px !important;
  margin-left: clamp(12px, 10vw, 80px) !important; /* Sub → ? gap */
  height: 34px;
  min-height: 34px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* Qty field width relative to the card */
.metaQty{ width: 60% !important; }


/* App header (final) */
.appHeader{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:14px;
  padding:8px 4px 14px 4px;
}
.appHeaderLeft{ min-width:0; }
.appTitle{
  font-size: 22px;
  font-weight: 800;
  letter-spacing: .2px;
  line-height: 1.15;
  word-break: break-word;
}
.appSubtitle{
  margin-top: 4px;
  font-size: 18px;
  font-weight: 700;
  opacity: .95;
  line-height: 1.1;
}
.appHeaderRight{
  text-align:right;
  flex:0 0 auto;
  padding-right:2px;
}
.appBy{
  font-size: 18px;
  font-weight: 650;
  opacity: .85;
  line-height: 1.15;
  white-space: nowrap;
}
/* Tap-to-clear labels */
.metaTap{
  cursor: pointer;
  -webkit-tap-highlight-color: rgba(255,255,255,0);
  user-select: none;
}

/* STEP5d: summary layout - name left, qty right */
.pickRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.pickRow .txt{flex:1; text-align:left;}
.pickRow .badge{flex:0 0 auto; text-align:right;}


/* STEP5e: Plate sum layout - name left (wrap), qty right */
.cutTitleSummary{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
.cutTitleSummary .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2;}
.cutTitleSummary .badge{flex:0 0 auto; white-space:nowrap;}


/* STEP6: pick rows layout */
.pickRow{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:16px; background:rgba(255,255,255,0.06); margin:10px 0;}
.pickRow .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2; text-align:left;}
.pickRow .badge{flex:0 0 auto; white-space:nowrap; opacity:.95;}


/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
  .app-version{
    display:inline-block;
    margin-left:6px;
    font-size:11px;
    opacity:0.6;
    vertical-align:baseline;
  }

/* STEP5d: summary layout - name left, qty right */
.pickRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.pickRow .txt{flex:1; text-align:left;}
.pickRow .badge{flex:0 0 auto; text-align:right;}


/* STEP5e: Plate sum layout - name left (wrap), qty right */
.cutTitleSummary{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
.cutTitleSummary .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2;}
.cutTitleSummary .badge{flex:0 0 auto; white-space:nowrap;}


/* STEP6: pick rows layout */
.pickRow{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:16px; background:rgba(255,255,255,0.06); margin:10px 0;}
.pickRow .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2; text-align:left;}
.pickRow .badge{flex:0 0 auto; white-space:nowrap; opacity:.95;}


/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
  .app-version-top {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 11px;
    opacity: 0.6;
    letter-spacing: 0.3px;
    pointer-events: none;
  }
  .header, header {
    position: relative;
  }

/* STEP5d: summary layout - name left, qty right */
.pickRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.pickRow .txt{flex:1; text-align:left;}
.pickRow .badge{flex:0 0 auto; text-align:right;}


/* STEP5e: Plate sum layout - name left (wrap), qty right */
.cutTitleSummary{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
.cutTitleSummary .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2;}
.cutTitleSummary .badge{flex:0 0 auto; white-space:nowrap;}


/* STEP6: pick rows layout */
.pickRow{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:16px; background:rgba(255,255,255,0.06); margin:10px 0;}
.pickRow .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2; text-align:left;}
.pickRow .badge{flex:0 0 auto; white-space:nowrap; opacity:.95;}


/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
  .cutTitle{ display:flex; align-items:center; gap:10px; }
  .cutChk{ width:18px; height:18px; flex:0 0 18px; accent-color: #e74c3c; }
  .cutGroup.done .cutLeft,
  .cutGroup.done .cutTitle .badge{
    text-decoration: line-through;
    opacity: 0.55;
  }
  .cutGroup.done .cutDetails{
    opacity: 0.45;
  }

/* STEP5d: summary layout - name left, qty right */
.pickRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.pickRow .txt{flex:1; text-align:left;}
.pickRow .badge{flex:0 0 auto; text-align:right;}


/* STEP5e: Plate sum layout - name left (wrap), qty right */
.cutTitleSummary{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
.cutTitleSummary .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2;}
.cutTitleSummary .badge{flex:0 0 auto; white-space:nowrap;}


/* STEP6: pick rows layout */
.pickRow{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:16px; background:rgba(255,255,255,0.06); margin:10px 0;}
.pickRow .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2; text-align:left;}
.pickRow .badge{flex:0 0 auto; white-space:nowrap; opacity:.95;}


/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
  .cutChk{
    filter: drop-shadow(0 0 1px rgba(0,0,0,0.6));
  }

/* STEP5d: summary layout - name left, qty right */
.pickRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.pickRow .txt{flex:1; text-align:left;}
.pickRow .badge{flex:0 0 auto; text-align:right;}


/* STEP5e: Plate sum layout - name left (wrap), qty right */
.cutTitleSummary{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
.cutTitleSummary .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2;}
.cutTitleSummary .badge{flex:0 0 auto; white-space:nowrap;}


/* STEP6: pick rows layout */
.pickRow{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:16px; background:rgba(255,255,255,0.06); margin:10px 0;}
.pickRow .txt{flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; line-height:1.2; text-align:left;}
.pickRow .badge{flex:0 0 auto; white-space:nowrap; opacity:.95;}


/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style id="matPickRowForceOrder">
/* Force Plate sum row: name left, values right (robust against earlier CSS duplicates) */
.pickRow{display:flex !important; align-items:flex-start !important; justify-content:flex-start !important;}
.pickRow .txt{order:1 !important; flex:1 1 auto !important; min-width:0 !important; text-align:left !important;
  white-space:normal !important; overflow-wrap:anywhere !important; line-height:1.2 !important;}
.pickRow .badge{order:2 !important; flex:0 0 auto !important; margin-left:12px !important; text-align:right !important;
  white-space:nowrap !important;}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* hide reserved preparation placeholder */
.preparation-reserved,
.preparation-placeholder,
.preparation-next-step {
  display: none !important;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* Preparation rules tiny font */
.preparation-rules,
.prep-rules,
.rules-note,
.rules {
  font-size: 6px !important;
  line-height: 1.1 !important;
  opacity: 0.8;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* ===== Density Toggle UI ===== */
.densityToggle{display:flex;gap:6px;margin-left:auto;align-items:center}
.densityToggle button{
  height:22px;
  padding:0 10px;
  font-size:11px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.25);
  background:transparent;
  color: rgba(255,255,255,.88);
}
.densityToggle button.active{background:#fff;color:#000}

/* =========================================================
   Density modes
   - Compact: more readable / bigger targets
   - Ultra: same controls height (22px) but tighter
   - Super: "machine" mode: minimum gaps + smaller headers/text
   IMPORTANT: Keep text inputs at 16px to avoid iOS zoom.
   ========================================================= */

/* ----- COMPACT (28px) — Programs only ----- */
body.mode-compact #items .field,
body.mode-compact #items .filter-select,
body.mode-compact #items .planSelect,
body.mode-compact #items .itemNoInput,
body.mode-compact #items .btnSmall,
body.mode-compact #items button{
  height:28px;min-height:28px;line-height:28px;
  padding:0 10px;font-size:12px;border-radius:12px;
}
/* keep small inputs a bit narrower but same height */
body.mode-compact #items .field.small{padding:0 8px;font-size:12px}

/* ----- SUPER (machine) — Programs only ----- */
/* keep height 22px (avoid iOS zoom); reduce padding and rounding */
body.mode-super #items .field,
body.mode-super #items .filter-select,
body.mode-super #items .planSelect,
body.mode-super #items .itemNoInput,
body.mode-super #items .btnSmall,
body.mode-super #items button{
  height:22px;min-height:22px;line-height:22px;
  padding:0 4px;font-size:11px;border-radius:8px;
}
body.mode-super #items .itemHead{gap:6px}
body.mode-super #items .grid{gap:4px}

/* =========================================================
   Global typography + spacing per mode
   (this is what affects Header + PR + gaps between blocks)
   ========================================================= */
:root{
  --d-title: 22px;
  --d-subtitle: 18px;
  --d-by: 18px;

  --d-label: 14px;
  --d-th: 12px;
  --d-td: 13px;

  --d-lh: 1.15;

  --d-card-margin: 12px;
  --d-card-pad-y: 12px;
  --d-card-pad-x: 14px;

  --d-section-pad: 14px;
  --d-section-gap: 10px;

  --d-table-gap: 8px;
}

/* COMPACT: slightly bigger text and air */
body.mode-compact{
  /* Compact = bigger text, but SAME tight spacing / full width feel as Super */
  --d-title: 16px;
  --d-subtitle: 12px;
  --d-by: 12px;

  --d-label: 11.5px;
  --d-th: 11px;
  --d-td: 11px;

  /* ultra-tight line height (may look very dense) */
  --d-lh: 0.98;

  /* "fill width" feel: minimal margins/padding */
  --d-card-margin: 6px;
  --d-card-pad-y: 6px;
  --d-card-pad-x: 8px;

  --d-section-pad: 8px;
  --d-section-gap: 2px;

  /* remove table gaps between rows */
  --d-table-gap: 0px;
}

/* ULTRA: tighter header/text + smaller gaps */
  --d-title: 18px;
  --d-subtitle: 14px;
  --d-by: 14px;

  --d-label: 12px;
  --d-th: 11px;
  --d-td: 12px;

  --d-lh: 1.12;

  --d-card-marginlabel: 10px;
  --d-th: 10px;
  --d-td: 10px;

  --d-lh: 0.95;

  --d-card-margin: 4px;
  --d-card-pad-y: 4px;
  --d-card-pad-x: 6px;

  --d-section-pad: 6px;
  --d-section-gap: 1px;

  --d-table-gap: 0px;
}

/* Apply variables */
.appTitle{
  font-size: var(--d-title) !important;
  line-height: var(--d-lh) !important;
  margin: 0 !important;
}
.appSubtitle{
  font-size: var(--d-subtitle) !important;
  line-height: var(--d-lh) !important;
  margin-top: 2px !important;
}
.appBy{
  font-size: var(--d-by) !important;
  line-height: var(--d-lh) !important;
}

/* Meta labels + general small labels */

/* Keep meta inputs at 16px to avoid iOS zoom, but tighten vertical size via padding in ultra/super */
body.mode-super .metaInput{
  padding: 6px 10px !important;
  border-radius: 12px !important;
}

/* Cards: reduce vertical rhythm */
.card{
  margin: var(--d-card-margin) 0 !important;
}
.card > div[style*="padding:"],
#calcCard .filter-section{
  /* do not break inline styles, just tighten where possible */
}

/* Filter-section tighter in ultra/super */
body.mode-super .filter-section{
  padding: var(--d-section-pad) var(--d-section-pad) calc(var(--d-section-pad) - 2px) !important;
  margin-top: 10px !important;
}
body.mode-super .filter-grid{ gap: 6px 6px !important; }

/* Table spacing + PR readability */
table{
  border-spacing: 0 var(--d-table-gap) !important;
}
th{
  font-size: var(--d-th) !important;
  line-height: var(--d-lh) !important;
  padding-bottom: 4px !important;
  margin: 0 !important;
}
td{
  font-size: var(--d-td) !important;
  line-height: var(--d-lh) !important;
}




/* COMPACT: make it fill width like Super + tighten gaps more */
body.mode-compact .wrap{ padding: 10px 8px 14px !important; }
body.mode-compact .topbar{ margin-bottom: 6px !important; gap: 6px !important; }
body.mode-compact .card{ margin: 4px 0 !important; } /* was 6px */
body.mode-compact .itemHead{ padding: 8px !important; }
body.mode-compact .tableWrap{ padding: 6px 6px 8px !important; }
body.mode-compact .gridRow{ margin: 3px 0 !important; }
body.mode-compact table{ border-spacing: 0 1px !important; }
body.mode-compact th{ padding-bottom: 1px !important; }
body.mode-compact td{ padding-top: 0px !important; padding-bottom: 0px !important; }

/* Also reduce spacing between internal blocks inside program cards */
body.mode-compact #items .grid{ gap: 4px !important; }
body.mode-compact #items .itemHead{ gap: 6px !important; }
/* SUPER: absolute minimum between rows / blocks */
body.mode-super .wrap{ padding: 10px 8px 14px !important; }
body.mode-super .topbar{ margin-bottom: 6px !important; gap: 6px !important; }
body.mode-super .card{ margin: 6px 0 !important; }
body.mode-super .itemHead{ padding: 8px !important; }
body.mode-super .tableWrap{ padding: 6px 6px 8px !important; }
body.mode-super .gridRow{ margin: 4px 0 !important; }
body.mode-super table{ border-spacing: 0 2px !important; }
body.mode-super th{ padding-bottom: 2px !important; }
body.mode-super .filter-section{ margin-top: 8px !important; padding: 10px 10px 8px !important; }


/* SUPER: shrink Preparation table + PR header padding (override inline paddings) */
body.mode-super .simpleTable{ font-size: 11px !important; }
body.mode-super .simpleTable th,
body.mode-super .simpleTable td{
  padding: 3px 6px !important;
  line-height: 1.05 !important;
}
body.mode-super .simpleTable td{ font-size: 11px !important; }
body.mode-super .simpleTable th{ font-size: 10px !important; }

/* Reduce big default margins if any headings remain */
h1,h2,h3{ margin: 4px 0 !important; line-height: var(--d-lh) !important; }



/* === EXTRA TIGHT ROWS (Compact + Super) === */
body.mode-compact table,
body.mode-super table{ border-collapse: collapse !important; border-spacing: 0 !important; }

body.mode-compact td, body.mode-compact th,
body.mode-super td, body.mode-super th{
  padding: 0 2px !important;
  line-height: var(--d-lh) !important;
}

body.mode-compact .pr,
body.mode-super .pr,
body.mode-compact p,
body.mode-super p,
body.mode-compact label,
body.mode-super label{
  margin: 0 !important;
  padding: 0 !important;
  line-height: var(--d-lh) !important;
}


/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Header labels compacted === */
.columns-header, .material-header, .table-header {
  font-size: 11px !important;
  margin-top: 3px !important;
  margin-bottom: 3px !important;
  line-height: 1.0 !important;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Tighter spacing for Material header & field === */
.material-header,
.columns-header,
.table-header {
  margin-top: 2px !important;
  margin-bottom: 2px !important;
  padding-top: 0 !important;
  padding-bottom: 0 !important;
  line-height: 1.0 !important;
  font-size: 11px !important;
}

.material-header + *,
.columns-header + * {
  margin-top: 2px !important;
}

.material-row,
.material-grid,
.grid {
  gap: 2px !important;
}

.pr-card,
.program-card {
  padding-top: 4px !important;
  padding-bottom: 4px !important;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Cutting plan tighter spacing === */
.cutting-plan-item,
.cutting-plan-row,
.cutting-plan-card {
  padding-top: 4px !important;
  padding-bottom: 4px !important;
  margin-top: 4px !important;
  margin-bottom: 4px !important;
}

.cutting-plan-item .label,
.cutting-plan-row .label {
  line-height: 1.05 !important;
}

.cutting-plan-item + .cutting-plan-item {
  margin-top: 4px !important;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Cutting plan ULTRA tight === */
.cutting-plan-item,
.cutting-plan-row,
.cutting-plan-card {
  padding-top: 2px !important;
  padding-bottom: 2px !important;
  margin-top: 2px !important;
  margin-bottom: 2px !important;
}

.cutting-plan-item + .cutting-plan-item {
  margin-top: 2px !important;
}

.cutting-plan-item .label,
.cutting-plan-row .label {
  line-height: 1.0 !important;
}

/* checkbox closer to text */
.cutting-plan-item input[type="checkbox"] {
  margin-right: 6px !important;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Cutting plan MAX tight (red-marked gaps) === */
.cutting-plan-item,
.cutting-plan-row,
.cutting-plan-card {
  padding-top: 1px !important;
  padding-bottom: 1px !important;
  margin-top: 1px !important;
  margin-bottom: 1px !important;
  border-top-width: 0.5px !important;
  border-bottom-width: 0.5px !important;
}

.cutting-plan-item + .cutting-plan-item {
  margin-top: 1px !important;
}

.cutting-plan-item .label,
.cutting-plan-row .label {
  line-height: 0.95 !important;
}

/* reduce inner container spacing */
.cutting-plan-item > * {
  margin-top: 0 !important;
  margin-bottom: 0 !important;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === PR -> Material spacing tighter (x2) === */
.pr-header,
.pr-row,
.program-header {
  margin-bottom: 4px !important; /* was ~8 */
}

.pr-header + .material-header,
.pr-row + .material-header {
  margin-top: 4px !important; /* was ~8 */
}

.material-header {
  margin-top: 4px !important;
  margin-bottom: 4px !important;
  line-height: 1.0 !important;
}

.material-header + .material-grid,
.material-header + .grid {
  margin-top: 2px !important;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === FIX: actual spacing sources are #items .gridHeader / .gridRow / .tableWrap === */
/* Reduce red-marked gap: PR header -> Material header */
#items .gridHeader{
  margin: 4px 0 3px !important; /* was 8px 0 6px */
  padding: 0 !important;
  font-size: 11px !important;
  line-height: 1.0 !important;
}

/* Reduce gap: Material header -> first input row and overall block padding */
#items .gridRow{
  gap: 4px !important;          /* was 8px */
  padding: 5px !important;      /* was 10px */
}

/* Reduce container padding around the table section */
.tableWrap{
  padding: 5px 6px 6px !important; /* was 10px 10px 12px */
}

/* Reduce margin between row groups if used */
.gridRow{
  margin: 4px 0 !important; /* was 8px 0 in base CSS */
}

/* Optional: tighten item card top/bottom padding slightly */
.itemCard{ padding: 8px 8px !important; } /* was 10px 10px */
#items .itemHead{ padding: 6px 8px !important; gap: 8px !important; } /* was 8px 10px; gap 10px */

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Remove duplicate check icon (right-side extra icon) === */
/* Hide secondary/duplicate icons inside select-like inputs */
.select-wrapper svg + svg,
.select-wrapper .icon + .icon,
.field-icon.duplicate,
input + .check-icon {
  display: none !important;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === FORCE remove remaining check icon === */
/* Case 1: native select arrow/check via appearance */
select {
  -webkit-appearance: none !important;
  -moz-appearance: none !important;
  appearance: none !important;
  background-image: none !important;
}

/* Case 2: pseudo-elements used as icons */
select::after,
select::before,
.input::after,
.input::before,
.field::after,
.field::before {
  content: none !important;
  display: none !important;
}

/* Case 3: inline SVG icons anywhere inside input wrappers */
input svg,
select svg,
.field svg,
.input svg {
  display: none !important;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === STD / 1L buttons + keep Add Position visible === */
.topbar{display:flex !important;align-items:center !important;gap:10px !important;flex-wrap:nowrap !important;}
.topbar > .btn.primary{flex:0 0 auto;}
#modeButtons{margin-left:auto;display:inline-flex;gap:8px;flex:0 0 auto;}
.modeBtn{
  height:30px;min-width:44px;padding:0 12px;
  border-radius:999px;border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);
  color:inherit;font-weight:700;
}
.modeBtn.active{background:rgba(255,255,255,.18);}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Force lock layer selector in 1L (iOS-safe) === */
body.mode1l select.layerSel,
body.mode1l select.layerSelect,
body.mode1l select[name*="layer"],
body.mode1l select[id*="layer"]{
  pointer-events:none !important;
  -webkit-user-select:none !important;
  user-select:none !important;
  opacity:0.75;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
.prHeaderRow{
  display:flex;
  align-items:center;
  gap:8px;
}
.prItemLabel{
  font-size:12px;
  opacity:0.65;
  min-width:32px;
  text-align:right;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Visual lock for Item (1L only) === */
.itemNo{ position: relative; }
.itemNo .itemLock{
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  font-size:12px;
  opacity:.7;
  display:none;
  pointer-events:none;
}
body.mode1l .itemNo .itemLock{ display:block; }
body.mode1l .itemNo .itemNoInput{ padding-right:28px !important; }

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Reduce header font by ~1pt === */
.gridHeader,
.gridHeader div,
.gridHeader span{
  font-size: calc(100% - 1.33px) !important;
}

/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Topbar layout: center STD/1L, Full plate on right === */
/* Extra safe gap above button row */
.topbar{margin-top:12px !important;}
.topbar{
  display:flex !important;
  align-items:center !important;
  gap:10px !important;
  position:relative !important;
}
.topbar .btn.primary{flex:0 0 auto;}
#modeButtons{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
}
#btnFullPlate{
  margin-left:auto;
}

/* === Out per plate lock for Full plate === */
.pshWrap{position:relative;}
.pshLock{
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  font-size:12px;
  opacity:.7;
  display:none;
  pointer-events:none;
}
body.fullPlate .pshLock{display:block;}
body.fullPlate input[id^="psh_"]{padding-right:28px !important;pointer-events:none;}

/* === EXTRA GAP between button row and PR list (prevent mis-taps) === */
.topbar{margin-bottom:26px !important;}
#items{margin-top:0 !important;} /* keep only one gap source */


/* ORDER field – bigger font for better visibility */
input[name="order"],
.order-input,
#orderInput {
    font-size: 18px !important;
    font-weight: 600;
}


/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* --- OVERRIDE: bigger labels in meta box (Order / Qty) --- */
#metaBox 
#metaBox 

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
  /* XL labels for Order/Qty (iOS needed high specificity) */
  

/* FINAL label size overrides (requested) */
#orderTap{font-size:16px !important;}
#qtyTap{font-size:10px !important;}

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Rebuilt labels from scratch === */
.metaLabel{
  font-size: 18px !important;
  font-weight: 600 !important;
  line-height: 1.2 !important;
  opacity: 1 !important;
}
.metaLabel.qty{
  font-size: 16px !important;
  font-weight: 500 !important;
  opacity: 0.9 !important;
}

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Layout A: keep labels on left, push inputs to the right (works with existing inline flex rows) === */
#qtyTap + input{ margin-left:auto !important; } /* pushes Qty input to the right */

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* FINAL real fix for Qty label and input */
#qtyTap{
  font-size: 20px !important;
  font-weight: 600 !important;
}

#qtyTap + input,
input.qtyInput{
  width: 120px !important;
  max-width: 120px !important;
  flex: 0 0 120px !important;
  /* Qty (total) input should be left-aligned */
  text-align: left !important;
  padding-left: 14px !important;
}

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Baseline alignment for Order and Qty labels === */
.metaRow{
  align-items: baseline !important;
}

#orderTap,
#qtyTap{
  line-height: 1.1 !important;
  display: inline-flex;
  align-items: baseline;
}

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Make Qty same size as Order === */
#qtyTap{
  font-size: 20px !important; /* same as Order */
  font-weight: 600 !important;
}

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Qty smaller by -4px compared to Order === */
#qtyTap{
  font-size: 16px !important;
  font-weight: 600 !important;
}

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Order bigger by +2px === */
#orderTap{
  font-size: 22px !important;
  font-weight: 600 !important;
}

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Align Qty (total) label to the right === */
#qtyTap{
  text-align: right !important;
  justify-content: flex-end;
  width: 100%;
}

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Center align Order and Qty labels === */
#orderTap,
#qtyTap{
  text-align: center !important;
  justify-content: center !important;
}

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style>
/* === Left align Order and Qty labels === */
#orderTap,
#qtyTap{
  text-align: left !important;
  justify-content: flex-start !important;
}

/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style id="qtyLeftFix">
/* FIX: move Qty (total) input to the left and shorten it */
.meta-row{display:flex;align-items:center;gap:10px;}
.meta-row.qty-row{justify-content:flex-start;}
.meta-row.qty-row #qtyTotal{flex:0 0 120px !important; width:120px !important; max-width:120px !important; margin-left:4px !important;}
.meta-row.qty-row #qtyTap{min-width:120px;}

/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<style id="prepTableAutoFit">
/* Preparation list: tighter columns + auto-fit */
.prepTable{ table-layout:auto !important; }
.prepTable th, .prepTable td{
  padding: 4px 6px !important;   /* tighter horizontal gaps */
  white-space: nowrap !important; /* avoid wrapping to 2nd line */
}
.prepTable th{ padding-bottom: 6px !important; }

/* Keep long text from breaking layout (Material/Color) */
.prepTable td:nth-child(4),
.prepTable td:nth-child(5){
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>




<style id="prep-font-override">
/* Preparation list: bigger font. Final override (wins). */
.prepTable, .prepTable * ,
.preparation-table, .preparation-table * {
  font-size: 18px !important;
  line-height: 1.15 !important;
}

/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>

<style id="center-thk-ios-fix">
/* iOS Safari: make select text truly centered */
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness{
  text-align: center !important;
  text-align-last: center !important;
  -webkit-text-align-last: center !important;
  text-indent: 0 !important;
  padding-left: 0.1rem !important;
  padding-right: 0.1rem !important;
}
/* Center options in the wheel list where supported */
.material-row[data-material*="MLF"] select.thickness option,
.material-row[data-material*="Noppe"] select.thickness option{
  text-align: center;
}
/* Also center plain thickness inputs */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input{
  text-align: center !important;
}

/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>


<style id="ocrImportStyles">
/* === OCR Import modal (matches app dark/glass UI) === */
.ocrModal{position:fixed;inset:0;display:none;z-index:9999}
.ocrModal.open{display:block}

.ocrModalBackdrop{
  position:absolute;
  inset:0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.ocrModalDialog{
  position:relative;
  width:min(640px, calc(100% - 28px));
  margin:60px auto;
  background: rgba(18,22,30,0.92);
  color: rgba(235,240,246,0.95);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 18px;
  box-shadow:
    0 28px 60px rgba(0,0,0,0.55),
    inset 0 1px 0 rgba(255,255,255,0.06);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  overflow:hidden;
}

.ocrModalHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  background: linear-gradient(180deg, rgba(26,33,43,0.95), rgba(18,24,32,0.95));
  border-bottom: 1px solid rgba(255,255,255,0.10);
}
.ocrModalTitle{font-weight:800;font-size:14px;letter-spacing:0.2px;color:rgba(255,255,255,0.92)}
.ocrModalX{
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  color: rgba(160,210,255,0.95);
  font-size:18px;
  line-height:1;
  cursor:pointer;
  padding:6px 10px;
  border-radius:12px
}
.ocrModalX:active{transform:scale(.98)}

.ocrModalBody{padding:12px;display:flex;flex-direction:column;gap:10px}
.ocrModalHint{font-size:12px;opacity:.9;color:rgba(235,240,246,0.92)}
.ocrCode{
  display:inline-block;
  margin-top:6px;
  padding:8px 10px;
  border-radius:12px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:11px;
  white-space:pre
}

.ocrTextarea{
  width:100%;
  min-height:210px;
  resize:vertical;
  padding:10px 12px;
  border-radius:16px;
  border: 1px solid rgba(255,255,255,0.14);
  background: linear-gradient(180deg, rgba(26,33,43,0.95), rgba(18,24,32,0.95));
  color: rgba(235,240,246,0.95);
  font-size:16px; /* iOS: avoid zoom */
  line-height:1.25;
  box-shadow:
    0 14px 26px rgba(0,0,0,0.32),
    inset 0 1px 0 rgba(255,255,255,0.06),
    inset 0 -1px 0 rgba(0,0,0,0.35);
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}
.ocrTextarea::placeholder{color: rgba(255,255,255,0.40)}

.ocrError{
  color: rgba(255,210,220,0.98);
  font-size:12px;
  background: rgba(176,0,32,.18);
  border: 1px solid rgba(255,255,255,0.10);
  padding:8px 10px;
  border-radius:12px
}

.ocrModalFoot{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  padding:10px 12px;
  border-top: 1px solid rgba(255,255,255,0.10);
  background: rgba(18,22,30,0.92);
}

/* Buttons inside modal use app buttons; just harmonize sizes */
.ocrModal .btn{height:34px;padding:0 14px;border-radius:14px}
.ocrModal .btn.primary{
  border-color: rgba(80,180,255,0.55);
  background: rgba(76,195,255,.18);
  color: rgba(235,245,255,0.98);
}
</style>


<style>
@media print {
  .order-sub-sep { display:none !important; }
  .order-sub.print-hidden { display:none !important; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

</head>
<body class="mode-compact">
<div class="wrap">
<header class="appHeader">
<div class="app-version-top">v1.0</div>
<div class="appHeaderLeft">
<div class="appTitle">Material &amp; Lamination Planner</div>
<div class="appSubtitle">for Waterjet / Cutting</div>
</div>
<div class="appHeaderRight">
<div class="appBy">by Kostiantyn</div>
<div class="appBy">Lukianenko</div>
</div>
</header>
<div class="card" style="margin:10px 0;">
<div style="padding:12px 14px; display:flex; flex-direction:column; gap:6px;">
<div id="orderRow" class="meta-row order-row" style="display:flex; align-items:center; gap:10px;">
          <div class="meta-label" style="min-width:86px;">Order #.</div>

          <input id="orderMain" class="metaInput" inputmode="numeric" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                 placeholder="" style="flex:1; min-width:120px;">

          <span id="orderDash" class="metaDash" aria-hidden="true">–</span>

          <input id="orderSub" class="metaInput metaInputSmall" inputmode="numeric" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                 placeholder="" style="width:72px; min-width:72px; text-align:center;">

          <button id="helpBtn" class="helpBtn" type="button" aria-label="Help">ℹ️</button>
        </div>
<div class="meta-row qty-row" style="display:flex; align-items:center; gap:4px;">
<span class="metaLabel metaTap" id="qtyTap">Qty (total):</span>
<input autocapitalize="off" autocomplete="off" autocorrect="off" class="metaInput metaQty" id="qtyTotal" inputmode="numeric" placeholder="0" spellcheck="false" type="text"/>

<span class="meta-label" id="globalPshLabel" style="margin-left:14px;">Out per plate:</span>
<select id="globalPshMode" class="field small" style="width:92px; padding-left:12px; padding-right:28px;">
  <option value="manual">Var</option>
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
  <option value="6">6</option>
  <option value="7">7</option>
  <option value="8">8</option>
  <option value="9">9</option>
</select>
</div>
</div>
</div>
<div class="topbar">
<button class="btn primary" id="addItemBtn" onclick="addItem()">+ Add Position</button>
<button class="btn" id="importOcrBtn" type="button" style="margin-left:6px;" onclick="(function(){var m=document.getElementById('ocrImportModal');if(!m)return;m.classList.add('open');m.setAttribute('aria-hidden','false');var eb=document.getElementById('ocrImportError');if(eb){eb.style.display='none';eb.textContent='';}var ta=document.getElementById('ocrImportText');if(ta){setTimeout(function(){try{ta.focus();}catch(e){}},50);}})();">Import list</button>
      <button class="btn print-btn" id="pdfBtn" type="button">📄 PDF</button>

<div class="posViewButtons" id="posViewButtons" aria-label="Programs view">
  <button class="posViewBtn active" id="posViewFull" type="button">Full</button>
  <button class="posViewBtn" id="posViewCompact" type="button">Compact</button>
</div>
<div class="modeButtons" id="modeButtons" style="display:none">
<button class="modeBtn active" id="btnModeStd" type="button">STD</button>
<button class="modeBtn" id="btnMode1L" type="button">1L</button>
</div>
<button class="modeBtn" id="btnFullPlate" style="display:none" type="button">Full plate</button>
</div>
<div id="items"></div>
<!-- Calculate -->
<div class="card" id="calcCard">
<div class="filter-section">
<div id="filterBox">
<div class="filter-title-row">
<div class="filterTitle"><span class="filter-title">Filter materials</span></div>
<div class="filter-actions">
<button aria-label="Hide filter rows" class="filter-hide-btn" id="filtersHideBtn" type="button">Hide</button>
<button aria-label="Clear filter materials" class="filter-clear-btn" id="filtersClearBtn" type="button">Clear</button>
</div>
</div>
<div id="filtersRows">
<div class="filterRow">
<div class="filter-wrap"><select aria-label="Filter 1 material" class="filterField filter-select" id="fMat1"></select></div>
<div class="filter-wrap"><select aria-label="Filter 1 color" class="filterField filter-select" id="fCol1"></select></div>
<div class="filter-wrap"><select aria-label="Filter 1 thickness" class="filterField filter-select" id="fThk1"></select></div>
</div>
<div class="filterRow">
<div class="filter-wrap"><select aria-label="Filter 2 material" class="filterField filter-select" id="fMat2"></select></div>
<div class="filter-wrap"><select aria-label="Filter 2 color" class="filterField filter-select" id="fCol2"></select></div>
<div class="filter-wrap"><select aria-label="Filter 2 thickness" class="filterField filter-select" id="fThk2"></select></div>
</div>
<div class="filterRow">
<div class="filter-wrap"><select aria-label="Filter 3 material" class="filterField filter-select" id="fMat3"></select></div>
<div class="filter-wrap"><select aria-label="Filter 3 color" class="filterField filter-select" id="fCol3"></select></div>
<div class="filter-wrap"><select aria-label="Filter 3 thickness" class="filterField filter-select" id="fThk3"></select></div>
</div>
</div>
</div>
<div class="itemHead" style="justify-content:space-between;">
<div class="pill" style="border-style:dashed; color:rgba(255,255,255,.75);">Check &amp; Calculate</div>
<button class="btn primary" id="btnCalc" type="button">Расчёт</button>
</div>
<div class="tableWrap">
<div id="calcOk" style="display:none; padding:10px 12px; border-radius:14px; border:1px solid rgba(76,195,255,.35); background:rgba(76,195,255,.10);">
        ✅ Все поля заполнены.
      </div>
<div id="calcErr" style="display:none; padding:10px 12px; border-radius:14px; border:1px solid rgba(255,59,48,.45); background:rgba(255,59,48,.12);">
<div style="font-weight:700; margin-bottom:6px;">Нужно заполнить:</div>
<ul id="calcErrList" style="margin:6px 0 0 18px; padding:0;"></ul>
</div>
<div class="footerHint" style="margin-top:10px;">Сейчас «Расчёт» делает проверку заполнения и формирует перечень порезанных материалов (Cut list).</div>
<div id="cutList" style="margin-top:12px;"></div>
<!-- Output sections: Material to pick + Preparation (placeholders; filled later) -->
<div class="cutSectionTitle" id="matPickTitle"><span>Material to pick</span><button class="smallBtn" id="matPickToggleBtn" type="button">Plate sum</button></div>
<div id="matPick" style="margin-top:8px;">
<div id="matPickViewA"></div>
<div id="matPickViewB" style="display:none;"></div>
</div>
<div id="prep" style="margin-top:8px; margin-bottom:18px;"></div>
</div>
</div>
<!-- Item No Picker Modal -->
<div aria-hidden="true" aria-modal="true" class="modalOverlay" id="itemNoLegacyModal" role="dialog">
<div class="modalSheet">
<div class="modalTitle">Item No.</div>
<div class="modalPreview">Selected: </div>
<div class="pickerGrid" id="itemNoGrid"></div>
<div class="modalActions">
<button class="btn" onclick="itemNoPickerClear()" type="button">Clear</button>
<button class="btn primary" onclick="itemNoPickerDone()" type="button">Done</button>
</div>
</div>
</div>
</div>
<script>
const MATERIALS_DB = [
  { Material: "PE20N", Color: "", Thickness_mm: 150, material: "PE20N", color: "", thk: 150 },
  { Material: "PE30N", Color: "", Thickness_mm: 150, material: "PE30N", color: "", thk: 150 },
  { Material: "PE30NCN", Color: "", Thickness_mm: 150, material: "PE30NCN", color: "", thk: 150 },
  { Material: "PE45N", Color: "", Thickness_mm: 150, material: "PE45N", color: "", thk: 150 },
  { Material: "Basotect G+", Color: "", Thickness_mm: 100, material: "Basotect G+", color: "", thk: 100 },
  { Material: "PPI10", Color: "", Thickness_mm: 250, material: "PPI10", color: "", thk: 250 },
  { Material: "PPI15", Color: "", Thickness_mm: 250, material: "PPI15", color: "", thk: 250 },
  { Material: "PPI20", Color: "", Thickness_mm: 250, material: "PPI20", color: "", thk: 250 },
  { Material: "PPI30", Color: "", Thickness_mm: 250, material: "PPI30", color: "", thk: 250 },
  { Material: "PPI45", Color: "", Thickness_mm: 250, material: "PPI45", color: "", thk: 250 },
  { Material: "PPI60", Color: "", Thickness_mm: 250, material: "PPI60", color: "", thk: 250 },
  { Material: "PPI80", Color: "", Thickness_mm: 250, material: "PPI80", color: "", thk: 250 },
  { Material: "PPI90", Color: "", Thickness_mm: 250, material: "PPI90", color: "", thk: 250 },
  { Material: "PU23B", Color: "", Thickness_mm: 10, material: "PU23B", color: "", thk: 10 },
  { Material: "PU23B", Color: "", Thickness_mm: 50, material: "PU23B", color: "", thk: 50 },
  { Material: "PU23B", Color: "", Thickness_mm: 60, material: "PU23B", color: "", thk: 60 },
  { Material: "PU23B", Color: "", Thickness_mm: 100, material: "PU23B", color: "", thk: 100 },
  { Material: "PU23B Noppe", Color: "", Thickness_mm: 5, material: "PU23B Noppe", color: "", thk: 5 },
  { Material: "PU23B Noppe", Color: "", Thickness_mm: 7, material: "PU23B Noppe", color: "", thk: 7.5 },
  { Material: "PU23B Noppe", Color: "", Thickness_mm: 10, material: "PU23B Noppe", color: "", thk: 10 },
  { Material: "PU23B Noppe", Color: "", Thickness_mm: 15, material: "PU23B Noppe", color: "", thk: 15 },
  { Material: "PU23B Noppe", Color: "", Thickness_mm: 20, material: "PU23B Noppe", color: "", thk: 20 },
  { Material: "PU23B Noppe", Color: "", Thickness_mm: 25, material: "PU23B Noppe", color: "", thk: 25 },
  { Material: "PU23B Noppe", Color: "", Thickness_mm: 30, material: "PU23B Noppe", color: "", thk: 30 },
  { Material: "EPDM A", Color: "", Thickness_mm: 55, material: "EPDM A", color: "", thk: 55 },
  { Material: "EPDM B", Color: "", Thickness_mm: 75, material: "EPDM B", color: "", thk: 75 },
  { Material: "PE22", Color: "Black", Thickness_mm: 30, material: "PE22", color: "Black", thk: 30 },
  { Material: "PE22", Color: "Black", Thickness_mm: 40, material: "PE22", color: "Black", thk: 40 },
  { Material: "PE22", Color: "Black", Thickness_mm: 50, material: "PE22", color: "Black", thk: 50 },
  { Material: "PE22", Color: "Black", Thickness_mm: 80, material: "PE22", color: "Black", thk: 80 },
  { Material: "PE22", Color: "Black", Thickness_mm: 100, material: "PE22", color: "Black", thk: 100 },
  { Material: "PE22", Color: "White", Thickness_mm: 10, material: "PE22", color: "White", thk: 10 },
  { Material: "PE22", Color: "White", Thickness_mm: 20, material: "PE22", color: "White", thk: 20 },
  { Material: "PE22", Color: "White", Thickness_mm: 30, material: "PE22", color: "White", thk: 30 },
  { Material: "PE22", Color: "White", Thickness_mm: 40, material: "PE22", color: "White", thk: 40 },
  { Material: "PE22", Color: "White", Thickness_mm: 50, material: "PE22", color: "White", thk: 50 },
  { Material: "PE22", Color: "White", Thickness_mm: 60, material: "PE22", color: "White", thk: 60 },
  { Material: "PE22", Color: "White", Thickness_mm: 80, material: "PE22", color: "White", thk: 80 },
  { Material: "PE22", Color: "White", Thickness_mm: 90, material: "PE22", color: "White", thk: 90 },
  { Material: "PE22", Color: "White", Thickness_mm: 100, material: "PE22", color: "White", thk: 100 },
  { Material: "PE22", Color: "White", Thickness_mm: 120, material: "PE22", color: "White", thk: 120 },
  { Material: "PE27AS", Color: "", Thickness_mm: 50, material: "PE27AS", color: "", thk: 50 },
  { Material: "PE27AS", Color: "", Thickness_mm: 80, material: "PE27AS", color: "", thk: 80 },
  { Material: "PE27AS", Color: "", Thickness_mm: 100, material: "PE27AS", color: "", thk: 100 },
  { Material: "PE28", Color: "Black", Thickness_mm: 50, material: "PE28", color: "Black", thk: 50 },
  { Material: "PE28", Color: "Black", Thickness_mm: 100, material: "PE28", color: "Black", thk: 100 },
  { Material: "PE28", Color: "White", Thickness_mm: 50, material: "PE28", color: "White", thk: 50 },
  { Material: "PE28", Color: "White", Thickness_mm: 100, material: "PE28", color: "White", thk: 100 },
  { Material: "PE140L", Color: "White", Thickness_mm: 50, material: "PE140L", color: "White", thk: 50 },
  { Material: "PE36", Color: "Black", Thickness_mm: 50, material: "PE36", color: "Black", thk: 50 },
  { Material: "PE36", Color: "Black", Thickness_mm: 100, material: "PE36", color: "Black", thk: 100 },
  { Material: "PE36", Color: "White", Thickness_mm: 50, material: "PE36", color: "White", thk: 50 },
  { Material: "PE36AS", Color: "Pink", Thickness_mm: 50, material: "PE36AS", color: "Pink", thk: 50 },
  { Material: "PE65", Color: "White", Thickness_mm: 20, material: "PE65", color: "White", thk: 20 },
  { Material: "PE65", Color: "White", Thickness_mm: 50, material: "PE65", color: "White", thk: 50 },
  { Material: "PE96", Color: "White", Thickness_mm: 50, material: "PE96", color: "White", thk: 50 },
  { Material: "PEXL30", Color: "", Thickness_mm: 50, material: "PEXL30", color: "", thk: 50 },
  { Material: "PEXL45", Color: "", Thickness_mm: 50, material: "PEXL45", color: "", thk: 50 },
  { Material: "PEXL60J", Color: "", Thickness_mm: 50, material: "PEXL60J", color: "", thk: 50 },
  { Material: "Bonden RE100", Color: "", Thickness_mm: 50, material: "Bonden RE100", color: "", thk: 50 },
  { Material: "Bonden RE130", Color: "", Thickness_mm: 50, material: "Bonden RE130", color: "", thk: 50 },
  { Material: "PU23", Color: "White", Thickness_mm: 50, material: "PU23", color: "White", thk: 50 },
  { Material: "PU23 Noppe", Color: "White", Thickness_mm: 10, material: "PU23 Noppe", color: "White", thk: 10 },
  { Material: "PU30AS", Color: "", Thickness_mm: 5, material: "PU30AS", color: "", thk: 5 },
  { Material: "PU30AS", Color: "", Thickness_mm: 60, material: "PU30AS", color: "", thk: 60 },
  { Material: "PU30AS", Color: "", Thickness_mm: 100, material: "PU30AS", color: "", thk: 100 },
  { Material: "PU30AS Noppe", Color: "Pink", Thickness_mm: 10, material: "PU30AS Noppe", color: "Pink", thk: 10 },
  { Material: "PU30AS Noppe", Color: "Pink", Thickness_mm: 15, material: "PU30AS Noppe", color: "Pink", thk: 15 },
  { Material: "PU30AS Noppe", Color: "Pink", Thickness_mm: 25, material: "PU30AS Noppe", color: "Pink", thk: 25 },
  { Material: "PEXL40", Color: "", Thickness_mm: 100, material: "PEXL40", color: "", thk: 100 },
  { Material: "PEXL40CN", Color: "", Thickness_mm: 80, material: "PEXL40CN", color: "", thk: 80 },
  { Material: "PEXL60", Color: "", Thickness_mm: 100, material: "PEXL60", color: "", thk: 100 },
  { Material: "PU24CN", Color: "", Thickness_mm: 6, material: "PU24CN", color: "", thk: 6 },
  { Material: "PU24CN", Color: "", Thickness_mm: 50, material: "PU24CN", color: "", thk: 50 },
  { Material: "PU24CN", Color: "", Thickness_mm: 100, material: "PU24CN", color: "", thk: 100 },
  { Material: "PU24CN Noppe", Color: "", Thickness_mm: 15, material: "PU24CN Noppe", color: "", thk: 15 },
  { Material: "PU24CN Noppe", Color: "", Thickness_mm: 20, material: "PU24CN Noppe", color: "", thk: 20 },
  { Material: "PU24CN Noppe", Color: "", Thickness_mm: 25, material: "PU24CN Noppe", color: "", thk: 25 },
  { Material: "EV30", Color: "", Thickness_mm: 30, material: "EV30", color: "", thk: 30 },
  { Material: "EV50", Color: "", Thickness_mm: 30, material: "EV50", color: "", thk: 30 },
  { Material: "LD15", Color: "", Thickness_mm: 50, material: "LD15", color: "", thk: 50 },
  { Material: "LD18", Color: "Black", Thickness_mm: 50, material: "LD18", color: "Black", thk: 50 },
  { Material: "LD18", Color: "White", Thickness_mm: 50, material: "LD18", color: "White", thk: 50 },
  { Material: "LD24", Color: "", Thickness_mm: 50, material: "LD24", color: "", thk: 50 },
  { Material: "LD24FM", Color: "", Thickness_mm: 30, material: "LD24FM", color: "", thk: 30 },
  { Material: "LD24FR", Color: "", Thickness_mm: 30, material: "LD24FR", color: "", thk: 30 },
  { Material: "LD29", Color: "Black", Thickness_mm: 50, material: "LD29", color: "Black", thk: 50 },
  { Material: "LD29", Color: "Black", Thickness_mm: 100, material: "LD29", color: "Black", thk: 100 },
  { Material: "LD29", Color: "White", Thickness_mm: 50, material: "LD29", color: "White", thk: 50 },
  { Material: "LD30SD", Color: "", Thickness_mm: 30, material: "LD30SD", color: "", thk: 30 },
  { Material: "LD32CN", Color: "", Thickness_mm: 30, material: "LD32CN", color: "", thk: 30 },
  { Material: "LD45FR", Color: "", Thickness_mm: 30, material: "LD45FR", color: "", thk: 30 },
  { Material: "LD50CN", Color: "", Thickness_mm: 30, material: "LD50CN", color: "", thk: 30 },
  { Material: "LD60", Color: "", Thickness_mm: 28, material: "LD60", color: "", thk: 28 },
  { Material: "LD70", Color: "", Thickness_mm: 28, material: "LD70", color: "", thk: 28 },
  { Material: "PK80", Color: "", Thickness_mm: 35, material: "PK80", color: "", thk: 35 },
  { Material: "LD33", Color: "Black", Thickness_mm: 30, material: "LD33", color: "Black", thk: 30 },
  { Material: "LD33", Color: "White", Thickness_mm: 30, material: "LD33", color: "White", thk: 30 },
  { Material: "LD33", Color: "Blue", Thickness_mm: 30, material: "LD33", color: "Blue", thk: 30 },
  { Material: "LD33", Color: "Red", Thickness_mm: 30, material: "LD33", color: "Red", thk: 30 },
  { Material: "LD33", Color: "Yellow", Thickness_mm: 30, material: "LD33", color: "Yellow", thk: 30 },
  { Material: "LD33", Color: "Orange", Thickness_mm: 30, material: "LD33", color: "Orange", thk: 30 },
  { Material: "LD33", Color: "Purple", Thickness_mm: 30, material: "LD33", color: "Purple", thk: 30 },
  { Material: "LD33", Color: "Violet", Thickness_mm: 30, material: "LD33", color: "Violet", thk: 30 },
  { Material: "LD33", Color: "Pink", Thickness_mm: 30, material: "LD33", color: "Pink", thk: 30 },
  { Material: "LD33", Color: "Hot Pink", Thickness_mm: 30, material: "LD33", color: "Hot Pink", thk: 30 },
  { Material: "LD33", Color: "Grey", Thickness_mm: 30, material: "LD33", color: "Grey", thk: 30 },
  { Material: "LD33", Color: "Light Grey", Thickness_mm: 30, material: "LD33", color: "Light Grey", thk: 30 },
  { Material: "LD33", Color: "Green", Thickness_mm: 30, material: "LD33", color: "Green", thk: 30 },
  { Material: "LD33", Color: "Spring Green", Thickness_mm: 30, material: "LD33", color: "Spring Green", thk: 30 },
  { Material: "LD33", Color: "Navy", Thickness_mm: 30, material: "LD33", color: "Navy", thk: 30 },
  { Material: "LD45", Color: "Black", Thickness_mm: 30, material: "LD45", color: "Black", thk: 30 },
  { Material: "LD45", Color: "White", Thickness_mm: 30, material: "LD45", color: "White", thk: 30 },
  { Material: "LD45", Color: "Blue", Thickness_mm: 30, material: "LD45", color: "Blue", thk: 30 },
  { Material: "LD45", Color: "Red", Thickness_mm: 30, material: "LD45", color: "Red", thk: 30 },
  { Material: "LD45", Color: "Yellow", Thickness_mm: 30, material: "LD45", color: "Yellow", thk: 30 },
  { Material: "LD45", Color: "Green", Thickness_mm: 30, material: "LD45", color: "Green", thk: 30 },
  { Material: "LD45", Color: "Orange", Thickness_mm: 30, material: "LD45", color: "Orange", thk: 30 },
  { Material: "PEXL28", Color: "Std.", Thickness_mm: 100, material: "PEXL28", color: "Std.", thk: 100 },
  { Material: "PEXL28", Color: "Black", Thickness_mm: 100, material: "PEXL28", color: "Black", thk: 100 },
  { Material: "PEXL28", Color: "Grey", Thickness_mm: 100, material: "PEXL28", color: "Grey", thk: 100 },
  { Material: "PEXL28", Color: "Blue", Thickness_mm: 100, material: "PEXL28", color: "Blue", thk: 100 },
  { Material: "PEXL28", Color: "Red", Thickness_mm: 100, material: "PEXL28", color: "Red", thk: 100 },
  { Material: "PEXL28", Color: "Green", Thickness_mm: 100, material: "PEXL28", color: "Green", thk: 100 },
  { Material: "PEXL28", Color: "Yellow", Thickness_mm: 100, material: "PEXL28", color: "Yellow", thk: 100 },
  { Material: "PEXL28", Color: "Orange", Thickness_mm: 100, material: "PEXL28", color: "Orange", thk: 100 },
  { Material: "MLF", Color: "Black", Thickness_mm: 30, material: "MLF", color: "Black", thk: 30 },
  { Material: "MLF", Color: "Black / Red", Thickness_mm: 30, material: "MLF", color: "Black / Red", thk: 30 },
  { Material: "MLF", Color: "Black / Green", Thickness_mm: 30, material: "MLF", color: "Black / Green", thk: 30 },
  { Material: "MLF", Color: "Black / Blue", Thickness_mm: 30, material: "MLF", color: "Black / Blue", thk: 30 },
  { Material: "MLF", Color: "Black / Yellow", Thickness_mm: 30, material: "MLF", color: "Black / Yellow", thk: 30 },
  { Material: "MLF", Color: "Black", Thickness_mm: 50, material: "MLF", color: "Black", thk: 50 },
  { Material: "MLF", Color: "Black / Red", Thickness_mm: 50, material: "MLF", color: "Black / Red", thk: 50 },
  { Material: "MLF", Color: "Black / Green", Thickness_mm: 50, material: "MLF", color: "Black / Green", thk: 50 },
  { Material: "MLF", Color: "Black / Blue", Thickness_mm: 50, material: "MLF", color: "Black / Blue", thk: 50 },
  { Material: "MLF", Color: "Black / Yellow", Thickness_mm: 50, material: "MLF", color: "Black / Yellow", thk: 50 },
  { Material: "MLF", Color: "Black", Thickness_mm: 70, material: "MLF", color: "Black", thk: 70 },
  { Material: "MLF", Color: "Black / Red", Thickness_mm: 70, material: "MLF", color: "Black / Red", thk: 70 },
  { Material: "MLF", Color: "Black / Green", Thickness_mm: 70, material: "MLF", color: "Black / Green", thk: 70 },
  { Material: "MLF", Color: "Black / Blue", Thickness_mm: 70, material: "MLF", color: "Black / Blue", thk: 70 },
  { Material: "MLF", Color: "Black / Yellow", Thickness_mm: 70, material: "MLF", color: "Black / Yellow", thk: 70 }
];

// === Thickness options from materials table (Material|Color -> [Thickness_mm,...]) ===
const THK_OPTIONS_BY_MATERIAL_COLOR = {"Basotect G+|": [100.0], "Bonden RE100|": [50.0], "Bonden RE130|": [50.0], "EPDM A|": [55.0], "EPDM B|": [75.0], "EV30|": [30.0], "EV50|": [30.0], "LD15|": [50.0], "LD18|Black": [50.0], "LD18|White": [50.0], "LD24|": [50.0], "LD24FM|": [30.0], "LD24FR|": [30.0], "LD29|Black": [50.0, 100.0], "LD29|White": [50.0], "LD30SD|": [30.0], "LD32CN|": [30.0], "LD33|Black": [30.0], "LD33|Blue": [30.0], "LD33|Green": [30.0], "LD33|Grey": [30.0], "LD33|Hot Pink": [30.0], "LD33|Light Grey": [30.0], "LD33|Navy": [30.0], "LD33|Orange": [30.0], "LD33|Pink": [30.0], "LD33|Purple": [30.0], "LD33|Red": [30.0], "LD33|Spring Green": [30.0], "LD33|Violet": [30.0], "LD33|White": [30.0], "LD33|Yellow": [30.0], "LD45|Black": [30.0], "LD45|Blue": [30.0], "LD45|Green": [30.0], "LD45|Orange": [30.0], "LD45|Red": [30.0], "LD45|White": [30.0], "LD45|Yellow": [30.0], "LD45FR|": [30.0], "LD50CN|": [30.0], "LD60|": [28.0], "LD70|": [28.0], "MLF|Black": [30.0, 50.0, 70.0], "MLF|Black / Blue": [30.0, 50.0, 70.0], "MLF|Black / Green": [30.0, 50.0, 70.0], "MLF|Black / Red": [30.0, 50.0, 70.0], "MLF|Black / Yellow": [30.0, 50.0, 70.0], "PE140L|White": [50.0], "PE20N|": [150.0], "PE22|Black": [30.0, 40.0, 50.0, 80.0, 100.0], "PE22|White": [10.0, 20.0, 30.0, 40.0, 50.0, 60.0, 80.0, 90.0, 100.0, 120.0], "PE27AS|": [50.0, 80.0, 100.0], "PE28|Black": [50.0, 100.0], "PE28|White": [50.0, 100.0], "PE30N|": [150.0], "PE30NCN|": [150.0], "PE36|Black": [50.0, 100.0], "PE36|White": [50.0], "PE36AS|Pink": [50.0], "PE45N|": [150.0], "PE65|White": [20.0, 50.0], "PE96|White": [50.0], "PEXL28|Black": [100.0], "PEXL28|Blue": [100.0], "PEXL28|Green": [100.0], "PEXL28|Grey": [100.0], "PEXL28|Std.": [100.0], "PEXL28|Orange": [100.0], "PEXL28|Red": [100.0], "PEXL28|Yellow": [100.0], "PEXL30|": [50.0], "PEXL40|": [100.0], "PEXL40CN|": [80.0], "PEXL45|": [50.0], "PEXL60|": [100.0], "PEXL60J|": [50.0], "PK80|": [35.0], "PPI10|": [250.0], "PPI15|": [250.0], "PPI20|": [250.0], "PPI30|": [250.0], "PPI45|": [250.0], "PPI60|": [250.0], "PPI80|": [250.0], "PPI90|": [250.0], "PU23|White": [50.0], "PU23 Noppe|White": [10.0], "PU23B|": [10.0, 50.0, 60.0, 100.0], "PU23B Noppe|": [5.0, 7.5, 10.0, 15.0, 20.0, 25.0, 30.0], "PU24CN|": [6.0, 50.0, 100.0], "PU24CN Noppe|": [15.0, 20.0, 25.0], "PU30AS|": [5.0, 60.0, 100.0], "PU30AS Noppe|Pink": [10.0, 15.0, 25.0]};

// Lamination process constants
const LAM_MIN_THK = 5.0;   // mm (minimum lamination layer)   // mm (minimum lamination layer)
const LAM_SHRINK = 0; // was 0.5, set to 0 per request
const MAX_LAYERS  = 10; // maximum layers for auto lamination plan
// mm (shrinkage compensation)

// Helpers for thickness options
function thkKey(material, color){
  return `${(material||"").trim()}|${(color||"").trim()}`;
}
function getThkOptions(material, color){
  const k = thkKey(material, color);
  return THK_OPTIONS_BY_MATERIAL_COLOR[k] || THK_OPTIONS_BY_MATERIAL_COLOR[thkKey(material,"")] || [];
}
function pickNominalForTarget(material, color, targetThk){
  const opts = getThkOptions(material, color).slice().sort((a,b)=>a-b);
  if(!opts.length) return NaN;
  if(!Number.isFinite(targetThk)) return opts[opts.length-1];
  let nominal = NaN;
  for(const t of opts){
    if(t <= targetThk + 1e-9) nominal = t;
  }
  return Number.isFinite(nominal) ? nominal : opts[opts.length-1];
}

// === Auto lamination solver (up to MAX_LAYERS) ===
// We choose k stock sheets so that SUM(stock) is minimal but >= SUM_CUT, where:
// SUM_CUT = target + (k-1)*LAM_SHRINK  (compensate shrinkage per glue joint)
// Each cut thickness per layer must be >= LAM_MIN_THK.
// After choosing stocks, we allocate cuts by "reducing" some layers (waste) until SUM_CUT is reached.
// --- Filters (Material + Color + Stock Thickness) used by Cutting / Lamination solver ---
const FILTERS_KEY = 'mc_filter_materials_v1';
let FILTER_STATE = [
  {mat:'', col:'', thk:''},
  {mat:'', col:'', thk:''},
  {mat:'', col:'', thk:''},
];

function loadFilters(){
  try{
    const raw = localStorage.getItem(FILTERS_KEY);
    if(!raw) return;
    const arr = JSON.parse(raw);
    if(Array.isArray(arr) && arr.length){
      for(let i=0;i<3;i++){
        const f = arr[i] || {};
        FILTER_STATE[i] = {
          mat: (f.mat||''),
          col: (f.col||''),
          thk: (f.thk||'')
        };
      }
    }
  }catch(e){}
}
function saveFilters(){
  try{ localStorage.setItem(FILTERS_KEY, JSON.stringify(FILTER_STATE)); }catch(e){}
}
function setOptions(selectEl, opts, placeholder){
  selectEl.innerHTML = '';
  const ph = document.createElement('option');
  ph.value = '';
  ph.textContent = placeholder;
  selectEl.appendChild(ph);
  opts.forEach(v=>{
    const o = document.createElement('option');
    o.value = v;
    o.textContent = v;
    selectEl.appendChild(o);
  });
}
function setOptionsNum(selectEl, nums, placeholder){
  selectEl.innerHTML = '';
  const ph = document.createElement('option');
  ph.value = '';
  ph.textContent = placeholder;
  selectEl.appendChild(ph);
  nums.forEach(n=>{
    const o = document.createElement('option');
    o.value = String(n);
    o.textContent = String(n);
    selectEl.appendChild(o);
  });
}
function getAllMaterials(){
  const s = new Set();
  MATERIALS_DB.forEach(r=>{ if(r.Material) s.add(r.Material); });
  return Array.from(s).sort((a,b)=>a.localeCompare(b));
}
function updateFilterRow(i){
  const matEl = document.getElementById('fMat'+(i+1));
  const colEl = document.getElementById('fCol'+(i+1));
  const thkEl = document.getElementById('fThk'+(i+1));
  const mat = matEl.value;
  FILTER_STATE[i].mat = mat;
  // Color
  if(!mat){
    setOptions(colEl, [], 'Color');
    colEl.disabled = true;
    setOptionsNum(thkEl, [], 'Thickness');
    thkEl.disabled = true;
    FILTER_STATE[i].col = '';
    FILTER_STATE[i].thk = '';
    saveFilters();
    return;
  }
  const colors = colorsForMaterial(mat);
  if(colors.length <= 1){
    const c = colors[0] || 'Std.';
    setOptions(colEl, [c], 'Color');
    colEl.value = c;
    colEl.disabled = true;
    FILTER_STATE[i].col = c;
  }else{
    setOptions(colEl, colors, 'Color');
    colEl.disabled = false;
    // keep previous if still valid
    if(FILTER_STATE[i].col && colors.includes(FILTER_STATE[i].col)) colEl.value = FILTER_STATE[i].col;
    else { colEl.value = ''; FILTER_STATE[i].col=''; }
  }


function clearAllFilters(){
  FILTER_STATE = [
    { material:"", color:"", thk:"" },
    { material:"", color:"", thk:"" },
    { material:"", color:"", thk:"" }
  ];
  saveFilters();
  // reset UI selects
  for(let i=0;i<3;i++){
    const mSel = document.getElementById(`fMat${i}`);
    const cSel = document.getElementById(`fCol${i}`);
    const tSel = document.getElementById(`fThk${i}`);
    if(mSel){ mSel.value = ""; }
    if(cSel){ cSel.value = ""; cSel.disabled = true; }
    if(tSel){ tSel.value = ""; tSel.disabled = true; }
  }
  // refresh thickness options based on cleared selections
  updateAllFilterOptions();
}
  // Thickness depends on mat+color
  const col = colEl.value;
  if(!col){
    setOptionsNum(thkEl, [], 'Thickness');
    thkEl.disabled = true;
    FILTER_STATE[i].thk = '';
    saveFilters();
    return;
  }
  const thks = getThkOptions(mat, col);
  setOptionsNum(thkEl, thks, 'Thickness');
  thkEl.disabled = (thks.length===0);
  if(FILTER_STATE[i].thk && thks.map(String).includes(String(FILTER_STATE[i].thk))) thkEl.value = String(FILTER_STATE[i].thk);
  else { thkEl.value=''; FILTER_STATE[i].thk=''; }
  saveFilters();
}

// --- Clear Filter materials (3 rows) ---
function clearAllFilters(){
  // reset state
  FILTER_STATE = [
    {mat:'', col:'', thk:''},
    {mat:'', col:'', thk:''},
    {mat:'', col:'', thk:''},
  ];
  saveFilters();

  // reset UI selects + dependent options
  for(let i=0;i<3;i++){
    const matEl = document.getElementById('fMat'+(i+1));
    const colEl = document.getElementById('fCol'+(i+1));
    const thkEl = document.getElementById('fThk'+(i+1));
    if(matEl) matEl.value = '';
    if(colEl){
      colEl.innerHTML = '<option value="">Color</option>';
      colEl.disabled = true;
      colEl.value = '';
    }
    if(thkEl){
      thkEl.innerHTML = '<option value="">Thickness</option>';
      thkEl.disabled = true;
      thkEl.value = '';
    }
  }
}

function bindFilterUI(){
  loadFilters();
  const filtersClearBtn = document.getElementById('filtersClearBtn');
  if(filtersClearBtn){ filtersClearBtn.addEventListener('click', clearAllFilters); }

  // Hide/Show filter rows (remembered)
  const filtersHideBtn = document.getElementById('filtersHideBtn');
  const filtersRows = document.getElementById('filtersRows');
  const applyFiltersHidden = (hidden)=>{
    if(!filtersRows || !filtersHideBtn) return;
    filtersRows.style.display = hidden ? 'none' : '';
    filtersHideBtn.textContent = hidden ? 'Show' : 'Hide';
    localStorage.setItem('filtersHidden', hidden ? '1' : '0');
  };
  if(filtersHideBtn && filtersRows){
    const initiallyHidden = localStorage.getItem('filtersHidden') === '1';
    applyFiltersHidden(initiallyHidden);
    filtersHideBtn.addEventListener('click', ()=>{
      const nowHidden = filtersRows.style.display !== 'none';
      applyFiltersHidden(nowHidden);
    });
  }
  const mats = getAllMaterials();
  for(let i=0;i<3;i++){
    const matEl = document.getElementById('fMat'+(i+1));
    const colEl = document.getElementById('fCol'+(i+1));
    const thkEl = document.getElementById('fThk'+(i+1));
    // material options
    setOptions(matEl, mats, 'Material');
    matEl.value = FILTER_STATE[i].mat || '';
    // disable placeholders initially
    setOptions(colEl, [], 'Color');
    colEl.disabled = true;
    setOptionsNum(thkEl, [], 'Thickness');
    thkEl.disabled = true;

    matEl.addEventListener('change', ()=>{
      FILTER_STATE[i].col = '';
      FILTER_STATE[i].thk = '';
      updateFilterRow(i);
    });
    colEl.addEventListener('change', ()=>{
      FILTER_STATE[i].col = colEl.value;
      FILTER_STATE[i].thk = '';
      updateFilterRow(i);
    });
    thkEl.addEventListener('change', ()=>{
      FILTER_STATE[i].thk = thkEl.value;
      saveFilters();
    });

    // apply saved values
    updateFilterRow(i);
    // after update, set thickness if exists
    if(FILTER_STATE[i].thk) thkEl.value = String(FILTER_STATE[i].thk);
  }
}
function getFilterMap(){
  const map = new Map();
  FILTER_STATE.forEach(f=>{
    if(f.mat && f.col && f.thk){
      map.set((f.mat+'||'+f.col).toLowerCase(), Number(f.thk));
    }
  });
  return map;
}
function getStockOptions(material, color){
  const key = (material+'||'+color).toLowerCase();
  const map = getFilterMap();
  const forced = map.get(key);
  if(forced && Number.isFinite(forced)) return [forced];
  return getThkOptions(material, color);
}


function solveLaminationPlan(material, color, targetThkEff){
  const optsAll = getStockOptions(material, color).slice().sort((a,b)=>a-b);
  if(!optsAll.length || !Number.isFinite(targetThkEff)) return null;

  // Use 0.5mm resolution for DP (since shrinkage is 0.5)
  const SCALE = 2; // 0.5mm steps
  const optI = optsAll.map(v => Math.round(v*SCALE));
  const maxOpt = Math.max(...optI);
  const minCutI = Math.round(LAM_MIN_THK*SCALE);

  let best = null;

  for(let k=2; k<=MAX_LAYERS; k++){
    const sumCutI = Math.round((targetThkEff + (k-1)*LAM_SHRINK)*SCALE);

    // Feasibility lower bound
    if(sumCutI < k*minCutI) continue;

    const maxSumI = sumCutI + maxOpt; // enough to find minimal >= target
    // dp[count][sum] = prev_sum to reconstruct, and prev_choice thickness
    const dp = Array.from({length:k+1}, ()=> new Array(maxSumI+1).fill(-1));
    const choice = Array.from({length:k+1}, ()=> new Array(maxSumI+1).fill(-1));
    dp[0][0] = 0;

    for(let c=1; c<=k; c++){
      for(let s=0; s<=maxSumI; s++){
        if(dp[c-1][s] !== -1){
          for(const t of optI){
            const ns = s + t;
            if(ns<=maxSumI && dp[c][ns]===-1){
              dp[c][ns] = s;
              choice[c][ns] = t;
            }
          }
        }
      }
    }

    // find minimal reachable sum >= sumCutI
    let bestSumI = -1;
    for(let s=sumCutI; s<=maxSumI; s++){
      if(dp[k][s] !== -1){ bestSumI = s; break; }
    }
    if(bestSumI===-1) continue;

    const wasteI = bestSumI - sumCutI;
    const totalStockI = bestSumI;

    // Reconstruct stocks
    const stocksI = [];
    let cur = bestSumI;
    for(let c=k; c>=1; c--){
      const t = choice[c][cur];
      stocksI.push(t);
      cur = dp[c][cur];
    }
    stocksI.reverse();

    // Allocate cuts: start at stock, reduce (waste) while keeping >= minCut
    let remainingWasteI = wasteI;
    const cutsI = stocksI.slice();
    const layerWasteI = new Array(k).fill(0);

    // Reduce from layers with the biggest slack first
    const order = [...Array(k).keys()].sort((i,j)=> (stocksI[j]-minCutI) - (stocksI[i]-minCutI));
    for(const idxLayer of order){
      if(remainingWasteI<=0) break;
      const slack = cutsI[idxLayer] - minCutI;
      const take = Math.min(slack, remainingWasteI);
      cutsI[idxLayer] -= take;
      layerWasteI[idxLayer] += take;
      remainingWasteI -= take;
    }
    if(remainingWasteI>0) continue; // shouldn't happen

    const plan = {
      k,
      sumCut: sumCutI/SCALE,
      totalStock: totalStockI/SCALE,
      totalWaste: wasteI/SCALE,
      layers: stocksI.map((sI,i)=>({
        stock: sI/SCALE,
        cut: cutsI[i]/SCALE,
        waste: layerWasteI[i]/SCALE
      }))
    };

    // Select best: minimal totalStock, then fewer layers
    if(!best || plan.totalStock < best.totalStock - 1e-9 || (Math.abs(plan.totalStock-best.totalStock)<1e-9 && plan.k < best.k)){
      best = plan;
    }
  }

  return best;
}

function uniq(arr){
  return Array.from(new Set(arr.filter(Boolean).map(x=>String(x).trim()).filter(Boolean)));
}
function materialsList(){
  return uniq(MATERIALS_DB.map(r=>r.Material)).sort((a,b)=>a.localeCompare(b));
}
function colorsForMaterial(material){
  const m = String(material||"").trim().toLowerCase();
  if(!m) return [];
  const rows = MATERIALS_DB.filter(r => String(r.Material||"").trim().toLowerCase() === m);
  if(!rows.length) return [];
  const colors = rows
    .map(r => (r.Color||"").trim())
    .filter(Boolean);

  // If material exists in table but has no color defined -> treat as uncolored ("Std.")
  if(colors.length === 0) return ["Std."];

  return uniq(colors).sort((a,b)=>a.localeCompare(b));
}
function noteForMaterial(material){
  const m = String(material||"").trim().toLowerCase();
  if(!m) return "";
  const notes = MATERIALS_DB
    .filter(r => String(r.Material||"").trim().toLowerCase() === m)
    .map(r => (r.Note||"").trim())
    .filter(Boolean);
  const u = uniq(notes);
  return u.length ? u[0] : "";
}

const STORAGE_KEY = "mc_rebuilt_items";
function newRow(){ return { material:"", color:"", thk:"", psh:"", note:"", planStock:"" }; }
function newItem(){ return { itemNo:"", layer:1, rows:[newRow(), newRow(), newRow()] }; }

let items = load() || [newItem()];
// Auto-fill Item No on first load
try{ if(items && items[0] && !String(items[0].itemNo||"").trim()) items[0].itemNo="1"; }catch(e){}


// ------------------------------
// Program rows view: Full / Compact
// Compact mode collapses all positions except the last one.
let posViewMode = (localStorage.getItem('posViewMode') || 'full');
let posCompactExpandedIndex = null; // in compact: which position is expanded; null => last
try{
  const savedIdx = parseInt(localStorage.getItem('posCompactExpandedIndex')||'',10);
  if(Number.isFinite(savedIdx)) posCompactExpandedIndex = savedIdx;
}catch(e){}


function updatePosViewButtons(){
  const bFull = document.getElementById('posViewFull');
  const bComp = document.getElementById('posViewCompact');
  if (!bFull || !bComp) return;
  bFull.classList.toggle('active', posViewMode !== 'compact');
  bComp.classList.toggle('active', posViewMode === 'compact');
}

function applyPosView(){
  const cards = Array.from(document.querySelectorAll('#items .itemCard'));
  if (!cards.length) return;

  if (posViewMode !== 'compact'){
    cards.forEach(c => c.classList.remove('pos-collapsed'));
    return;
  }

  // In compact: accordion behavior. Only one expanded.
  let active = (Number.isInteger(posCompactExpandedIndex) ? posCompactExpandedIndex : (cards.length - 1));
  if (active < 0) active = 0;
  if (active > cards.length - 1) active = cards.length - 1;

  cards.forEach((c, i) => {
    if (i === active) c.classList.remove('pos-collapsed');
    else c.classList.add('pos-collapsed');
  });
}

function setPosViewMode(mode){
  posViewMode = (mode === 'compact') ? 'compact' : 'full';
  try{ localStorage.setItem('posViewMode', posViewMode); }catch(e){}
  if (posViewMode === 'compact'){
    // default expanded is last
    posCompactExpandedIndex = items.length ? (items.length - 1) : 0;
  }
  updatePosViewButtons();
  applyPosView();
}

document.addEventListener('DOMContentLoaded', () => {
  const bFull = document.getElementById('posViewFull');
  const bComp = document.getElementById('posViewCompact');
  if (bFull) bFull.addEventListener('click', () => setPosViewMode('full'));
  if (bComp) bComp.addEventListener('click', () => setPosViewMode('compact'));
  updatePosViewButtons();
  // apply after initial render() is called

  // Global "Out per plate" mode (Var or fixed number 1..9)
  window.globalPshMode = (localStorage.getItem('globalPshMode') || 'manual');
  window.globalPshFixed = (localStorage.getItem('globalPshFixed') || '');

  window.applyGlobalPshToDom = function(){
    const mode = (window.globalPshMode || 'manual');
    const fixed = String(window.globalPshFixed || '').trim();
    document.querySelectorAll('input[id^="psh_"]').forEach(inp => {
      if(!inp) return;
      if(mode === 'manual'){
        inp.disabled = false;
        inp.classList.remove('disabled');
        inp.removeAttribute('aria-disabled');
      } else {
        inp.value = fixed;
        // keep model in sync
        try{ syncPshById(inp.id, fixed); }catch(e){}
        inp.disabled = true;
        inp.classList.add('disabled');
        inp.setAttribute('aria-disabled','true');
      }
    });
  }

  const gSel = document.getElementById('globalPshMode');
  if(gSel){
    // init select value
    gSel.value = (window.globalPshMode === 'manual') ? 'manual' : String(window.globalPshFixed || 'manual');
    gSel.addEventListener('change', () => {
      const v = String(gSel.value || 'manual');
      if(v === 'manual'){
        window.globalPshMode = 'manual';
        window.globalPshFixed = '';
        localStorage.setItem('globalPshMode','manual');
        localStorage.setItem('globalPshFixed','');
      } else {
        window.globalPshMode = 'fixed';
        window.globalPshFixed = v;
        localStorage.setItem('globalPshMode','fixed');
        localStorage.setItem('globalPshFixed', v);
      }
      window.applyGlobalPshToDom();
    });
  }

});

// ===== Item No auto-fill: smallest free number =====
function _parseItemNoTokens(str){
  if(!str) return [];
  return String(str)
    .split(/[+,\s;]+/g)
    .map(s=>s.trim())
    .filter(Boolean)
    .map(s=>parseInt(s,10))
    .filter(n=>Number.isFinite(n) && n>0);
}
function getSmallestFreeItemNo(){
  const used = new Set();
  items.forEach(it=>{
    _parseItemNoTokens(it.itemNo).forEach(n=>used.add(n));
  });
  let n=1;
  while(used.has(n)) n++;
  return n;
}


function ensureItemNoFilled(){
  // Fill empty Item No fields in order, using the next free number.
  if(!Array.isArray(items)) return;
  for(let i=0;i<items.length;i++){
    if(!items[i]) continue;
    const val = String(items[i].itemNo||"").trim();
    if(!val){
      try{ items[i].itemNo = String(getSmallestFreeItemNo()); }catch(e){ items[i].itemNo = String(i+1); }
    }
  }
}

try{ ensureItemNoFilled(); }catch(e){}

// ================================================

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }
function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); }catch(e){ return null; } }

function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }



function updatePlanSelect(ii, ri){
  try{
    const r = items[ii].rows[ri];
    const sel = document.getElementById(`plan_${ii}_${ri}`);
    if(!sel) return;

    const material = (r.material||"").trim();
    const color = (r.color||"").trim();
    const target = n(r.thk);

    sel.innerHTML = "";
    sel.disabled = true;
    sel.style.display = "none";

    if(!material || !color || !Number.isFinite(target)) return;

    const optsAll = getStockOptions(material, color).slice().sort((a,b)=>a-b);
    if(!optsAll.length) return;

    // nominal = biggest <= target (if any)
    let nominal = NaN;
    for(const t of optsAll){
      if(t <= target + 1e-9) nominal = t;
    }
    if(!Number.isFinite(nominal)) nominal = optsAll[optsAll.length-1];

    // Only show when thicker-than-nominal scenario
    if(!(target > nominal + 1e-9)) return;

    const lamLayer = LAM_MIN_THK;
    const baseCut  = target - lamLayer + LAM_SHRINK;

    // Candidate stock sheets we can cut down to baseCut
    const candidates = optsAll.filter(t => t >= baseCut - 1e-9)
      .map(t => ({t, waste: t - baseCut}))
      .sort((a,b)=> a.waste - b.waste || a.t - b.t);

    if(!candidates.length) return;

    const autoStock = candidates[0].t;
    const current = n(r.planStock);
    const currentValid = Number.isFinite(current) && candidates.some(c=>Math.abs(c.t-current)<1e-6);

    sel.style.display = "block";
    sel.disabled = false;

    const optAuto = document.createElement("option");
    optAuto.value = "";
    optAuto.textContent = `Plan: Auto (use ${fmt(autoStock,1)} mm)`;
    sel.appendChild(optAuto);

    for(const c of candidates){
      const o = document.createElement("option");
      o.value = String(c.t);
      o.textContent = `Use ${fmt(c.t,1)} mm (waste ${fmt(c.waste,1)} mm)`;
      sel.appendChild(o);
    }

    if(currentValid){
      sel.value = String(current);
    }else{
      sel.value = "";
      r.planStock = "";
      save();
    }
  }catch(e){}
}

function updateThkDatalist(ii, ri){

  
try{
  const r = items[ii].rows[ri];
  const material = String(r.material||"").trim();
  const color = String(r.color||"").trim();
  const isNoppe = /noppe/i.test(material) || /\bmlf\b/i.test(material);

  const dl = document.getElementById(`thklist_${ii}_${ri}`);
  const thkEl = document.getElementById(`thk_${ii}_${ri}`);
  const thkSel = document.getElementById(`thkSel_${ii}_${ri}`);

  const optsRaw = getThkOptions(material, color);
  const opts = optsRaw.map(v=>String(v));
  const isNoppeMat = /noppe/i.test(material);
  const isMLFMat = /\bmlf\b/i.test(material);

  // --- NOPPE: force selection (no manual typing) ---
  if(isNoppe){
    if(thkEl) thkEl.style.display = "none";
    if(thkSel){
      thkSel.style.display = "";
      thkSel.innerHTML = ['<option value="" disabled>Select…</option>']
        .concat(optsRaw.map(v=>{
          const val = String(v);
          const label = (isNoppeMat && Number.isFinite(Number(v))) ? `${v} / ${Number(v)*2}` : val;
          return `<option value="${val}">${label}</option>`;
        }))
        .join("");
      thkSel.disabled = (opts.length === 0);

      // keep current if valid; otherwise clear (NO auto-pick for Noppe)
      // NOTE: during OCR import we must NOT wipe a valid imported thickness (e.g. 15/30 => thk=15).
      let cur = String(r.thk ?? thkSel.value ?? "").trim();

// Derive base thickness from either thkLabel ("15/30") OR cur itself if it contains a slash.
// iOS OCR sometimes puts the X/Y into the "thk" field (or uses a different spacing), so we normalize.
let baseFromLabel = "";
{
  const lbl = String(r.thkLabel || "").trim();
  let m = lbl.match(/^([0-9]+(?:\.[0-9]+)?)\s*\/\s*([0-9]+(?:\.[0-9]+)?)$/);
  if(m) baseFromLabel = String(m[1]).trim();
  if(!baseFromLabel){
    // also try from current value like "15/30" or "15 / 30"
    m = cur.match(/^([0-9]+(?:\.[0-9]+)?)\s*\/\s*([0-9]+(?:\.[0-9]+)?)$/);
    if(m) baseFromLabel = String(m[1]).trim();
  }
}

// Candidate strings we will try to match against option values
const candidates = [];
function pushCand(v){
  const s = String(v||"").trim();
  if(!s) return;
  if(!candidates.includes(s)) candidates.push(s);
}
pushCand(cur);
pushCand(baseFromLabel);
pushCand(r.thkLabel);
// common normalized forms for labels like "15/30" and "15 / 30"
if(r.thkLabel){
  pushCand(String(r.thkLabel).replace(/\s+/g,'').trim());         // "15/30"
  pushCand(String(r.thkLabel).replace(/\s*\/\s*/g,' / ').trim()); // "15 / 30"
}
if(cur){
  pushCand(cur.replace(/\s+/g,'').trim());
  pushCand(cur.replace(/\s*\/\s*/g,' / ').trim());
}

// During OCR import, if we have a base thickness (from X/Y), prefer it.
if(window.__ocrImporting && baseFromLabel){
  cur = baseFromLabel;
  pushCand(baseFromLabel);
}

const curNum = Number(String(cur).replace(",", "."));
const hasCurNum = Number.isFinite(curNum);

// check validity against options:
//  - exact string match (value)
//  - numeric match (15 == "15" or 15 == "15.0")
//  - label-style match ("15/30" -> base 15)
let matched = "";
for(const v of optsRaw){
  const vs = String(v).trim();
  if(!matched && candidates.includes(vs)){
    matched = vs;
    break;
  }
  if(!matched && hasCurNum){
    const vn = Number(String(v).replace(",", "."));
    if(Number.isFinite(vn) && Math.abs(vn - curNum) < 1e-6){
      matched = vs;
      break;
    }
  }
}
if(matched){
        thkSel.value = matched;
        r.thk = matched; // keep numeric base thickness as value
      }else{
        // If there is exactly one thickness option for Noppe, auto-select it.
        // If multiple options exist, keep it empty and force user to choose.
        if(opts.length===1){
          thkSel.value = opts[0];
          r.thk = opts[0];
        }else{
          thkSel.value = "";
          // During OCR import we don't force-wipe model unless it is invalid/empty.
          if(!window.__ocrImporting) r.thk = "";
        }
      }
    }
    if(dl) dl.innerHTML = ""; // not used for Noppe
    save();
    return;
  }

  // --- NORMAL: datalist input (manual typing allowed) ---
  if(thkSel) thkSel.style.display = "none";
  if(thkEl) thkEl.style.display = "";
  if(dl) dl.innerHTML = opts.map(v=>`<option value="${v}"></option>`).join("");

  // Optional: if thickness empty, suggest a nominal thickness (largest available)
  if(thkEl && !String(thkEl.value||"").trim() && opts.length){
    // do not force; just placeholder
    thkEl.placeholder = String(opts[opts.length-1]);
  }

}catch(e){}
}

function render(){

  const root = document.getElementById("items");
  if(!root) return;
  const mats = materialsList();
  root.innerHTML = items.map((it, ii) => itemHtml(it, ii, mats)).join("");

  // UI index (not Item No.)
  document.querySelectorAll(".itemIndex").forEach((el, idx) => {
    el.textContent = String(idx + 1);

    // Tap to expand in Compact (ignore click right after drag)
    el.style.cursor = 'pointer';
    el.addEventListener('click', (ev) => {
      if (window.__dragJustHappened) { window.__dragJustHappened = false; return; }
      if (posViewMode !== 'compact') return;
      try{ ev.preventDefault(); ev.stopPropagation(); }catch(e){}
      const card = ev.currentTarget && ev.currentTarget.closest ? ev.currentTarget.closest('.itemCard') : null;
      const cards = Array.from(document.querySelectorAll('#items .itemCard'));
      const newIdx = card ? cards.indexOf(card) : idx;
      if (newIdx < 0) return;
      posCompactExpandedIndex = newIdx;
      try{ localStorage.setItem('posCompactExpandedIndex', String(newIdx)); }catch(e){}
      applyPosView();
    });

    // Long-press to reorder (Full + Compact). Item No is NOT changed (Variant A).
    try{ setupReorderHandle(el); }catch(e){}
  });

  // Sync fields
  items.forEach((it, ii) => it.rows.slice(0,(it.layer||1)).forEach((r, ri) => {
    const msel = document.getElementById(`mat_${ii}_${ri}`);
    const csel = document.getElementById(`col_${ii}_${ri}`);
    const thk  = document.getElementById(`thk_${ii}_${ri}`);
    const psh  = document.getElementById(`psh_${ii}_${ri}`);
    if(msel) msel.value = r.material || "";
    if(thk)  thk.value  = r.thk || "";
    if(psh)  psh.value  = r.psh || "";
    applyColor(ii, ri);
    try{ updateThkDatalist(ii, ri); updatePlanSelect(ii, ri); }catch(_){ }
    if(csel) csel.value = items[ii].rows[ri].color || "";
  }));

  // Apply program rows view (Full / Compact)
  try {
    if (typeof window.applyPosView === 'function') window.applyPosView();
    applyProgramView();
  } catch (e) {
  try{ if (typeof applyGlobalPshToDom === 'function') window.applyGlobalPshToDom(); }catch(e){}
}
}

function itemHtml(it, ii, mats){
  const itemNoEsc = esc(it.itemNo);
  return `
  <div class="card itemCard">
    <div class="itemHead">
  <div class="itemIndex"></div><span class="prItemLabel">Item</span>
      <div class="itemNo">
                <input data-item-index="${ii}" class="itemNoInput" type="text" inputmode="none" placeholder="Item No." value="${itemNoEsc}"
          readonly tabindex="-1" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" aria-readonly="true"/><span class="itemLock">🔒</span>

      </div>
      <div class="layerBox">
        <div class="filter-wrap"><select class="layerSel filter-select" onchange="setLayer(${ii}, this.value)">
          <option value="1" ${it.layer==1?"selected":""}>1 layer</option>
          <option value="2" ${it.layer==2?"selected":""}>2 layers</option>
          <option value="3" ${it.layer==3?"selected":""}>3 layers</option>
        </select></div>
      </div>
<button class="btn danger" onclick="deleteItem(${ii})">Delete</button>
    </div>

    <div class="tableWrap">
      <div class="gridHeader">
          <div>Material</div>
          <div>Color</div>
          <div>Thickness</div>
          <div>Out per plate</div>
</div>
        <div>
          ${it.rows.slice(0, (it.layer||1)).map((r, ri) => rowHtml(ii, ri, mats)).join("")}
        </div>
    </div>
  </div>`;
}

function rowHtml(ii, ri, mats){
  const matOptions = ['<option value="" disabled selected>Select…</option>']
    .concat(mats.map(m => `<option value="${esc(m)}">${esc(m)}</option>`))
    .join("");
  return `
  <div class="gridRow">
    <div class="filter-wrap"><select class="field filter-select" id="mat_${ii}_${ri}"
      onchange="onMaterialChange(${ii},${ri}, this.value)">
      ${matOptions}
    </select></div>

    <div class="filter-wrap"><select class="field filter-select" id="col_${ii}_${ri}"
      onchange="onColorChange(${ii},${ri}, this.value)">
      <option value="" disabled selected>Select…</option>
    </select></div>

    <div class="thkWrap" id="thkWrap_${ii}_${ri}">
      <input class="field small" id="thk_${ii}_${ri}" type="text" list="thklist_${ii}_${ri}" placeholder="Thk"
        inputmode="decimal" lang="ru" pattern="[0-9]*[.,]?[0-9]*"
        oninput="items[${ii}].rows[${ri}].thk=this.value; save(); updatePlanSelect(${ii},${ri});"/>
      <datalist id="thklist_${ii}_${ri}"></datalist>

      <select class="field small thkSelect" id="thkSel_${ii}_${ri}" style="display:none"
        onchange="items[${ii}].rows[${ri}].thk=this.value; save(); updatePlanSelect(${ii},${ri});">
        <option value="" disabled selected>Select…</option>
      </select>
    </div>
    <select id="plan_${ii}_${ri}" class="planSelect" style="display:none" onchange="items[${ii}].rows[${ri}].planStock=this.value; save();"></select>

    <div class="pshWrap">
      <input class="field small" id="psh_${ii}_${ri}" type="text" placeholder="Qty"
        inputmode="numeric"
        oninput="syncPshById(this.id, this.value)"/>
      <span class="pshLock" aria-hidden="true">🔒</span>
    </div>
</div>`;
}


function setLayer(ii, val){
  const newLayer = Math.min(3, Math.max(1, parseInt(val || 1, 10) || 1));
  const oldLayer = items[ii].layer || 1;
  if(newLayer < oldLayer){
    for(let ri=newLayer; ri<3; ri++){
      items[ii].rows[ri] = newRow(); // clear hidden rows
    }
  }
  items[ii].layer = newLayer;  
  // Smart fill ONLY when enabling layers: copy Out per plate from layer 1 into new layer(s) if empty
  if(newLayer > oldLayer){
    var srcPsh = "";
    if(items[ii] && items[ii].rows && items[ii].rows[0] && items[ii].rows[0].psh != null){
      srcPsh = String(items[ii].rows[0].psh);
    }
    if(srcPsh.trim() !== ""){
      for(var ri=oldLayer; ri<newLayer && ri<3; ri++){
        if(!items[ii].rows[ri]) items[ii].rows[ri] = newRow();
        var cur = items[ii].rows[ri].psh;
        if(cur == null || String(cur).trim() === ""){
          items[ii].rows[ri].psh = srcPsh;
        }
      }
    }
  }

  save();
  render();
}


function isNoppeMaterial(material){
  const s = String(material||"");
  return /noppe/i.test(s) || /mlf/i.test(s);
}
function sortedThkOptions(material, color){
  const opts = getThkOptions(material||"", color||"") || [];
  return opts.slice().sort((a,b)=>a-b);
}

/*
  Thickness behavior rules (confirmed):
  - If Material contains "Noppe": when Material or Color changes -> clear Thickness, user must choose (no auto-fill).
  - For all other materials: if current Thickness becomes invalid -> auto-set the first available option (no errors/empty).
*/
function enforceThicknessRules(ii, ri, reason){
  try{
    const r = items[ii].rows[ri];
    const mat = (r.material||"");
    const col = (r.color||"");
    const thkEl = document.getElementById(`thk_${ii}_${ri}`);
    const opts = sortedThkOptions(mat, col);

    if(!thkEl) return;

    if(isNoppeMaterial(mat)){
      thkEl.placeholder = "Select…";

      // OCR import override: if an imported thickness is already set, keep it
      // (do NOT force-clear on material/color change) as long as it is valid.
      // This is needed because Noppe normally forces manual thickness selection,
      // but OCR import already knows the thickness (e.g. 15/30 => thk=15).
      try{
        if(window.__ocrImporting && (reason === "material" || reason === "color")){
          const curStr2 = String((r.thk != null ? r.thk : thkEl.value) || "").trim();
          if(curStr2){
            const curNum2 = parseFloat(curStr2.replace(",", "."));
            const curValid2 = Number.isFinite(curNum2) && opts.some(v => Math.abs(v - curNum2) < 1e-6);
            if(curValid2){
              r.thk = String(curNum2 % 1 === 0 ? Math.round(curNum2) : curNum2);
              thkEl.value = r.thk;
              save();
              thkEl.classList.remove("invalid");
              return;
            }
          }
          // If imported thickness is missing or invalid, fall through to default Noppe behavior.
        }
      }catch(_){ }

      // If no options, just clear
      if(!opts.length){
        if(String(r.thk||"").trim() !== "" || String(thkEl.value||"").trim() !== ""){
          r.thk = "";
          thkEl.value = "";
          save();
        } else {
          thkEl.value = "";
        }
        thkEl.classList.remove("invalid");
        return;
      }

      // NEW: if only ONE thickness exists (e.g. PU23 Noppe White -> 10/20),
      // auto-select it to avoid unnecessary extra tap.
      if(opts.length === 1){
        const only = opts[0];
        r.thk = String(only);
        thkEl.value = String(only);
        save();
        // Let existing listeners update UI/reports
        thkEl.dispatchEvent(new Event('change', { bubbles: true }));
        thkEl.classList.remove("invalid");
        return;
      }

      // Default Noppe behavior: clear on material/color change (force user to select)
      if(reason === "material" || reason === "color"){
        if(String(r.thk||"").trim() !== "" || String(thkEl.value||"").trim() !== ""){
          r.thk = "";
          thkEl.value = "";
          save();
        } else {
          thkEl.value = "";
        }
      } else {
        // other reasons (init): keep current
      }

      thkEl.classList.remove("invalid");
      return;
    }

    if(!opts.length) return;

    const curStr = String((r.thk!=null ? r.thk : thkEl.value) || "").trim();
    const curNum = parseFloat(curStr.replace(",", "."));
    const curValid = curStr !== "" && Number.isFinite(curNum) && opts.some(v => Math.abs(v - curNum) < 1e-6);

    if(!curValid){
      // For non-Noppe materials: NO auto-fill. If current thickness becomes invalid, clear it.
      r.thk = "";
      thkEl.value = "";
      thkEl.placeholder = "Select…";
      save();
      try{ updatePlanSelect(ii, ri); }catch(_){}
    }
  }catch(e){}
}

function onColorChange(ii, ri, color){
  // RULE: Color is tied to Material. Always sync both MODEL and UI select.
  const wantRaw = (color == null ? "" : String(color)).trim();
  const wantLow = wantRaw.toLowerCase();

  // Ensure options exist for current material (they are built in applyColor called from onMaterialChange,
  // but OCR import may call onColorChange directly).
  try{ applyColor(ii, ri); }catch(_){}

  const csel = document.getElementById(`col_${ii}_${ri}`);
  if(csel){
    if(!wantRaw){
      // keep empty (unless applyColor auto-filled single color)
      // sync model from UI (so single-color auto-fill works)
      items[ii].rows[ri].color = (csel.value || "").trim();
    }else{
      // case-insensitive match against existing options
      const opts = Array.prototype.slice.call(csel.options || []);
      const found = opts.find(o => String(o.value||"").trim().toLowerCase() === wantLow);
      if(found){
        csel.value = found.value;
        items[ii].rows[ri].color = found.value;
      }else{
        // invalid color for this material -> clear
        csel.value = "";
        items[ii].rows[ri].color = "";
      }
    }
  }else{
    // no select in DOM (shouldn't happen) -> just store
    items[ii].rows[ri].color = wantRaw;
  }

  save();
  try{ updateThkDatalist(ii, ri); }catch(_){}
  enforceThicknessRules(ii, ri, "color");
  try{ updatePlanSelect(ii, ri); }catch(_){}
}

function onMaterialChange(ii, ri, material){
  items[ii].rows[ri].material = material || "";
  items[ii].rows[ri].color = "";
  items[ii].rows[ri].note = noteForMaterial(material);
  save();

  // Color may auto-fill/lock (1 option). Thickness rules depend on final (material+color).
  applyColor(ii, ri);
  try{ updateThkDatalist(ii, ri); }catch(_){ }
  enforceThicknessRules(ii, ri, "material");
  try{ updatePlanSelect(ii, ri); }catch(_){ }
}

function applyColor(ii, ri){
  const material = (items[ii].rows[ri].material || "").trim();
  const colors = colorsForMaterial(material);
  const csel = document.getElementById(`col_${ii}_${ri}`);
  if(!csel) return;

  // Build options
  csel.innerHTML = [`<option value="" disabled ${!items[ii].rows[ri].color ? "selected":""}>Select…</option>`]
    .concat(colors.map(c => `<option value="${esc(c)}">${esc(c)}</option>`))
    .join("");

  // No colors available -> disable, keep empty
  if(colors.length === 0){
    csel.value = "";
    items[ii].rows[ri].color = "";
    csel.disabled = true;
    save();
    try{ updateThkDatalist(ii, ri); updatePlanSelect(ii, ri); }catch(_){ }
    return;
  }

  // Exactly one possible color -> auto-fill if empty or invalid, and lock (disabled)
  if(colors.length === 1){
    const only = colors[0];
    const cur = (items[ii].rows[ri].color || "").trim();
    if(!cur || cur.toLowerCase() !== only.toLowerCase()){
      items[ii].rows[ri].color = only;
      csel.value = only;
      save();
    }else{
      csel.value = only;
    }
    csel.disabled = true;
    try{ updateThkDatalist(ii, ri); updatePlanSelect(ii, ri); }catch(_){ }
    return;
  }

  // Multiple colors -> user must choose
  csel.disabled = false;

  const cur = (items[ii].rows[ri].color || "").trim().toLowerCase();
  if(cur){
    const found = colors.find(c=>c.toLowerCase()===cur);
    if(found){
      csel.value = found;
    }else{
      csel.value = "";
      items[ii].rows[ri].color = "";
      save();
    }
  }

  try{ updateThkDatalist(ii, ri); updatePlanSelect(ii, ri); }catch(_){ }
}

function addItem(){
  // Add Position: clone previous program's layers + material/color ONLY
  if(items.length){
    const last = items[items.length-1];
    const layer = Math.min(3, Math.max(1, parseInt(last.layer||1,10)||1));
    const ni = { itemNo:String(getSmallestFreeItemNo()), layer: layer, rows:[newRow(), newRow(), newRow()] };

    for(let ri=0; ri<layer; ri++){
      const r = (last.rows && last.rows[ri]) ? last.rows[ri] : {};
      // Clone material + color (color may be auto-selected and not yet stored -> read from DOM as fallback)
      const lastIndex = items.length - 1;
      let mat = r.material || "";
      let col = r.color || "";
      const msel = document.getElementById("mat_" + lastIndex + "_" + ri);
      const csel = document.getElementById("col_" + lastIndex + "_" + ri);
      if(!mat && msel) mat = msel.value || "";
      if(!col && csel) col = csel.value || "";
      ni.rows[ri].material = mat;
      ni.rows[ri].color    = col;
      ni.rows[ri].thk      = ""; // do NOT copy
      ni.rows[ri].psh      = ""; // do NOT copy
      ni.rows[ri].planStock = ""; // do NOT copy
    }

    items.push(ni);
  }else{
    const ni = newItem();
    try{ ni.itemNo = String(getSmallestFreeItemNo()); }catch(e){ ni.itemNo = ni.itemNo || "1"; }
    items.push(ni);
  }

  // Ensure all blank Item No get filled (e.g., after load or import)
  try{ ensureItemNoFilled(); }catch(e){}

  save();
  render();
  if (posViewMode === 'compact') { posCompactExpandedIndex = items.length-1; try{localStorage.setItem('posCompactExpandedIndex', String(posCompactExpandedIndex));}catch(e){}; applyPosView(); }
  if (programViewMode === 'compact') { programCompactExpandedIndex = null; applyProgramView(); }

  // Apply color rules for cloned materials
  const ii = items.length-1;
  const layer = Math.min(3, Math.max(1, parseInt(items[ii].layer||1,10)||1));
  for(let ri=0; ri<layer; ri++){
    const desiredMat = (items[ii].rows[ri].material || "");
    const desiredCol = (items[ii].rows[ri].color || "");

    const matSel = document.getElementById(`mat_${ii}_${ri}`);
    if(matSel){
      // 1) set material and let the existing on-change logic rebuild Color options / auto-color rules
      matSel.value = desiredMat;
      matSel.dispatchEvent(new Event('change', {bubbles:true}));

      // 2) after options are rebuilt, re-apply the copied color (if it exists in options)
      //    If the material has a single fixed color, the auto-rule will win and keep the field locked.
      (function(iIndex, rIndex, wantCol){
        setTimeout(function(){
          const csel = document.getElementById(`col_${iIndex}_${rIndex}`);
          if(!csel) return;
          if(!wantCol) {
            // nothing to force; keep whatever auto-selection did
            items[iIndex].rows[rIndex].color = csel.value || "";
            save();
            return;
          }
          // try set only if option exists
          const opt = Array.prototype.slice.call(csel.options || []).some(function(o){ return (o.value||"").toLowerCase() === wantCol.toLowerCase(); });
          if(opt){
            csel.value = wantCol;
            // keep model in sync
            items[iIndex].rows[rIndex].color = csel.value || "";
            try{ csel.dispatchEvent(new Event('change', {bubbles:true})); }catch(_){ }
            save();
          }else{
            // fallback to whatever UI settled on
            items[iIndex].rows[rIndex].color = csel.value || "";
            save();
          }
        }, 0);
      })(ii, ri, desiredCol);
    }
  }
}
function deleteItem(i){ items.splice(i,1); if(items.length===0) items=[newItem()]; save(); render(); if (posViewMode === 'compact') { posCompactExpandedIndex = Math.max(0, items.length-1); try{localStorage.setItem('posCompactExpandedIndex', String(posCompactExpandedIndex));}catch(e){}; applyPosView(); } if (programViewMode === 'compact') { programCompactExpandedIndex = null; applyProgramView(); } }
function resetAll(){ if(!confirm("Reset all items?")) return; items=[newItem()]; save(); render(); }

function exportCSV(){
  const lines = [];
  const orderVal = (typeof getOrderValue === "function") ? getOrderValue() : "";
  const qtyVal   = (typeof getQtyTotal === "function") ? getQtyTotal() : "";
  if(orderVal){ lines.push(["Order #", csv(orderVal)].join(",")); }
  if(qtyVal){   lines.push(["Qty, set (total)", csv(qtyVal)].join(",")); }
  if(orderVal || qtyVal){ lines.push(""); }
  lines.push(["Item No","Layer","Material","Color","Thk","P/Sh","Note"].join(","));

  items.forEach(it => {
    it.rows.forEach((r, idx) => {
      lines.push([
        csv(it.itemNo),
        csv(String(idx+1)),
        csv(r.material),
        csv(r.color),
        csv(r.thk),
        csv(r.psh),
        csv(r.note)
      ].join(","));
    });
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "material_counter.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function csv(v){
  const s = String(v??"");
  if(/[",\n]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
  return s;
}


// --- Meta: Order # (main + sub) + Qty, set (total) ---
const orderMainEl = document.getElementById("orderMain");
const orderSubEl  = document.getElementById("orderSub");
const orderDashEl = document.getElementById("orderDash");
const qtyTotalEl  = document.getElementById("qtyTotal");

const orderRowEl  = document.getElementById("orderRow");

function isOrderEmpty(){
  const a = String(orderMainEl?.value||"").trim();
  const b = String(orderSubEl?.value||"").trim();
  return (!a && !b);
}
function applyOrderInactiveState(){
  const empty = isOrderEmpty();
  if(orderDashEl){
    // hide dash when both empty
    orderDashEl.style.display = empty ? "none" : "";
  }else{
    // fallback: dash span by class
    const dash = document.querySelector("#orderRow .metaDash");
    if(dash) dash.style.display = empty ? "none" : "";
  }
  // make inputs look inactive when empty, but still allow tap to activate
  [orderMainEl, orderSubEl].forEach(el=>{
    if(!el) return;
    if(empty){
      el.classList.add("orderInactive");
      el.readOnly = true; // prevents accidental keyboard popups
    }else{
      el.classList.remove("orderInactive");
      el.readOnly = false;
    }
  });
}

function activateOrderField(el){
  if(!el) return;
  // enable editing
  el.readOnly = false;
  el.classList.remove("orderInactive");
  // show dash if any content exists or user starts editing
  if(orderDashEl) orderDashEl.style.display = "";
  const dash = document.querySelector("#orderRow .metaDash");
  if(dash) dash.style.display = "";
  // focus
  setTimeout(()=>{ try{ el.focus(); }catch(e){} }, 0);
}

// Tap label to activate both fields
const orderLabelEl = document.querySelector("#orderRow .meta-label");
if(orderLabelEl){
  orderLabelEl.style.cursor = "pointer";
  orderLabelEl.addEventListener("click", ()=>{ activateOrderField(orderMainEl); });
  orderLabelEl.addEventListener("touchstart", (e)=>{ e.preventDefault(); activateOrderField(orderMainEl); }, {passive:false});
}

// Tap on readOnly input activates it
[orderMainEl, orderSubEl].forEach(el=>{
  if(!el) return;
  el.addEventListener("pointerdown", (e)=>{
    if(el.readOnly){
      e.preventDefault();
      e.stopPropagation();
      activateOrderField(el);
    }
  }, {passive:false});
  el.addEventListener("touchstart", (e)=>{
    if(el.readOnly){
      e.preventDefault();
      e.stopPropagation();
      activateOrderField(el);
    }
  }, {passive:false});
  el.addEventListener("input", ()=>{ applyOrderInactiveState(); });
});

applyOrderInactiveState();


function onlyDigits(el){
  if(!el) return;
  const old = String(el.value || "");
  // Keep caret position while stripping non-digits (iOS friendly)
  const start = el.selectionStart;
  const endPos = el.selectionEnd;
  const digits = old.replace(/\D+/g, "");
  if(old === digits) return;
  // Count removed chars before caret
  let removedBefore = 0;
  for(let i=0, j=0; i<old.length && j<(start||0); i++, j++){
    if(!/\d/.test(old[i])) removedBefore++;
  }
  el.value = digits;
  // Restore caret roughly
  const newCaret = Math.max(0, (start||0) - removedBefore);
  try{ el.setSelectionRange(newCaret, newCaret); }catch(_){ }
}

function getOrderValue(){
  const main = (orderMainEl?.value || "").trim();
  const sub  = (orderSubEl?.value || "").trim();
  if (!main) return "";
  return sub ? `${main}-${sub}` : main;
}

function getQtyTotal(){
  return (qtyTotalEl?.value || "").trim();
}

function updateOrderDash(){
  if (!orderDashEl) return;
  const main = (orderMainEl?.value || "").trim();
  const sub  = (orderSubEl?.value  || "").trim();
  // Show dash only when BOTH main and sub exist.
  orderDashEl.style.opacity = (main && sub) ? "1" : "0";
  // Safety: if main is empty, clear sub as well.
  if(!main && sub){
    if(orderSubEl) orderSubEl.value = "";
  }
}

function saveMeta(){
  try{
    localStorage.setItem("mc_order_main", orderMainEl?.value || "");
    localStorage.setItem("mc_order_sub",  orderSubEl?.value  || "");
    localStorage.setItem("mc_qty_total",  qtyTotalEl?.value  || "");
  }catch(_){}
}

function loadMeta(){
  try{
    if(orderMainEl) orderMainEl.value = localStorage.getItem("mc_order_main") || "";
    if(orderSubEl)  orderSubEl.value  = localStorage.getItem("mc_order_sub")  || "";
    if(qtyTotalEl)  qtyTotalEl.value  = localStorage.getItem("mc_qty_total")  || "";
  }catch(_){}
  updateOrderDash();
}

loadMeta();

// Tap labels to quickly clear fields (mobile friendly)
const orderTapEl = document.getElementById('orderTap');
const qtyTapEl = document.getElementById('qtyTap');

function clearOrderRow(){
  if(orderMainEl) orderMainEl.value = '';
  if(orderSubEl)  orderSubEl.value  = '';
  updateOrderDash();
  saveMeta();
  try{ orderMainEl?.focus(); }catch(_){ }
}

function clearQtyRow(){
  if(qtyTotalEl) qtyTotalEl.value = '';
  saveMeta();
  try{ qtyTotalEl?.focus(); }catch(_){ }
}

if(orderTapEl) orderTapEl.addEventListener('click', clearOrderRow);
if(qtyTapEl) qtyTapEl.addEventListener('click', clearQtyRow);

if(orderMainEl){
  orderMainEl.addEventListener("input", () => { onlyDigits(orderMainEl); updateOrderDash(); saveMeta(); });
  // iOS Safari sometimes misses 'input' when using numeric keyboard/autofill.
  // Add extra events to keep dash in sync.
  orderMainEl.addEventListener("change", () => { updateOrderDash(); saveMeta(); });
  orderMainEl.addEventListener("keyup",  () => { updateOrderDash(); });

  orderMainEl.addEventListener("blur", () => {
    const main = (orderMainEl.value || "").trim();
    if(!main){
      if(orderSubEl) orderSubEl.value = "";
    }
    updateOrderDash();
    setTimeout(updateOrderDash, 0);
    saveMeta();
  });
}
if(orderSubEl){
  orderSubEl.addEventListener("input", () => { onlyDigits(orderSubEl); updateOrderDash(); saveMeta(); });
  orderSubEl.addEventListener("change", () => { updateOrderDash(); saveMeta(); });
  orderSubEl.addEventListener("keyup",  () => { updateOrderDash(); });

  orderSubEl.addEventListener("blur", () => {
    const main = (orderMainEl?.value || "").trim();
    if(!main){
      if(orderSubEl) orderSubEl.value = "";
    }
    updateOrderDash();
    setTimeout(updateOrderDash, 0);
    saveMeta();
  });
}
if(qtyTotalEl){
  qtyTotalEl.addEventListener("input", () => { onlyDigits(qtyTotalEl); saveMeta(); });
}



render();


// Disable context menu (iOS callout) on row fields
document.addEventListener('contextmenu', (e)=>{
  const t = e.target;
  if(t && t.matches && t.matches('[data-clear-scope]')){ e.preventDefault(); }
});

// --- Long-press to clear field and everything to the right (mobile-friendly) ---
const LONG_PRESS_MS = 550;

function attachLongPressClear(root=document){
  const targets = root.querySelectorAll('[data-clear-scope]');
  targets.forEach(el=>{
    if(el._lpBound) return;
    el._lpBound = true;

    let timer = null;
    let moved = false;

    const start = (e)=>{
      moved = false;
      // avoid triggering native select on long press for selects
      timer = setTimeout(()=>{
        timer = null;
        clearRightFrom(el);
        // small haptic-like feedback (visual)
        el.classList.add('flashClear');
        setTimeout(()=>el.classList.remove('flashClear'), 180);
      }, LONG_PRESS_MS);
    };

    const cancel = ()=>{
      if(timer){ clearTimeout(timer); timer = null; }
    };

    const move = ()=>{ moved = true; cancel(); };

    el.addEventListener('touchstart', (e)=>{ try{ e.preventDefault(); }catch(_){} start(e); }, {passive:false});
    el.addEventListener('touchend', cancel);
    el.addEventListener('touchcancel', cancel);
    el.addEventListener('touchmove', move, {passive:true});

    el.addEventListener('mousedown', start);
    el.addEventListener('mouseup', cancel);
    el.addEventListener('mouseleave', cancel);
    el.addEventListener('mousemove', move);
  });
}

function clearRightFrom(el){
  const rowEl = el.closest('.row');
  if(!rowEl) return;

  const scope = el.getAttribute('data-clear-scope'); // material|color|thk|qty
  const order = ['material','color','thk','qty'];
  const startIdx = order.indexOf(scope);
  if(startIdx === -1) return;

  for(let i=startIdx;i<order.length;i++){
    const key = order[i];
    const field = rowEl.querySelector(`[data-field="${key}"]`);
    if(!field) continue;

    // Clear value
    if(field.tagName === 'SELECT'){
      field.selectedIndex = 0; // placeholder
    } else {
      field.value = '';
    }

    // Trigger any dependent logic if material cleared (to reset color etc.)
    if(key === 'material'){
      field.dispatchEvent(new Event('change', {bubbles:true}));
    } else {
      field.dispatchEvent(new Event('input', {bubbles:true}));
      field.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }
}


// bind long-press after each render
const _origRender = render;
render = function(){ _origRender(); attachLongPressClear(document); };


// Sync P/Sh (Qty) across all layers within the same Program (item).

// Keep P/Sh independent per layer (no auto-copy across layers).
// Called from each row's P/Sh input: syncPsh(ii, ri, value)

// === Robust P/Sh handler: uses input id="psh_{ii}_{ri}" to update correct layer ===

function syncPshById(id, value){
  try{
    if(!id) return;
    var mm = String(id).match(/^psh_(\d+)_(\d+)$/);
    if(!mm) return;
    var ii = parseInt(mm[1],10);
    var ri = parseInt(mm[2],10);
    if(isNaN(ii) || isNaN(ri)) return;
    if(!items[ii]) return;
    if(!items[ii].rows) items[ii].rows = [];

    // Sync rule: all VISIBLE layers share the same Out per plate
    var layerCount = items[ii].layer || 1;
    if(layerCount < 1) layerCount = 1;
    if(layerCount > 3) layerCount = 3;

    for(var r=0; r<layerCount; r++){
      if(!items[ii].rows[r]) items[ii].rows[r] = newRow();
      items[ii].rows[r].psh = value;

      // Update UI for other visible fields without triggering loops
      var el = document.getElementById('psh_' + ii + '_' + r);
      if(el && el.value !== String(value)){
        el.value = value;
      }
    }

    save();
  }catch(e){}
}


// Backward compat: if something still calls syncPsh(ii, value) it will write to layer 0 only.
function syncPsh(ii, value){
  if(!items[ii]) return;
  if(!items[ii].rows) items[ii].rows = [];
  if(!items[ii].rows[0]) items[ii].rows[0] = newRow();
  items[ii].rows[0].psh = value;
  save();
}




// ===== Item No picker (1..15) =====
// Rules:
//  - Item No is UNIQUE across areas (cannot be used in another area)
//  - Hide/Unhide is UX-only: hides unused numbers from the picker
//  - Used numbers cannot be hidden (to avoid invisible used numbers)

let __itemNoPickerItemIndex = null;
let __itemNoSelected = new Set();      // selected in CURRENT area (multi-select supported)
let __itemNoUsed = new Set();          // used by OTHER areas (uniqueness)
let __itemNoHideMode = false;          // when true: tap numbers to hide/unhide
const __HIDDEN_KEY = "mc_hidden_itemnos_v1";
let __itemNoHidden = loadHiddenItemNos(); // UX filter, global for this page/order

function loadHiddenItemNos(){
  try{
    const arr = JSON.parse(localStorage.getItem(__HIDDEN_KEY) || "[]");
    if(Array.isArray(arr)) return new Set(arr.map(x=>String(parseInt(x,10))).filter(x=>/^(?:[1-9]|1[0-5])$/.test(x)));
  }catch(e){}
  return new Set();
}
function saveHiddenItemNos(){
  try{
    const arr = Array.from(__itemNoHidden).map(x=>parseInt(x,10)).filter(n=>Number.isFinite(n)).sort((a,b)=>a-b);
    localStorage.setItem(__HIDDEN_KEY, JSON.stringify(arr));
  }catch(e){}
}

function __parseItemNo(str){
  if(!str) return [];
  return String(str).split('+').map(s=>s.trim()).filter(Boolean);
}
function __formatItemNo(arr){
  return arr.join('+');
}
function __computeUsedItemNos(exceptIndex){
  const used = new Set();
  items.forEach((it, ii)=>{
    if(ii === exceptIndex) return;
    __parseItemNo(it?.itemNo).forEach(x=>{
      const n = parseInt(String(x),10);
      if(Number.isFinite(n) && n>=1 && n<=15) used.add(String(n));
    });
  });
  return used;
}
function __sortedSelected(){
  return Array.from(__itemNoSelected)
    .map(x=>parseInt(x,10))
    .filter(n=>Number.isFinite(n) && n>=1 && n<=15)
    .sort((a,b)=>a-b)
    .map(String);
}

function __updatePickerPreview(){
  const prev = document.getElementById('itemNoPreview');
  if(!prev) return;
  const arr = __sortedSelected().join('+');
  prev.textContent = arr || '—';
}

function __updatePickerTitle(){
  const t = document.getElementById('itemNoPickerTitle');
  if(!t) return;
  t.textContent = __itemNoHideMode ? "Hide mode: tap numbers to hide/unhide" : "Select Item No.";
}

function renderItemNoGrid(){
  const grid = document.getElementById('itemNoPickerGrid');
  if(!grid) return;
  grid.innerHTML = '';

  for(let n=1; n<=15; n++){
    const key = String(n);
    const isHidden = __itemNoHidden.has(key);

    // Normal mode: hide hidden numbers from the list
    const usedElsewhere = __itemNoUsed.has(key);

    // Normal mode: hide hidden numbers UNLESS they are used (must stay visible)
    if(!__itemNoHideMode && isHidden && !usedElsewhere && !__itemNoSelected.has(key)) continue;



    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'itemNoBtn';
    b.textContent = key;
    b.setAttribute('data-n', key);

    // Visual flags
    if(__itemNoSelected.has(key)) b.classList.add('on');
    if(isHidden) b.classList.add('hidden');

    // Uniqueness: disable numbers used elsewhere (unless already selected in this area -> conflict)
    if(usedElsewhere && !__itemNoSelected.has(key)){
      b.disabled = true;
      b.classList.add('disabled');
      b.setAttribute('aria-disabled','true');
      b.title = 'Already used in another area';
    } else if(usedElsewhere && __itemNoSelected.has(key)){
      // Data inconsistency (duplicate in storage) — allow deselect only
      b.classList.add('conflict');
      b.title = 'Conflict: used in another area. Deselect to resolve.';
    }

    // Hide-mode rules: cannot hide numbers used elsewhere
    if(__itemNoHideMode){
      if(usedElsewhere && !__itemNoSelected.has(key)){
        // still show, but keep disabled (cannot change hidden state)
        b.title = 'Used in another area — cannot hide/unhide here';
      }else{
        b.title = isHidden ? 'Tap to unhide' : 'Tap to hide';
      }
    }

    grid.appendChild(b);
  }

  __updatePickerTitle();
  __updatePickerPreview();
}

function openItemNoPicker(itemIndex){
  // Ensure no focused input triggers iOS viewport jank
  const ae = document.activeElement;
  if(ae && typeof ae.blur === 'function') ae.blur();
  __itemNoPickerItemIndex = itemIndex;
  __itemNoSelected = new Set(__parseItemNo(items[itemIndex]?.itemNo).filter(x=>/^(?:[1-9]|1[0-5])$/.test(String(x))));
  __itemNoUsed = __computeUsedItemNos(itemIndex);
  __itemNoHideMode = false;

  renderItemNoGrid();

  const modal = document.getElementById('itemNoPickerModal');
  modal.classList.add('show');
  __lockScroll();
}

function closeItemNoPicker(){
  const modal = document.getElementById('itemNoPickerModal');
  modal.classList.remove('show');
  __unlockScroll();
  __itemNoPickerItemIndex = null;
  __itemNoSelected = new Set();
  __itemNoHideMode = false;
}

function itemNoPickerClear(){
  __itemNoSelected.clear();
  document.querySelectorAll('#itemNoPickerGrid .itemNoBtn').forEach(b=>b.classList.remove('on'));
  __updatePickerPreview();
}

function itemNoPickerDone(){
  if(__itemNoPickerItemIndex==null) return closeItemNoPicker();

  // Enforce uniqueness: remove any numbers already used in other areas
  const used = __computeUsedItemNos(__itemNoPickerItemIndex);
  const arr = __sortedSelected().filter(x=>!used.has(x));

  items[__itemNoPickerItemIndex].itemNo = __formatItemNo(arr);
  save();
  render();
  closeItemNoPicker();
}

function itemNoPickerToggleHideMode(){
  __itemNoHideMode = !__itemNoHideMode;
  renderItemNoGrid();
}

function itemNoPickerUnhideAll(){
  __itemNoHidden.clear();
  saveHiddenItemNos();
  renderItemNoGrid();
}

// === iOS scroll lock (prevents Safari/Files bottom bar flicker) ===
let __scrollLockY = 0;
function __lockScroll(){
  __scrollLockY = window.scrollY || 0;
  document.body.classList.add('scrollLocked');
  document.body.style.top = (-__scrollLockY) + 'px';
}
function __unlockScroll(){
  document.body.classList.remove('scrollLocked');
  const y = __scrollLockY || 0;
  document.body.style.top = '';
  window.scrollTo(0, y);
}
// === Item No Picker: single event model (iOS-stable) ===
(function initItemNoPicker(){
  function ready(){
    const modal = document.getElementById('itemNoPickerModal');
    const panel = document.getElementById('itemNoPickerPanel');
    const grid  = document.getElementById('itemNoPickerGrid');
    const btnClear = document.getElementById('itemNoPickerClearBtn');
    const btnDone  = document.getElementById('itemNoPickerDoneBtn');
    const btnHide  = document.getElementById('itemNoPickerHideBtn');
    const btnUnhide= document.getElementById('itemNoPickerUnhideBtn');
    if(!modal || !panel || !grid || !btnClear || !btnDone) return;


    // Prevent background scroll / rubber-band while modal is open (iOS)
    modal.addEventListener('touchmove', (ev)=>{ ev.preventDefault(); }, {passive:false});

    // Hide/Unhide buttons are optional, but expected in the final UI



    // Prevent iOS focus/keyboard/suggestion bar on Item No input (stops viewport jank)
    document.addEventListener('pointerdown', (e)=>{
      const el = e.target.closest('.itemNoInput');
      if(!el) return;
      e.preventDefault();
      e.stopPropagation();
      const ae = document.activeElement;
      if(ae && typeof ae.blur === 'function') ae.blur();
      try{ el.blur(); }catch(_){}
    }, {passive:false, capture:true});

    // Open on pointerup (prevents immediate open+close on iOS)
    document.addEventListener('pointerup', (e)=>{
      const el = e.target.closest('.itemNoInput');
      if(!el) return;
      e.preventDefault();
      e.stopPropagation();
      const idx = parseInt(el.getAttribute('data-item-index')||'-1',10);
      if(Number.isFinite(idx) && idx>=0) openItemNoPicker(idx);
    }, {passive:false});

    // Backdrop close
    modal.addEventListener('pointerup', (e)=>{
      if(e.target === modal){ e.preventDefault(); closeItemNoPicker(); }
    }, {passive:false});

    // Keep taps inside panel from bubbling to backdrop
    panel.addEventListener('pointerup', (e)=>{ e.stopPropagation(); }, {passive:true});

    // Grid toggle (delegation)
    grid.addEventListener('pointerup', (e)=>{
      const b = e.target.closest('button.itemNoBtn');
      if(!b) return;
      e.preventDefault();
      e.stopPropagation();

      if(b.disabled || b.classList.contains('disabled')) return;

      const key = b.getAttribute('data-n');
      if(!key) return;

      // Hide-mode: tap to hide/unhide (UX only)
      if(__itemNoHideMode){
        // Do not allow hiding numbers used by other areas (must stay visible to avoid "invisible used")
        const usedElsewhere = (__itemNoUsed && __itemNoUsed.has(key) && !__itemNoSelected.has(key));
        if(usedElsewhere) return;

        if(__itemNoHidden.has(key)){
          __itemNoHidden.delete(key);
        }else{
          __itemNoHidden.add(key);
          // If user hides a currently selected number, deselect it
          if(__itemNoSelected.has(key)){
            __itemNoSelected.delete(key);
          }
        }
        saveHiddenItemNos();
        renderItemNoGrid();
        return;
      }

      // Normal mode: multi-select with uniqueness across areas
      if(__itemNoSelected.has(key)){
        __itemNoSelected.delete(key);
        b.classList.remove('on');
      }else{
        if(__itemNoUsed && __itemNoUsed.has(key)) return;
        __itemNoSelected.add(key);
        b.classList.add('on');
      }

      __updatePickerPreview();

      // If it was a conflict number and user turned it off, lock it now
      if(!__itemNoSelected.has(key) && __itemNoUsed && __itemNoUsed.has(key)){
        b.classList.remove('conflict');
        b.disabled = true;
        b.classList.add('disabled');
        b.setAttribute('aria-disabled','true');
        b.title = 'Already used in another area';
      }
    }, {passive:false});

    // Clear / Done
    btnClear.addEventListener('pointerup', (e)=>{ e.preventDefault(); e.stopPropagation(); itemNoPickerClear(); }, {passive:false});
    btnDone .addEventListener('pointerup', (e)=>{ e.preventDefault(); e.stopPropagation(); itemNoPickerDone();  }, {passive:false});

    if(btnHide){
      btnHide.addEventListener('pointerup', (e)=>{ e.preventDefault(); e.stopPropagation(); itemNoPickerToggleHideMode(); }, {passive:false});
    }
    if(btnUnhide){
      btnUnhide.addEventListener('pointerup', (e)=>{ e.preventDefault(); e.stopPropagation(); itemNoPickerUnhideAll(); }, {passive:false});
    }

    // Optional: prevent iOS pinch-zoom while modal open
    document.addEventListener('gesturestart', (e)=>{
      if(modal.classList.contains('show')) e.preventDefault();
    }, {passive:false});
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ready);
  else ready();
})();

/* ===== Calculate: validate all inputs/selects above the Calculate card ===== */
(function(){
  function isVisible(el){
    return !!(el && el.offsetParent !== null);
  }
  function isBefore(a, b){
    // true if b is after a in document order
    return !!(a && b && (a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING));
  }
  function cleanInvalid(){
    document.querySelectorAll('.invalidField').forEach(el=>el.classList.remove('invalidField'));
    const ok = document.getElementById('calcOk');
    const err = document.getElementById('calcErr');
    const list = document.getElementById('calcErrList');
    if(ok) ok.style.display = 'none';
    if(err) err.style.display = 'none';
    if(list) list.innerHTML = '';
  }

  function fieldLabel(el){
    const id = (el.id || '');
    // Meta row
    if(id === 'orderMain' || id === 'orderSub') return 'Order #';
    if(id === 'qtyTotal') return 'Qty, set (total)';

    // Program card mapping by id pattern *_ii_ri
    const m = id.match(/^(mat|col|thk|psh)_(\d+)_(\d+)$/);
    const map = { mat:'Material', col:'Color', thk:'Thk', psh:'P/Sh' };
    if(m){
      const ii = parseInt(m[2],10);
      const ri = parseInt(m[3],10);
      const prog = Number.isFinite(ii) ? (ii+1) : '?';
      const layer = Number.isFinite(ri) ? (ri+1) : '?';
      return `Program ${prog}, Layer ${layer}: ${map[m[1]] || 'Field'}`;
    }

    // Item No input in header
    if(el.classList.contains('itemNoInput')){
      const ii = parseInt(el.getAttribute('data-item-index')||'-1',10);
      const prog = Number.isFinite(ii) && ii>=0 ? (ii+1) : '?';
      return `Program ${prog}: Item No`;
    }

    // Layer select
    if(el.classList.contains('layerSel')){
      // layer selector belongs to program card
      const card = el.closest('.card');
      const idxEl = card ? card.querySelector('.itemIndex') : null;
      const prog = idxEl ? idxEl.textContent.trim() : '?';
      return `Program ${prog}: Layers`;
    }

    // Fallback
    return (el.getAttribute('placeholder') || el.getAttribute('aria-label') || 'Field').trim();
  }

  
  function n(v){
    const s = String(v ?? "").replace(",", ".").trim();
    if(!s) return NaN;
    const x = Number(s);
    return Number.isFinite(x) ? x : NaN;
  }

  // Greedy First-Fit Decreasing bin packing for fractions into leftover capacity
  function packFractions(fracs, capacity){
    const bins = []; // each bin: {used: number, parts: number[]}
    const sorted = fracs.slice().sort((a,b)=>b-a);
    for(const f of sorted){
      let placed = false;
      for(const b of bins){
        if (b.used + f <= capacity + 1e-9){
          b.used += f;
          b.parts.push(f);
          placed = true;
          break;
        }
      }
      if(!placed){
        bins.push({used: f, parts:[f]});
      }
    }
    return bins;
  }

  function fmt(x, digits=2){
    if(!Number.isFinite(x)) return "";
    const p = Math.pow(10, digits);
    const s = String(Math.round(x*p)/p);
    return s.includes(".") ? s.replace(".", ",") : s;
  }
  // --- Thickness label helper (Noppe base/double) ---
  function thkLabel(mat, thk){
    if(!Number.isFinite(thk)) return "—";
    const m = String(mat||"").toLowerCase();
    if(m.includes("noppe")){
      return `${fmt(n(thk),1)} / ${fmt(n(thk*2),1)}`;
    }
    return `${fmt(n(thk),1)}`;
  }
  function thkLabelMm(mat, thk){
    const t = thkLabel(mat, thk);
    return (t==="—") ? "—" : `${t} mm`;
  }


  function isNoCutMaterial(mat){
    const m = String(mat||"").trim();
    return /noppe/i.test(m) || /^mlf$/i.test(m);
  }

  function escHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  function buildCutList(){
    // Cutting plan view mode:
    //  - Cut view (simple): aggregated by target thickness (best for operator)
    //  - Full: shows each physical cut step (with waste)
    // Default to Cut view (simple) and persist in localStorage.
    try{
      const saved = localStorage.getItem('cutSimpleView');
      if(saved === null){
        window.__cutSimpleView = true;
        localStorage.setItem('cutSimpleView','1');
      } else {
        window.__cutSimpleView = (saved === '1');
      }
    }catch(e){
      window.__cutSimpleView = true;
    }

    const cutRoot = document.getElementById("cutList");
    if(!cutRoot) return;

    // Reserve: currently fixed at 10% (can be configurable later)
    const reserve = 0.10;
    const capacity = 1 - reserve;

    // Qty set total
    const qtyEl = document.getElementById("qtyTotal");
    const qtyTotal = qtyEl ? n(qtyEl.value) : NaN;

    if(!Number.isFinite(qtyTotal) || qtyTotal <= 0){
      cutRoot.innerHTML = '<div class="badge">Qty, set (total) is required for Cut list</div>';
      return;
    }

    // Build entries from items model (preferred). If items not in scope, fall back to DOM scan.
    let entries = [];
    try{
      if(Array.isArray(items)){
        items.forEach((it, ii)=>{
          const itemNo = (it.itemNo || "").trim();
          const layers = Math.max(1, Number(it.layer||1));
          // Seam allowance for lamination: +0.5 mm per joint (layers-1) added to the thickest layer only
          let seamIdx = 0;
          if(layers >= 2){
            let maxT = -Infinity;
            for(let rj=0; rj<layers; rj++){
              const rowJ = it.rows?.[rj] || {};
              let v = parseFloat(rowJ.thk ?? '');
              if(!Number.isFinite(v)) continue;
              // Min rules: multi-layer min 5.0, single-layer min 1.5
              if(v < 5.0) v = 5.0;
              if(v > maxT){
                maxT = v;
                seamIdx = rj;
              }
            }
          }
          const seamExtra = 0; // was 0.5*(layers-1) seam extra

          for(let ri=0; ri<layers; ri++){
            const r = it.rows && it.rows[ri] ? it.rows[ri] : {};
            const material = (r.material||"").trim();
            const color = (r.color||"").trim();
            const thkRaw = (r.thk||"").trim();
            const psh = n(r.psh);
            if(!material || !color || !thkRaw || !Number.isFinite(psh) || psh<=0) continue;
            
            const targetThk = n(thkRaw);
            // Apply seam allowance to the thickest layer of the AREA (layers>=2): +0.5 mm per joint (layers-1)
            // Add it to this row's target thickness BEFORE any stock/lamination logic.
            const targetThkEff = (Number.isFinite(targetThk) ? (targetThk + ((layers >= 2 && ri === seamIdx) ? seamExtra : 0)) : targetThk);


            // Compute plates for this position
            const plates = qtyTotal / psh;
            const intPart = Math.floor(plates + 1e-9);
            const frac = plates - intPart;

            // Thickness options (stock) for this material+color from table
            const optsAll = getStockOptions(material, color).slice().sort((a,b)=>a-b);
                        const lamNoteStrict = (thk)=> (thk < 15) ? " (Two-person lamination)" : " (for lamination)";
            const lamWordStrict = (thk)=> (thk < 15) ? "Two-person lamination" : "for lamination";

            // Case 2: normal cutting (also supports cutting non-stock target thickness from closest stock)
            let tThk = targetThkEff;

            // Minimum target thickness rules:
            // - if this area has 2+ layers: minimum 5.0 mm (we will cut it from stock)
            // - if this area has 1 layer: minimum 1.5 mm
            if(Number.isFinite(tThk)){
              if(layers >= 2 && tThk < 5.5) tThk = 5.0;
              if(layers === 1 && tThk < 1.5) tThk = 1.5;
            }

                        const effThk = tThk;

            // Stock options: start from filter (if set), but if it cannot cover needed thickness,
// fall back to full table options for the same material+color so we can prefer single-sheet.
function getStockOptionsSmart(material, color, needed){
  const filtered = getStockOptions(material, color).slice().sort((a,b)=>a-b);
  if(!filtered.length) return getThkOptions(material, color).slice().sort((a,b)=>a-b);
  const maxF = filtered[filtered.length-1];
  if(Number.isFinite(needed) && Number.isFinite(maxF) && maxF + 1e-9 < needed){
    const full = getThkOptions(material, color).slice().sort((a,b)=>a-b);
    // merge unique
    const set = new Set(filtered.map(String));
    for(const t of full){ set.add(String(t)); }
    return Array.from(set).map(Number).filter(Number.isFinite).sort((a,b)=>a-b);
  }
  return filtered;
}

const optsAll2 = getStockOptionsSmart(material, color, effThk).slice().sort((a,b)=>a-b);
            const maxOpt2  = optsAll2.length ? optsAll2[optsAll2.length-1] : NaN;

            // If effective thickness exceeds max stock, auto-build lamination plan on effective thickness.
            if(Number.isFinite(effThk) && Number.isFinite(maxOpt2) && effThk > maxOpt2 + 1e-9){
              const plan2 = solveLaminationPlan(material, color, effThk);
              if(plan2){
                for(const L of plan2.layers){
                  const tag = lamWordStrict(L.cut);
                  const line = `${material} / ${color} / ${fmt(L.stock,1)} mm → cut to ${fmt(L.cut,1)} mm (waste ${fmt(L.waste,1)} mm, ${tag})`;
                  // IMPORTANT:
                  // - keep targetThk so the compact "Full" view can show the *cut-to* thickness (e.g. 70 mm),
                  //   not the stock thickness (e.g. 100 mm)
                  // - keep note so the compact view can still indicate lamination
                  entries.push({
                    material,
                    color,
                    thk: String(L.stock),
                    stockThk: L.stock,
                    targetThk: L.cut,
                    note: ` (${tag})`,
                    display: line,
                    itemNo,
                    program: ii+1,
                    layer: ri+1,
                    programLayers: layers,
                    psh,
                    plates,
                    intPart,
                    frac: frac>1e-9 ? frac : 0
                  });
                }
                continue;
              }
            }

            const note = (layers >= 2 && Number.isFinite(effThk)) ? lamNoteStrict(effThk) : "";

            // Choose stock for cutting when effThk is not an exact stock thickness
            let stock = NaN;
            if(Number.isFinite(effThk) && optsAll2.length){
              stock = optsAll2.find(o => o >= effThk - 1e-9);
              if(!Number.isFinite(stock)) stock = maxOpt2;
            }

            let display = `${material} / ${color} / ${thkLabelMm(material, n(effThk))}${note}`;
            let thkKey = Number.isFinite(effThk) ? String(effThk) : thkRaw;

            if(Number.isFinite(stock) && Number.isFinite(effThk) && Math.abs(stock - effThk) > 1e-6){
              const waste = stock - effThk;
              const tag = (layers >= 2) ? lamWordStrict(effThk) : "";
              const extra = tag ? `, ${tag}` : "";
              display = `${material} / ${color} / ${fmt(stock,1)} mm → cut to ${thkLabelMm(material, n(effThk))} (waste ${fmt(waste,1)} mm${extra})`;
              thkKey = String(stock);
            }

            entries.push({
              material, color,
              thk: thkKey,
              stockThk: stock,
              targetThk: targetThkEff,
              note,
              display,
              itemNo, program: ii+1, layer: ri+1,
              programLayers: layers,
              psh, plates, intPart, frac: frac>1e-9 ? frac : 0
            });
}
        });
      }
    }catch(_){}

    if(entries.length === 0){
      cutRoot.innerHTML = '<div class="badge">No cut materials data found</div>';
      return;
    }

    // Group by Material + Color + Thk
    const groups = new Map();
    for(const e of entries){
      const key = (e.display ? `D||${e.display}` : `${e.material}||${e.color}||${e.thk}`);
      if(!groups.has(key)){
        groups.set(key, {material:e.material, color:e.color, thk:e.thk, note:e.note || "", display:e.display || "", stockThk:e.stockThk, targetThk:e.targetThk, entries:[]});
      }
      groups.get(key).entries.push(e);
    }

    // Render groups
    let out = '';
    out += `<div class="cutSectionTitle"><span>Cutting plan</span><button id="cutViewToggleBtn" class="smallBtn" type="button">${window.__cutSimpleView ? "Full" : "Cut view"}</button></div>`;

    // --- Reuse offcuts between targets (same material+color) ---
    // Example: cut 100 -> 52 leaves 48, so a required 48 can be taken from that offcut
    // instead of picking a new 50 plate.
    function __parseCut(displayStr){
      const s = String(displayStr||"");
      // Matches: "... / 100 mm → cut to 52 mm (waste 48 mm" ...
      const m = s.match(/\/\s*([0-9]+(?:[\.,][0-9]+)?)\s*mm\s*→\s*cut\s*to\s*([0-9]+(?:[\.,][0-9]+)?)\s*mm/i);
      if(!m) return null;
      const from = n(m[1]);
      const to   = n(m[2]);
      if(!Number.isFinite(from) || !Number.isFinite(to)) return null;
      return {from, to, waste: from - to};
    }
    
    const __groupsForPick = [];
    const __sortedGroups = Array.from(groups.values()).sort((a,b)=>{
      const k1=(a.material+a.color+a.thk).toLowerCase();
      const k2=(b.material+b.color+b.thk).toLowerCase();
      return k1.localeCompare(k2);
    });

    // First pass: compute required "sh" for each group
    for(const g of __sortedGroups){
      const sumInt = g.entries.reduce((s,e)=>s+e.intPart,0);
      const fracs = g.entries.map(e=>e.frac).filter(f=>f>1e-9);
      const bins = packFractions(fracs, capacity);
      const fullFromFractions = Math.max(0, bins.length - 1);
      const lastFraction = bins.length ? bins[bins.length - 1].used : 0;
      const totalPlates = sumInt + fullFromFractions + lastFraction;

      // expose grouping info for Material to pick (no extra recalculation; same data)
      g.sumInt = sumInt;
      g.bins = bins;
      g.totalPlates = totalPlates;
      g.pickPlates = totalPlates;

      // parse cut info (from/to/waste) if present
      const parsed = __parseCut(g.display);
      if(parsed){
        g.__fromThk = parsed.from;
        g.__toThk = parsed.to;
        g.__wasteThk = parsed.waste;
      } else {
        const t = Number.isFinite(g.targetThk) ? n(g.targetThk) : n(g.thk);
        g.__fromThk = n(g.thk);
        g.__toThk = t;
        g.__wasteThk = (Number.isFinite(g.__fromThk) && Number.isFinite(g.__toThk)) ? (g.__fromThk - g.__toThk) : NaN;
      }

      __groupsForPick.push(g);
    }

    // Second pass: reuse offcuts (same material+color) with "fits" logic.
    // If there is a waste piece that is >= needed thickness, we use it first.
    // If waste is bigger than needed, we cut it and generate a NEW smaller waste piece.
    // Greedy best-fit: pick the smallest waste that still fits.
    // Example: 100 -> 52 leaves 48, so any needed 48 can be taken from that offcut.
    // Also supports: waste 60 can cover need 52, leaving new waste 8.
    const __EPS = 1e-6;
    const wastePool = []; // {mat,col, thk, sh, src}

    for(const a of __groupsForPick){
      const waste = a.__wasteThk;
      if(!Number.isFinite(waste) || waste <= __EPS) continue;
      if(!Number.isFinite(a.pickPlates) || a.pickPlates <= 1e-9) continue;
      wastePool.push({
        mat: (a.material||""),
        col: (a.color||""),
        thk: waste,
        sh: a.pickPlates,
        src: a
      });
    }

    // Process needs from thickest to thinnest
    const needs = __groupsForPick.slice().sort((x,y)=>{
      const a = Number.isFinite(x.__toThk) ? x.__toThk : -Infinity;
      const b = Number.isFinite(y.__toThk) ? y.__toThk : -Infinity;
      return b-a;
    });

    for(const b of needs){
      const needThk = b.__toThk;
      if(!Number.isFinite(needThk) || needThk <= __EPS) continue;
      if(!Number.isFinite(b.pickPlates) || b.pickPlates <= 1e-9) continue;

      let remaining = b.pickPlates;
      while(remaining > 1e-9){
        // find best-fit waste (smallest thk that still fits)
        let bestIdx = -1;
        let bestThk = Infinity;
        for(let i=0;i<wastePool.length;i++){
          const w = wastePool[i];
          if(w.sh <= 1e-9) continue;
          if(w.mat !== (b.material||"")) continue;
          if(w.col !== (b.color||"")) continue;
          if(!Number.isFinite(w.thk) || w.thk + __EPS < needThk) continue;
          if(w.thk < bestThk){
            bestThk = w.thk;
            bestIdx = i;
          }
        }
        if(bestIdx === -1) break; // no more fitting waste

        const w = wastePool[bestIdx];
        const use = Math.min(remaining, w.sh);
        if(use <= 1e-9) break;

        // consume
        w.sh -= use;
        remaining -= use;
        b.pickPlates = Math.max(0, b.pickPlates - use);

        // annotate donor so it is clear why we didn't pick a new plate
        w.src.__usesWasteFor = w.src.__usesWasteFor || [];
        w.src.__usesWasteFor.push({from: w.thk, to: needThk, sh: use});

        // if waste is larger, cutting it produces a new smaller waste piece
        const newWaste = w.thk - needThk;
        if(Number.isFinite(newWaste) && newWaste > __EPS){
          wastePool.push({mat: w.mat, col: w.col, thk: newWaste, sh: use, src: w.src});
        }
      }
    }

    // --- Allocate cuts to plates with leftover reuse (Material+Color scoped) ---
// This drives BOTH:
//   1) Cutting plan (shows cuts from leftover pieces when possible)
//   2) Material to pick (groups cuts under the same physical plate)
// Rules:
//   - If leftover == needed -> must use leftover
//   - If leftover  > needed -> cut from leftover and keep the new smaller leftover
const __allocBuckets = [];
const __byMC = new Map();

for(const g of __sortedGroups){
  const needThk = g.__toThk;
  const sh = Number(g.totalPlates || 0);
  if(!(g.material||"").trim()) continue;
  if(!Number.isFinite(needThk) || needThk <= __EPS) continue;
  if(!Number.isFinite(sh) || sh <= __EPS) continue;

  const key = (String(g.material)+'||'+String(g.color||'')).toLowerCase();
  if(!__byMC.has(key)) __byMC.set(key, {mat: g.material, col: g.color || "", items: []});

  // Detect lamination note from display for Material to pick (expanded view only)
  let note = "";
  const dispLow = String(g.display||"").toLowerCase();
  if(dispLow.includes("two-person lamination")) note = " (Two-person lamination)";
  else if(dispLow.includes("for lamination")) note = " (for lamination)";

  __byMC.get(key).items.push({needThk, sh, note});
}

function __expandChunks(items){
  const chunks = [];
  for(const it of items){
    let rem = it.sh;
    while(rem > __EPS){
      const take = Math.min(1, rem);
      chunks.push({needThk: it.needThk, sh: take, note: it.note || ""});
      rem -= take;
    }
  }
  // thickest first
  chunks.sort((a,b)=>b.needThk - a.needThk);
  return chunks;
}

function __getStockOptions(mat, col, needed){
  // Respect Filter materials thickness selection (stock forcing).
  // If filter forces 100 mm, we MUST only open 100 mm here.
  // If forced stock is too small for needed cut, fall back to full table options.
  let filtered = (typeof getStockOptions==='function' ? getStockOptions(mat, col) : []).slice()
    .map(Number).filter(x=>isFinite(x) && x>0).sort((a,b)=>a-b);
  if(!filtered.length){
    return getThkOptions(mat, col).slice().map(Number).filter(x=>isFinite(x) && x>0).sort((a,b)=>a-b);
  }
  if(Number.isFinite(needed)){
    const maxF = filtered[filtered.length-1];
    if(Number.isFinite(maxF) && maxF + 1e-9 < needed){
      const full = getThkOptions(mat, col).slice().map(Number).filter(x=>isFinite(x) && x>0).sort((a,b)=>a-b);
      const set = new Set(filtered.map(String));
      for(const t of full){ set.add(String(t)); }
      return Array.from(set).map(Number).filter(x=>isFinite(x) && x>0).sort((a,b)=>a-b);
    }
  }
  return filtered;
}

function __allocate(mat, col, items){
  const maxNeed = items.reduce((m,it)=> (Number.isFinite(it.needThk)&&it.needThk>m)?it.needThk:m, 0);
  const opts = __getStockOptions(mat, col, maxNeed);
  const chunks = __expandChunks(items);

  const plates = []; // {stockThk, remain, cuts:Map, cutsSeq:[]}
  const cutSteps = new Map(); // key "from||to||note" -> sh

  for(const ch of chunks){
    const need = ch.needThk;

    // 1) Try to fit into an existing leftover (best-fit: smallest remainAfter)
    let bestIdx = -1;
    let bestAfter = Infinity;
    for(let i=0;i<plates.length;i++){
      const p = plates[i];
      if(p.remain + __EPS >= need){
        const after = p.remain - need;
        if(after < bestAfter){
          bestAfter = after;
          bestIdx = i;
        }
      }
    }

    if(bestIdx === -1){
      // 2) Open new plate: choose smallest stock that fits
      let stock = null;
      for(const x of opts){ if(x + __EPS >= need){ stock = x; break; } }
      if(stock === null){
        stock = opts.length ? opts[opts.length-1] : need;
      }

      const from = stock;
      const to = need;
      const waste = from - to;

      const p = {stockThk: stock, remain: waste, cuts: new Map(), cutsSeq: []};
      const k = String(to) + '||' + (ch.note||'');
      p.cuts.set(k, (p.cuts.get(k)||0) + ch.sh);
      p.cutsSeq.push({from, to, sh: ch.sh, note: ch.note||''});
      plates.push(p);

      const stepKey = String(from) + '||' + String(to) + '||' + (ch.note||'');
      cutSteps.set(stepKey, (cutSteps.get(stepKey)||0) + ch.sh);
    } else {
      const p = plates[bestIdx];
      const from = p.remain;
      const to = need;
      p.remain = p.remain - need;

      const k = String(to) + '||' + (ch.note||'');
      p.cuts.set(k, (p.cuts.get(k)||0) + ch.sh);
      p.cutsSeq.push({from, to, sh: ch.sh, note: ch.note||''});

      const stepKey = String(from) + '||' + String(to) + '||' + (ch.note||'');
      cutSteps.set(stepKey, (cutSteps.get(stepKey)||0) + ch.sh);
    }
  }

  return {mat, col, plates, cutSteps};
}

for(const bucket of __byMC.values()){
  __allocBuckets.push(__allocate(bucket.mat, bucket.col, bucket.items));
}

// Expose allocator result for Material to pick
window.__matPickBuckets = __allocBuckets;

// --- Render Cutting plan from allocator (shows leftover cuts) ---
const __cutLines = []; // {mat,col,from,to,note,sh}
for(const bkt of __allocBuckets){
  const mat = bkt.mat, col = bkt.col;
  for(const [k, sh] of bkt.cutSteps.entries()){
    const parts = String(k).split('||');
    const from = n(parts[0]);
    const to = n(parts[1]);
    const note = parts.slice(2).join('||') || '';
    if(!Number.isFinite(from) || !Number.isFinite(to)) continue;
    if(!Number.isFinite(sh) || sh <= 1e-9) continue;
    __cutLines.push({mat, col, from, to, note, sh});
  }
}

// stable order: material/color, then from desc, then to desc
__cutLines.sort((a,b)=>{
  const k1 = (a.mat+'||'+a.col).toLowerCase();
  const k2 = (b.mat+'||'+b.col).toLowerCase();
  if(k1 !== k2) return k1.localeCompare(k2);
  if(b.from !== a.from) return b.from - a.from;
  return b.to - a.to;
});

  // If simplified view is ON, merge identical target cuts for readability:
  // e.g. show "25 mm (3 sh)" instead of three separate 25 mm lines.
  if(window.__cutSimpleView){
    const merged = new Map(); // key = mat||col||to
    for(const ln of __cutLines){
      const key = (ln.mat||'') + '||' + (ln.col||'') + '||' + String(ln.to);
      const prev = merged.get(key);
      if(prev){
        prev.sh += ln.sh;
      } else {
        merged.set(key, {mat: ln.mat, col: ln.col, from: ln.from, to: ln.to, note: ln.note, sh: ln.sh});
      }
    }
    // replace content
    __cutLines.length = 0;
    for(const v of merged.values()) __cutLines.push(v);
    // sort again by mat/col then to desc
    __cutLines.sort((a,b)=>{
      const k1 = (a.mat+'||'+a.col).toLowerCase();
      const k2 = (b.mat+'||'+b.col).toLowerCase();
      if(k1 !== k2) return k1.localeCompare(k2);
      return b.to - a.to;
    });
  }

for(const line of __cutLines){

  out += `<div class="cutGroup">`;
  let leftText;
  // Noppe + MLF are "NO CUT" (transfer/pick only) in both views
  if(isNoCutMaterial(line.mat)){
    const lbl = thkLabelMm(line.mat, n(line.to));
    leftText = `${line.mat} / ${line.col} / ${lbl} — NO CUT${line.note || ""}`;
  } else if(window.__cutSimpleView){
    leftText = `${line.mat} / ${line.col} → ${fmt(n(line.to),1)} mm${line.note || ""}`;
  } else {
    const waste = line.from - line.to;
    leftText = `${line.mat} / ${line.col} / ${fmt(n(line.from),1)} mm → cut to ${fmt(n(line.to),1)} mm (waste ${fmt(n(waste),1)} mm)${line.note || ""}`;
  }
  out += `<div class="cutTitle"><input class="cutChk" type="checkbox" aria-label="Mark as done"><span class="cutLeft">${escHtml(leftText)}</span><span class="badge">${fmt(n(line.sh),1)} sh</span></div>`;
  out += `</div>`;
}

// Expose groups for Material to pick (no recalculation; same data)
    window.__groupsForPick = __groupsForPick;

    cutRoot.innerHTML = out;

    // Toggle simplified Cutting plan view
    const cutViewBtn = document.getElementById("cutViewToggleBtn");
    if(cutViewBtn){
      cutViewBtn.addEventListener("click", function(){
        window.__cutSimpleView = !window.__cutSimpleView;
        try{ localStorage.setItem('cutSimpleView', window.__cutSimpleView ? '1' : '0'); }catch(e){}
        buildCutList();
      });
    }

    // Render Material to pick AFTER Cutting plan is in DOM (Safari-safe)
    try{ setTimeout(function(){ try{ renderPreparationFromPrograms(); }catch(e){} try{ renderMaterialToPickFromGroups(window.__groupsForPick); __setMatPickMode('operator');
}catch(err){
  const mp=document.getElementById('matPick'); if(mp){ mp.innerHTML='<div class="badge">Material to pick render error</div><div style="opacity:.75; font-size:12px; margin-top:6px;">'+String(err)+'</div>'; }
} }, 0); }catch(e){}
  }


  // --- Material to pick: two views from the same already-calculated grouping data (no recalculation on toggle) ---
  let __matPickMode = "A"; // A = Plate allocation (default), B = Plate sum (summary)

  function setMatPickMode(mode){
    __matPickMode = (mode === "B") ? "B" : "A";
    const vA = document.getElementById("matPickViewA");
    const vB = document.getElementById("matPickViewB");
    const btn = document.getElementById("matPickToggleBtn");
    if(vA) vA.style.display = (__matPickMode === "A") ? "" : "none";
    if(vB) vB.style.display = (__matPickMode === "B") ? "" : "none";
    if(btn) btn.textContent = (__matPickMode === "A") ? "Plate sum" : "Back";
  }

  function toggleMatPickMode(){
    setMatPickMode(__matPickMode === "A" ? "B" : "A");
  }

  

function renderMaterialToPickFromGroups(groups){
  let vA = document.getElementById("matPickViewA");
  __setMatPickMode('operator');
let vB = document.getElementById("matPickViewB");
  if(!vA || !vB){
    const mp = document.getElementById('matPick');
    if(mp){
      if(!vA){ vA = document.createElement('div'); vA.id='matPickViewA'; mp.appendChild(vA); }
      if(!vB){ vB = document.createElement('div'); vB.id='matPickViewB'; vB.style.display='none'; mp.appendChild(vB); }
    }
  }
  if(!vA || !vB) return;

  // If allocator already produced plate grouping, render directly from it (source of truth)
  if(Array.isArray(window.__matPickBuckets) && window.__matPickBuckets.length){
    const buckets = window.__matPickBuckets;

    // View A: plate allocation
    let htmlA = '';
    const sumRows = []; // for View B

    const sorted = buckets.slice().sort((a,b)=>{
      const ka = (a.mat+'||'+a.col).toLowerCase();
      const kb = (b.mat+'||'+b.col).toLowerCase();
      return ka.localeCompare(kb);
    });

    for(const bkt of sorted){
      const mat = bkt.mat || '';
      const col = bkt.col || '';
      const plates = Array.isArray(bkt.plates) ? bkt.plates : [];

      // Summary counts per stock thickness
      const counts = new Map();
      plates.forEach(p=>counts.set(p.stockThk, (counts.get(p.stockThk)||0)+1));
      counts.forEach((cnt, thk)=>{ sumRows.push({mat, col, stockThk: thk, platesCount: cnt}); });

      htmlA += `<div class="isoBlock">`;
      htmlA += `<div class="isoHead">${escHtml(mat)}${col ? '&nbsp;&nbsp;' + escHtml(col) : ''}</div>`;

      plates.forEach((p, idx2)=>{
        htmlA += `<div class="isoPlate">`;
        htmlA += `<div class="isoPlateTitle">Plate ${idx2+1} (${thkLabelMm(mat, n(p.stockThk))})</div>`;

        const cutsArr = Array.from((p.cuts||new Map()).entries()).sort((a,b)=>{
          const na = Number(String(a[0]).split('||')[0]);
          const nb = Number(String(b[0]).split('||')[0]);
          return nb-na;
        });

        cutsArr.forEach(([k, sh])=>{
          const parts = String(k).split('||');
          const thk = Number(parts[0]);
          const note = (parts[1]||'');
          const shTxt = (Math.abs(sh-1) < 1e-6) ? '' : ` (${fmt(n(sh),1)} sh)`;
          htmlA += `<div class="isoLine">• <span class="isoThk">${thkLabelMm(mat, n(thk))}</span>${escHtml(note)}${shTxt}</div>`;
        });

        htmlA += `</div>`;
      });

      htmlA += `</div>`;
    }

    vA.innerHTML = htmlA || '<div class="badge">No sheets allocated</div>';

    // View B: plate sum
    let htmlB = '';
    if(!sumRows.length){
      htmlB = '<div class="badge">No sheets allocated</div>';
    } else {
      // stable order
      sumRows.sort((a,b)=>{
        const ka = (a.mat+'||'+a.col+'||'+a.stockThk).toLowerCase();
        const kb = (b.mat+'||'+b.col+'||'+b.stockThk).toLowerCase();
        return ka.localeCompare(kb);
      });
      htmlB = sumRows.map(r=>{
        const left = `${r.mat}${r.col ? ' / ' + r.col : ''} / ${thkLabelMm(r.mat, n(r.stockThk))}`;
        const right = `${r.platesCount} plates`;
        return `<div class="pickRow"><span class="txt">${escHtml(left)}</span><span class="num">${escHtml(right)}</span></div>`;
      }).join('');
    }
    vB.innerHTML = htmlB;

    setMatPickMode("A");
    return;
  }



  vA.innerHTML = "";
  vB.innerHTML = "";

  if(!Array.isArray(groups) || !groups.length){
    vA.innerHTML = '<div class="badge">No data for Material to pick</div><div style="opacity:.7; font-size:12px; margin-top:6px;">(groups array empty or not set)</div>';
    vB.innerHTML = vA.innerHTML;
    setMatPickMode("A");
    return;
  }

  function parseCutToMm(txt){
    if(!txt) return null;
    const m = String(txt).match(/cut\s*to\s*([0-9]+(?:\.[0-9]+)?)\s*mm/i);
    return m ? Number(m[1]) : null;
  }

  // Fallback: if there is no "cut to", treat the last "... mm" in display as required thickness
  function parseLastMm(txt){
    if(!txt) return null;
    const s = String(txt);
    const re = /([0-9]+(?:\.[0-9]+)?)\s*mm/ig;
    let m = null, last = null;
    while((m = re.exec(s)) !== null){
      last = m[1];
    }
    return last ? Number(last) : null;
  }

  // Collect items by stock key (material+color+stock thickness)
  const byKey = new Map(); // key -> {mat,col, items:[{reqThk, sh, note}]} 

  for(const g of groups){
    const mat = (g.material||'').trim();
    const col = (g.color||'').trim();
    const stockThk = Number(g.thk || 0);
    const display = (g.display || '').trim();
    let reqThk = parseCutToMm(display);
    if(!reqThk || !isFinite(reqThk) || reqThk<=0){
      // include also items without cut-to (no thickness reduction), only if they have positive demand
      reqThk = parseLastMm(display);
    }

    // Demand in "sh" from cutting-plan grouping (thickness-only packing; no length logic)
    let demandSh = 0;
    if(typeof g.pickPlates === "number" && isFinite(g.pickPlates)) demandSh = g.pickPlates;
    else if(typeof g.totalPlates === "number" && isFinite(g.totalPlates)) demandSh = g.totalPlates;
    else if(typeof g.total === "number" && isFinite(g.total)) demandSh = g.total;
    else if(typeof g.eqPlates === "number" && isFinite(g.eqPlates)) demandSh = g.eqPlates;

    if(!mat) continue;
    if(!reqThk || !isFinite(reqThk) || reqThk<=0) continue;
    if(!isFinite(demandSh) || demandSh<=1e-9) continue;

    const key = (mat+'||'+col).toLowerCase();
    if(!byKey.has(key)) byKey.set(key, {mat, col, items:[]});
    // Detect lamination note from display for Material to pick (expanded view only)
    let lamNote = "";
    const dispLow = (display||"").toLowerCase();
    if(dispLow.includes("two-person lamination")) lamNote = " (Two-person lamination)";
    else if(dispLow.includes("for lamination")) lamNote = " (for lamination)";

    byKey.get(key).items.push({reqThk, sh:demandSh, note: lamNote});
  }

  if(!byKey.size){
    vA.innerHTML = '<div class="badge">No sheets allocated</div>';
    vB.innerHTML = vA.innerHTML;
    setMatPickMode("A");
    return;
  }

  // Thickness-only packing with remainders across different req thicknesses (best-fit).
  // Each physical plate has thickness capacity = stockThk (mm).
  // We allocate chunks of 1 sh (last chunk can be fractional).
  function packThickness(stockThk, items){
    // (legacy) pack into a fixed stock thickness
    const chunks = [];
    for(const it of items){
      let rem = it.sh;
      while(rem > 1e-9){
        const take = Math.min(1, rem);
        chunks.push({reqThk: it.reqThk, sh: take, note: it.note||""});
        rem -= take;
      }
    }
    chunks.sort((a,b)=>b.reqThk - a.reqThk);

    const plates = []; // {remain:number, cuts: Map(reqThk||note -> sh)}
    for(const ch of chunks){
      const need = ch.reqThk;
      let bestIdx = -1;
      let bestRemainAfter = Infinity;
      for(let i=0;i<plates.length;i++){
        const p = plates[i];
        if(p.remain + 1e-9 >= need){
          const remainAfter = p.remain - need;
          if(remainAfter < bestRemainAfter){
            bestRemainAfter = remainAfter;
            bestIdx = i;
          }
        }
      }
      if(bestIdx === -1){
        const k = String(need) + '||' + (ch.note||'');
        plates.push({remain: stockThk - need, cuts: new Map([[k, ch.sh]])});
      } else {
        const p = plates[bestIdx];
        p.remain -= need;
        const __note = (ch.note||'');
        const __k = String(need) + '||' + __note;
        p.cuts.set(__k, (p.cuts.get(__k)||0) + ch.sh);
      }
    }
    return plates;
  }

  // NEW: pack across multiple available stock thicknesses (reuse leftovers before opening a new plate).
  function packMultiStock(material, color, items){
    const opts = getThkOptions(material, color).slice().map(Number).filter(x=>isFinite(x) && x>0).sort((a,b)=>a-b);
    if(!opts.length){
      // fallback: use max required as pseudo-stock
      const maxNeed = Math.max(...items.map(it=>it.reqThk||0), 0);
      opts.push(maxNeed);
    }

    const chunks = [];
    for(const it of items){
      let rem = it.sh;
      while(rem > 1e-9){
        const take = Math.min(1, rem);
        chunks.push({reqThk: it.reqThk, sh: take, note: it.note||""});
        rem -= take;
      }
    }
    // Thicker first
    chunks.sort((a,b)=>b.reqThk - a.reqThk);

    const plates = []; // {stockThk:number, remain:number, cuts:Map}
    for(const ch of chunks){
      const need = ch.reqThk;
      // 1) try to fit into an existing plate (best-fit: smallest remainAfter)
      let bestIdx = -1;
      let bestRemainAfter = Infinity;
      for(let i=0;i<plates.length;i++){
        const p = plates[i];
        if(p.remain + 1e-9 >= need){
          const remainAfter = p.remain - need;
          if(remainAfter < bestRemainAfter){
            bestRemainAfter = remainAfter;
            bestIdx = i;
          }
        }
      }

      if(bestIdx === -1){
        // 2) open a new plate: choose the smallest stock that can cover need
        let stock = opts.find(x=>x + 1e-9 >= need);
        if(!stock) stock = opts[opts.length-1]; // largest available
        const k = String(need) + '||' + (ch.note||'');
        plates.push({stockThk: stock, remain: stock - need, cuts: new Map([[k, ch.sh]])});
      } else {
        const p = plates[bestIdx];
        p.remain -= need;
        const __note = (ch.note||'');
        const __k = String(need) + '||' + __note;
        p.cuts.set(__k, (p.cuts.get(__k)||0) + ch.sh);
      }
    }
    return plates;
  }

  // ---- Render View A (Operator / ISO allocation) ----
  let htmlA = '';
  const sumRows = [];

  // stable order: by material, color, stock thickness
  const buckets = Array.from(byKey.values()).sort((a,b)=>{
    const ka = (a.mat+'||'+a.col).toLowerCase();
    const kb = (b.mat+'||'+b.col).toLowerCase();
    return ka.localeCompare(kb);
  });

  for(const bucket of buckets){
    const plates = packMultiStock(bucket.mat, bucket.col, bucket.items);
    // summary per stock thickness
    const counts = new Map();
    plates.forEach(p=>counts.set(p.stockThk, (counts.get(p.stockThk)||0)+1));
    counts.forEach((cnt, thk)=>{ sumRows.push({mat: bucket.mat, col: bucket.col, stockThk: thk, platesCount: cnt}); });

    htmlA += `<div class="isoBlock">`;
    htmlA += `<div class="isoHead">${escHtml(bucket.mat)}${bucket.col ? '&nbsp;&nbsp;' + escHtml(bucket.col) : ''}</div>`;
    plates.forEach((p, idx)=>{
      htmlA += `<div class="isoPlate">`;
      htmlA += `<div class="isoPlateTitle">Plate ${idx+1} (${thkLabelMm(mat, n(p.stockThk))})</div>`;
      const cutsArr = Array.from(p.cuts.entries()).sort((a,b)=>{
        const na = Number(String(a[0]).split('||')[0]);
        const nb = Number(String(b[0]).split('||')[0]);
        return nb-na;
      });
      cutsArr.forEach(([k, sh])=>{
        const parts = String(k).split('||');
        const thk = Number(parts[0]);
        const note = (parts[1]||'');
        const shTxt = (Math.abs(sh-1) < 1e-6) ? '' : ` (${fmt(n(sh),1)} sh)`;
        // Expanded view only: include lamination note (e.g. " (for lamination)")
        htmlA += `<div class="isoLine">• <span class="isoThk">${thkLabelMm(mat, n(thk))}</span>${escHtml(note)}${shTxt}</div>`;
      });
      htmlA += `</div>`;
    });
    htmlA += `</div>`;
  }
  vA.innerHTML = htmlA || '<div class="badge">No sheets allocated</div>';

  // ---- Render View B (Plate sum) ----
  let htmlB = '';
  if(!sumRows.length){
    htmlB = '<div class="badge">No sheets allocated</div>';
  } else {
    htmlB = sumRows.map(r=>{
      const left = `${r.mat}${r.col ? ' / ' + r.col : ''} / ${thkLabelMm(r.mat, n(r.stockThk))}`;
      const right = `${r.platesCount} plates`;
      return `<div class="pickRow"><span class="txt">${escHtml(left)}</span><span class="num">${escHtml(right)}</span></div>`;
    }).join('');
  }
  vB.innerHTML = htmlB;

  // After each Calculate, default to Operator view (A)
  setMatPickMode("A");

  // --- Operator ISO enhanced rendering (View A) ---
  // Expects `matPickPlatesByGroup` OR `platesByGroup` built by the allocator.
  try{
    const viewAEl = document.getElementById('matPickViewA');
    if(viewAEl){
      const srcPlates = (typeof matPickPlatesByGroup !== 'undefined' && matPickPlatesByGroup) ? matPickPlatesByGroup
                      : (typeof platesByGroup !== 'undefined' && platesByGroup) ? platesByGroup
                      : null;
      if(srcPlates){
        let iso = '';
        const groupKeys = Object.keys(srcPlates);
        groupKeys.forEach(gk=>{
          const g = srcPlates[gk];
          const mat = g.material || g.mat || gk.split('|')[0] || '';
          const color = g.color || gk.split('|')[1] || '';
          const stockThk = g.stockThk || g.stock || gk.split('|')[2] || '';
          const plates = g.plates || [];
          iso += `<div class="isoGroupTitle">${mat} ${color}${stockThk?` (Stock ${stockThk} mm)`:''}</div>`;
          plates.forEach((p, idx)=>{
            const pStock = p.stockThk || stockThk;
            iso += `<div class="isoPlateTitle">Plate ${idx+1}${pStock?` (${pStock} mm)`:''}</div>`;
            iso += `<ul class="isoBullets">`;
            (p.cuts || p.items || []).forEach(c=>{
              const thk = c.thk ?? c.cutToThk ?? c.toThk ?? c;
              const sh = c.sh ?? c.factor ?? c.frac ?? null;
              const shTxt = (sh !== null && sh !== undefined && isFinite(sh) && Number(sh) !== 1) ? ` (${Number(sh).toFixed(1)} sh)` : '';
              iso += `<li>${formatThkLabel(material, thk)} mm${shTxt}</li>`;
            });
            iso += `</ul>`;
          });
          iso += `<div class="isoFooter">Total plates: ${plates.length}</div>`;
          iso += `<div style="height:10px"></div>`;
        });
        // If we rendered something, override existing operator HTML
        if(iso.trim().length){
          viewAEl.innerHTML = iso;
        }
      }
    }
  }catch(e){}

}

// --- Preparation: auto-fill from Production programs (no extra calculations; derived from current inputs) ---
function __toNum(v){
  if(v===null||v===undefined) return NaN;
  const t = String(v).trim().replace(',', '.');
  if(!t) return NaN;
  const n = Number(t);
  return isFinite(n) ? n : NaN;
}
function __fmtMm(n){
  if(!isFinite(n)) return "—";
  // show 1 decimal only if needed
  const r = Math.round(n*10)/10;
  return (Math.abs(r - Math.round(r)) < 1e-9) ? String(Math.round(r)) : String(r);
}

// Quantity formatting (no unit)
function __fmtQty(n){
  if(!isFinite(n)) return "—";
  const r = Math.round(n*100)/100; // up to 2 decimals
  return (Math.abs(r - Math.round(r)) < 1e-9) ? String(Math.round(r)) : String(r);
}
function __stockThkFor(material, color){
  const m = String(material||"").trim().toLowerCase();
  const c = String(color||"").trim().toLowerCase();
  if(!m) return NaN;

  // Prefer exact material+color match; fallback to material-only
  let rows = MATERIALS_DB.filter(r =>
    String(r.Material||"").trim().toLowerCase() === m &&
    String(r.Color||"").trim().toLowerCase() === c
  );
  if(!rows.length){
    rows = MATERIALS_DB.filter(r => String(r.Material||"").trim().toLowerCase() === m);
  }
  const thks = rows.map(r => Number(r.Thickness_mm)).filter(x => isFinite(x) && x>0);
  if(!thks.length) return NaN;
  return Math.max.apply(null, thks);
}

function renderPreparationFromPrograms(){
  const prep = document.getElementById("prep");
  if(!prep) return;

  if(!Array.isArray(items) || !items.length){
    prep.innerHTML = `<div class="card"><div class="muted">No programs.</div></div>`;
    return;
  }

  // Preparation Qty rule:
  //   Qty (preparation list) = Qty(total) / Qty(program P/Sh)
  const totalQty = __toNum(document.getElementById("qtyTotal")?.value);

  // Build adjusted thickness per program
  const rows = [];
  items.forEach((it, ii)=>{
    const layer = Math.min(3, Math.max(1, parseInt(it.layer||1,10)||1));
    const itemNo = (it.itemNo||"").trim() || "—";

    // Base adjusted thickness per layer
    const base = [];
    for(let ri=0; ri<layer; ri++){
      const r = (it.rows && it.rows[ri]) ? it.rows[ri] : {};
      const mat = (r.material||"").trim();
      const col = (r.color||"").trim();
      const req = __toNum(r.thk);
      const qty = __toNum(r.psh);
      const stock = __stockThkFor(mat, col);

      let addMulti = 0;
      if(isFinite(req) && isFinite(stock) && stock>0){
        const k = Math.floor(req / stock); // "how many times bigger" (integer part)
        if(k>0) addMulti = k * 0;
      }
      const prepThk = isFinite(req) ? (req + addMulti) : NaN;

      base.push({ri, mat, col, req, qty, stock, addMulti, prepThk, extra:0});
    }

    // Extra allowance for multi-layer: +0.5 (2 layers) or +1.0 (3 layers) to the thickest layer
    const extra = 0; // was 0.5/1.0 by layers
    if(extra>0){
      let maxIdx = 0;
      let maxVal = -Infinity;
      base.forEach((b, idx)=>{
        const v = isFinite(b.prepThk) ? b.prepThk : -Infinity;
        if(v > maxVal){ maxVal = v; maxIdx = idx; }
      });
      if(base[maxIdx]) base[maxIdx].extra = extra;
    }

    base.forEach((b)=>{
      // Qty (prep) = Qty(total) / P/Sh (program)
      const prepQty = (isFinite(totalQty) && isFinite(b.qty) && b.qty>0) ? (totalQty / b.qty) : NaN;
      rows.push({
        pr: (window.__PRMODE==='STD' ? String(ii+1) : (String(idx+1))),
        itemNo,
        layer: `L${b.ri+1}/${layer}`,
        mat: b.mat || "—",
        col: b.col || "—",
        req: b.req,
        stock: b.stock,
        addMulti: b.addMulti,
        extra: b.extra,
        prepThk: (isFinite(b.prepThk) ? (b.prepThk + (b.extra||0)) : NaN),
        qty: prepQty
      });
    });
  });

  if(!rows.length){
    prep.innerHTML = `<div class="card"><div class="muted">Nothing to prepare yet.</div></div>`;
    return;
  }

  const tableRows = rows.map(r=>{ 
    const qtyTxt = isFinite(r.qty) ? __fmtQty(r.qty) : "—";
    return `
      <tr>
        <td>${esc(r.pr)}</td>
        <td>${esc(r.itemNo)}</td>
        <td>${esc(r.layer)}</td>
        <td style="white-space:normal;">${esc(r.mat)}</td>
        <td style="white-space:normal;">${esc(r.col)}</td>
        <td style="text-align:right;">${thkLabel(r.mat, n(r.prepThk))}</td>
                <td style="text-align:right;">${qtyTxt}</td>
      </tr>`;
  }).join("");

  prep.innerHTML = `
    <div class="card">
      <div class="filterTitle" style="margin-bottom:10px;">
        <span class="filter-title">Preparation list</span>
      </div>

      <div class="tableWrap" style="padding:0;">
        <table class="simpleTable prepTable" style="width:100%; border-collapse:separate; border-spacing:0; font-size:13px;">
          <thead>
            <tr>
              <th style="text-align:left;">#</th>
              <th style="text-align:left;">Item</th>
              <th style="text-align:left;">Layer</th>
              <th style="text-align:left;">Material</th>
              <th style="text-align:left;">Color</th>
              <th style="text-align:right;">Thk</th>
                            <th style="text-align:right;">Qty</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px; line-height:1.35;">
        </b>.
      </div>
    </div>`;

  try{ fitPrepTable(); }catch(e){}
}






  // Bind toggle button (no recalculation; just switch visible view)
  (function(){
    function bind(){
      const btn = document.getElementById("matPickToggleBtn");
      if(btn && !btn.__bound){
        btn.addEventListener("click", toggleMatPickMode);
        btn.__bound = true;
      }
    }
    if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", bind);
    else bind();
  })();

  function validate(){
    const calcCard = document.getElementById('calcCard');
    if(!calcCard) return true;

    cleanInvalid();

    const candidates = Array.from(document.querySelectorAll('input, select, textarea'))
      .filter(el => {
        // In Compact mode some program fields can be collapsed (not visible),
        // but they must still be validated for "Расчёт".
        const inPrograms = !!(el.closest && (el.closest('#programsWrap') || el.closest('#programList')));
        return isVisible(el) || inPrograms;
      })
      .filter(el => !el.disabled)
      .filter(el => el.type !== 'button' && el.type !== 'submit' && el.type !== 'reset')
      .filter(el => isBefore(el, calcCard));

    // Exclusions: non-required textareas (notes) if any appear later
    const required = candidates.filter(el => {
      if(el.tagName === 'TEXTAREA') return false;
      if(el.closest && el.closest('#filterBox')) return false;
      if(el.id === 'orderSub') return false; // Sub is optional
 // notes are optional by default
      // auto-disabled color selects are already filtered by disabled
      return true;
    });

    const missing = [];
    for(const el of required){
      // itemNoInput is readonly, but required
      const val = (el.value || '').trim();
      const ok = !!val;
      if(!ok){
        el.classList.add('invalidField');
        missing.push(fieldLabel(el));
      }
    }

    const okBox = document.getElementById('calcOk');
    const errBox = document.getElementById('calcErr');
    const list = document.getElementById('calcErrList');

    // Thickness feasibility is handled by auto-lamination planner during calculation.



    // Model-level validation (works even when positions are collapsed in Compact)
    let firstInvalidIndex = null;
    if (Array.isArray(items)) {
      items.forEach((it, idx) => {
        const layers = Math.max(1, parseInt(it.layer, 10) || 1);
        const itemNo = (it.itemNo ?? '').toString().trim();
        if (!itemNo) {
          missing.push('Item No. (pos ' + (idx + 1) + ')');
          if (firstInvalidIndex === null) firstInvalidIndex = idx;
        }
        for (let r = 0; r < layers; r++) {
          const row = (it.rows && it.rows[r]) ? it.rows[r] : {};
          const mat = (row.material ?? '').toString().trim();
          const col = (row.color ?? '').toString().trim();
          const thk = (row.thk ?? '').toString().trim();
          const psh = (row.psh ?? '').toString().trim();
          if (!mat) { missing.push('Material (pos ' + (idx + 1) + ', layer ' + (r + 1) + ')'); if (firstInvalidIndex === null) firstInvalidIndex = idx; }
          if (!col) { missing.push('Color (pos ' + (idx + 1) + ', layer ' + (r + 1) + ')'); if (firstInvalidIndex === null) firstInvalidIndex = idx; }
          if (!thk) { missing.push('Thickness (pos ' + (idx + 1) + ', layer ' + (r + 1) + ')'); if (firstInvalidIndex === null) firstInvalidIndex = idx; }
          if (!psh) { missing.push('Out per plate (pos ' + (idx + 1) + ', layer ' + (r + 1) + ')'); if (firstInvalidIndex === null) firstInvalidIndex = idx; }
        }
      });
    }

    // In Compact mode: auto-open the first invalid position so you can fix it quickly
    if (firstInvalidIndex !== null && posViewMode === 'compact') {
      posCompactExpandedIndex = firstInvalidIndex;
      try { localStorage.setItem('posCompactExpandedIndex', String(posCompactExpandedIndex)); } catch (e) {}
      applyPosView();
      const cards = document.querySelectorAll('#items .itemCard');
      if (cards && cards[firstInvalidIndex]) {
        cards[firstInvalidIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
if(missing.length){
      if(list){
        list.innerHTML = '';
        missing.forEach(t=>{
          const li = document.createElement('li');
          li.textContent = t;
          list.appendChild(li);
        });
      }
      if(errBox) errBox.style.display = 'block';
      const cutRoot = document.getElementById("cutList");
      if(cutRoot) cutRoot.innerHTML = "";
      const vA = document.getElementById("matPickViewA");
      const vB = document.getElementById("matPickViewB");
      if(vA) vA.innerHTML = "";
      if(vB) vB.innerHTML = "";
      const prep = document.getElementById("prep");
      if(prep) prep.innerHTML = "";
      return false;
    }else{
      if(okBox) okBox.style.display = 'block';
      // Reset output placeholders (no recalculation here; only UI containers)
      try{
        const vA = document.getElementById("matPickViewA");
        const vB = document.getElementById("matPickViewB");
        if(vA) vA.innerHTML = "";
        if(vB) vB.innerHTML = "";
        const prep = document.getElementById("prep");
        if(prep) prep.innerHTML = "";
      }catch(e){}
      // Build grouped cut list
      try{ buildCutList(); }catch(e){}
      return true;
    }
  }

  function bind(){
    // Filter materials UI (optional; affects solver stock thickness)
    try{ bindFilterUI(); }catch(e){}

    const btn = document.getElementById('btnCalc');
    if(!btn) return;
    btn.addEventListener('click', validate);

    // Clear red highlight on user input
    document.addEventListener('input', (e)=>{
      const t = e.target;
      if(t && t.classList && t.classList.contains('invalidField')){
        t.classList.remove('invalidField');
      }
    }, {passive:true});
    document.addEventListener('change', (e)=>{
      const t = e.target;
      if(t && t.classList && t.classList.contains('invalidField')){
        t.classList.remove('invalidField');
      }
    }, {passive:true});
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind);
  else bind();
})();


function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<!-- Item No Picker Modal -->
<div aria-label="Item No Picker" aria-modal="true" id="itemNoPickerModal" role="dialog">
<div id="itemNoPickerPanel">
<div class="itemNoTopBar">
<div id="itemNoPickerTitle">Select Item No.</div>
<div class="itemNoTopBtns">
<button class="topMiniBtn" id="itemNoPickerHideBtn" type="button">Hide</button>
<button class="topMiniBtn" id="itemNoPickerUnhideBtn" type="button">Unhide</button>
</div>
</div>
<div id="itemNoPickerGrid"></div>
<div id="itemNoPickerActions">
<button class="danger" id="itemNoPickerClearBtn" type="button">Clear</button>
<button class="primary" id="itemNoPickerDoneBtn" type="button">Done</button>
</div>
</div>
</div>
<script>
// === Collapse / Expand program by clicking PR label ===
document.addEventListener('click', function(e){
  const idx = e.target.closest('.itemIndex');
  if(!idx) return;
  const card = idx.closest('.card');
  if(!card) return;
  const body = card.querySelector('.tableWrap');
  if(!body) return;
  const hidden = body.style.display === 'none';
  body.style.display = hidden ? '' : 'none';
  idx.style.opacity = hidden ? '1' : '0.6';
});

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
</div>
<div aria-hidden="true" class="helpModal" id="helpModal">
  <div aria-labelledby="helpModalTitle" aria-modal="true" class="helpModalContent" role="dialog">
    <div class="helpModalHeader">
      <div class="helpModalTitle" id="helpModalTitle">Help</div>
      <button aria-label="Close" class="helpModalClose" id="helpModalClose" type="button">✕</button>
    </div>

    <div class="helpTabs" role="tablist" aria-label="Help sections">
      <button class="helpTab active" type="button" data-help="overview" role="tab" aria-selected="true">Overview</button>
      <button class="helpTab" type="button" data-help="import" role="tab" aria-selected="false">Import</button>
      <button class="helpTab" type="button" data-help="programs" role="tab" aria-selected="false">Programs</button>
      <button class="helpTab" type="button" data-help="outperplate" role="tab" aria-selected="false">Out/plate</button>
      <button class="helpTab" type="button" data-help="print" role="tab" aria-selected="false">Print</button>
    </div>

    <div class="helpModalText" id="helpModalText">
<h3>Overview</h3>
<p><strong>Material &amp; Lamination Planner</strong> is a working tool for preparing, validating, and printing cutting and lamination jobs (Waterjet / Cutting).</p>
<p>The application works locally in the browser and does not store any data on a server.</p>

<h3>Order &amp; Header</h3>
<p><strong>Order</strong> and <strong>Sub</strong> are optional identifiers of the job.</p>
<ul>
<li>If a field is empty, it is not shown in print.</li>
<li>The dash between Order and Sub appears only if both fields are filled.</li>
</ul>

<h3>Qty (total)</h3>
<p>Reference quantity for the order. If empty, it is ignored in print.</p>

<h3>Out per plate</h3>
<p>Defines how many parts are produced from one plate.</p>
<ul>
<li><strong>Var</strong> – value is set individually per position.</li>
<li><strong>1–9</strong> – fixed value applied to all positions and locked.</li>
</ul>

<h3>Positions / Programs</h3>
<p>Each position represents one cutting program.</p>
<ul>
<li><strong>Item</strong> – automatically assigned sequential number.</li>
<li><strong>Material</strong> – selected from the material database.</li>
<li><strong>Color</strong> – depends on selected material.</li>
<li><strong>Thickness</strong> – see details below.</li>
<li><strong>Out per plate</strong> – quantity per plate.</li>
</ul>

<h3>Thickness (important)</h3>
<p>Thickness handling depends on material type:</p>
<ul>
<li>Standard materials use a single thickness value.</li>
<li><strong>Noppe materials are displayed as X / Y</strong>, where:</li>
<ul>
<li><strong>Y</strong> = real thickness (used in all calculations).</li>
<li><strong>X</strong> = Y / 2 (visual / layered representation).</li>
</ul>
</ul>
<p>Calculations always use <strong>Y (real thickness)</strong>. The X / Y format is display only.</p>

<h3>Import list</h3>
<p>Allows fast creation of positions from text (OCR or copied lists).</p>
<ul>
<li>Each line creates one position.</li>
<li>Material and Color are case-insensitive.</li>
<li>Noppe is detected automatically by thickness format (e.g. 15/30).</li>
<li>Items are numbered in import order.</li>
</ul>

<h3>Validation &amp; Calculate</h3>
<p>The Calculate function validates all positions, including collapsed ones (Compact mode).</p>
<p>If errors exist, calculation is blocked until fixed.</p>

<h3>Material to pick</h3>
<p>Shows aggregated material requirements, typically in Plate sum mode.</p>

<h3>Print</h3>
<p>Print view expands all positions and hides controls and help elements.</p>
<p>Only filled fields are printed.</p>
</div>
  </div>
</div>
<script>
(function(){
  const btn = document.getElementById('helpBtn');
  const modal = document.getElementById('helpModal');
  const closeBtn = document.getElementById('helpModalClose');
  const textEl = document.getElementById('helpModalText');
  const tabs = Array.from(document.querySelectorAll('.helpTab'));
  let accordionBuilt = false;

  // English placeholder for now (as requested). You can replace texts later.
  const HELP_TEXT = {
    overview: '
<h3>Overview</h3>
<p><strong>Material &amp; Lamination Planner</strong> is a working tool for preparing, validating, and printing cutting and lamination jobs (Waterjet / Cutting).</p>
<p>The application works locally in the browser and does not store any data on a server.</p>

<h3>Order &amp; Header</h3>
<p><strong>Order</strong> and <strong>Sub</strong> are optional identifiers of the job.</p>
<ul>
<li>If a field is empty, it is not shown in print.</li>
<li>The dash between Order and Sub appears only if both fields are filled.</li>
</ul>

<h3>Qty (total)</h3>
<p>Reference quantity for the order. If empty, it is ignored in print.</p>

<h3>Out per plate</h3>
<p>Defines how many parts are produced from one plate.</p>
<ul>
<li><strong>Var</strong> – value is set individually per position.</li>
<li><strong>1–9</strong> – fixed value applied to all positions and locked.</li>
</ul>

<h3>Positions / Programs</h3>
<p>Each position represents one cutting program.</p>
<ul>
<li><strong>Item</strong> – automatically assigned sequential number.</li>
<li><strong>Material</strong> – selected from the material database.</li>
<li><strong>Color</strong> – depends on selected material.</li>
<li><strong>Thickness</strong> – see details below.</li>
<li><strong>Out per plate</strong> – quantity per plate.</li>
</ul>

<h3>Thickness (important)</h3>
<p>Thickness handling depends on material type:</p>
<ul>
<li>Standard materials use a single thickness value.</li>
<li><strong>Noppe materials are displayed as X / Y</strong>, where:</li>
<ul>
<li><strong>Y</strong> = real thickness (used in all calculations).</li>
<li><strong>X</strong> = Y / 2 (visual / layered representation).</li>
</ul>
</ul>
<p>Calculations always use <strong>Y (real thickness)</strong>. The X / Y format is display only.</p>

<h3>Import list</h3>
<p>Allows fast creation of positions from text (OCR or copied lists).</p>
<ul>
<li>Each line creates one position.</li>
<li>Material and Color are case-insensitive.</li>
<li>Noppe is detected automatically by thickness format (e.g. 15/30).</li>
<li>Items are numbered in import order.</li>
</ul>

<h3>Validation &amp; Calculate</h3>
<p>The Calculate function validates all positions, including collapsed ones (Compact mode).</p>
<p>If errors exist, calculation is blocked until fixed.</p>

<h3>Material to pick</h3>
<p>Shows aggregated material requirements, typically in Plate sum mode.</p>

<h3>Print</h3>
<p>Print view expands all positions and hides controls and help elements.</p>
<p>Only filled fields are printed.</p>
',
    import: '
<h3>Overview</h3>
<p><strong>Material &amp; Lamination Planner</strong> is a working tool for preparing, validating, and printing cutting and lamination jobs (Waterjet / Cutting).</p>
<p>The application works locally in the browser and does not store any data on a server.</p>

<h3>Order &amp; Header</h3>
<p><strong>Order</strong> and <strong>Sub</strong> are optional identifiers of the job.</p>
<ul>
<li>If a field is empty, it is not shown in print.</li>
<li>The dash between Order and Sub appears only if both fields are filled.</li>
</ul>

<h3>Qty (total)</h3>
<p>Reference quantity for the order. If empty, it is ignored in print.</p>

<h3>Out per plate</h3>
<p>Defines how many parts are produced from one plate.</p>
<ul>
<li><strong>Var</strong> – value is set individually per position.</li>
<li><strong>1–9</strong> – fixed value applied to all positions and locked.</li>
</ul>

<h3>Positions / Programs</h3>
<p>Each position represents one cutting program.</p>
<ul>
<li><strong>Item</strong> – automatically assigned sequential number.</li>
<li><strong>Material</strong> – selected from the material database.</li>
<li><strong>Color</strong> – depends on selected material.</li>
<li><strong>Thickness</strong> – see details below.</li>
<li><strong>Out per plate</strong> – quantity per plate.</li>
</ul>

<h3>Thickness (important)</h3>
<p>Thickness handling depends on material type:</p>
<ul>
<li>Standard materials use a single thickness value.</li>
<li><strong>Noppe materials are displayed as X / Y</strong>, where:</li>
<ul>
<li><strong>Y</strong> = real thickness (used in all calculations).</li>
<li><strong>X</strong> = Y / 2 (visual / layered representation).</li>
</ul>
</ul>
<p>Calculations always use <strong>Y (real thickness)</strong>. The X / Y format is display only.</p>

<h3>Import list</h3>
<p>Allows fast creation of positions from text (OCR or copied lists).</p>
<ul>
<li>Each line creates one position.</li>
<li>Material and Color are case-insensitive.</li>
<li>Noppe is detected automatically by thickness format (e.g. 15/30).</li>
<li>Items are numbered in import order.</li>
</ul>

<h3>Validation &amp; Calculate</h3>
<p>The Calculate function validates all positions, including collapsed ones (Compact mode).</p>
<p>If errors exist, calculation is blocked until fixed.</p>

<h3>Material to pick</h3>
<p>Shows aggregated material requirements, typically in Plate sum mode.</p>

<h3>Print</h3>
<p>Print view expands all positions and hides controls and help elements.</p>
<p>Only filled fields are printed.</p>
',
    programs: '
<h3>Overview</h3>
<p><strong>Material &amp; Lamination Planner</strong> is a working tool for preparing, validating, and printing cutting and lamination jobs (Waterjet / Cutting).</p>
<p>The application works locally in the browser and does not store any data on a server.</p>

<h3>Order &amp; Header</h3>
<p><strong>Order</strong> and <strong>Sub</strong> are optional identifiers of the job.</p>
<ul>
<li>If a field is empty, it is not shown in print.</li>
<li>The dash between Order and Sub appears only if both fields are filled.</li>
</ul>

<h3>Qty (total)</h3>
<p>Reference quantity for the order. If empty, it is ignored in print.</p>

<h3>Out per plate</h3>
<p>Defines how many parts are produced from one plate.</p>
<ul>
<li><strong>Var</strong> – value is set individually per position.</li>
<li><strong>1–9</strong> – fixed value applied to all positions and locked.</li>
</ul>

<h3>Positions / Programs</h3>
<p>Each position represents one cutting program.</p>
<ul>
<li><strong>Item</strong> – automatically assigned sequential number.</li>
<li><strong>Material</strong> – selected from the material database.</li>
<li><strong>Color</strong> – depends on selected material.</li>
<li><strong>Thickness</strong> – see details below.</li>
<li><strong>Out per plate</strong> – quantity per plate.</li>
</ul>

<h3>Thickness (important)</h3>
<p>Thickness handling depends on material type:</p>
<ul>
<li>Standard materials use a single thickness value.</li>
<li><strong>Noppe materials are displayed as X / Y</strong>, where:</li>
<ul>
<li><strong>Y</strong> = real thickness (used in all calculations).</li>
<li><strong>X</strong> = Y / 2 (visual / layered representation).</li>
</ul>
</ul>
<p>Calculations always use <strong>Y (real thickness)</strong>. The X / Y format is display only.</p>

<h3>Import list</h3>
<p>Allows fast creation of positions from text (OCR or copied lists).</p>
<ul>
<li>Each line creates one position.</li>
<li>Material and Color are case-insensitive.</li>
<li>Noppe is detected automatically by thickness format (e.g. 15/30).</li>
<li>Items are numbered in import order.</li>
</ul>

<h3>Validation &amp; Calculate</h3>
<p>The Calculate function validates all positions, including collapsed ones (Compact mode).</p>
<p>If errors exist, calculation is blocked until fixed.</p>

<h3>Material to pick</h3>
<p>Shows aggregated material requirements, typically in Plate sum mode.</p>

<h3>Print</h3>
<p>Print view expands all positions and hides controls and help elements.</p>
<p>Only filled fields are printed.</p>
',
    outperplate: '
<h3>Overview</h3>
<p><strong>Material &amp; Lamination Planner</strong> is a working tool for preparing, validating, and printing cutting and lamination jobs (Waterjet / Cutting).</p>
<p>The application works locally in the browser and does not store any data on a server.</p>

<h3>Order &amp; Header</h3>
<p><strong>Order</strong> and <strong>Sub</strong> are optional identifiers of the job.</p>
<ul>
<li>If a field is empty, it is not shown in print.</li>
<li>The dash between Order and Sub appears only if both fields are filled.</li>
</ul>

<h3>Qty (total)</h3>
<p>Reference quantity for the order. If empty, it is ignored in print.</p>

<h3>Out per plate</h3>
<p>Defines how many parts are produced from one plate.</p>
<ul>
<li><strong>Var</strong> – value is set individually per position.</li>
<li><strong>1–9</strong> – fixed value applied to all positions and locked.</li>
</ul>

<h3>Positions / Programs</h3>
<p>Each position represents one cutting program.</p>
<ul>
<li><strong>Item</strong> – automatically assigned sequential number.</li>
<li><strong>Material</strong> – selected from the material database.</li>
<li><strong>Color</strong> – depends on selected material.</li>
<li><strong>Thickness</strong> – see details below.</li>
<li><strong>Out per plate</strong> – quantity per plate.</li>
</ul>

<h3>Thickness (important)</h3>
<p>Thickness handling depends on material type:</p>
<ul>
<li>Standard materials use a single thickness value.</li>
<li><strong>Noppe materials are displayed as X / Y</strong>, where:</li>
<ul>
<li><strong>Y</strong> = real thickness (used in all calculations).</li>
<li><strong>X</strong> = Y / 2 (visual / layered representation).</li>
</ul>
</ul>
<p>Calculations always use <strong>Y (real thickness)</strong>. The X / Y format is display only.</p>

<h3>Import list</h3>
<p>Allows fast creation of positions from text (OCR or copied lists).</p>
<ul>
<li>Each line creates one position.</li>
<li>Material and Color are case-insensitive.</li>
<li>Noppe is detected automatically by thickness format (e.g. 15/30).</li>
<li>Items are numbered in import order.</li>
</ul>

<h3>Validation &amp; Calculate</h3>
<p>The Calculate function validates all positions, including collapsed ones (Compact mode).</p>
<p>If errors exist, calculation is blocked until fixed.</p>

<h3>Material to pick</h3>
<p>Shows aggregated material requirements, typically in Plate sum mode.</p>

<h3>Print</h3>
<p>Print view expands all positions and hides controls and help elements.</p>
<p>Only filled fields are printed.</p>
',
    print: '
<h3>Overview</h3>
<p><strong>Material &amp; Lamination Planner</strong> is a working tool for preparing, validating, and printing cutting and lamination jobs (Waterjet / Cutting).</p>
<p>The application works locally in the browser and does not store any data on a server.</p>

<h3>Order &amp; Header</h3>
<p><strong>Order</strong> and <strong>Sub</strong> are optional identifiers of the job.</p>
<ul>
<li>If a field is empty, it is not shown in print.</li>
<li>The dash between Order and Sub appears only if both fields are filled.</li>
</ul>

<h3>Qty (total)</h3>
<p>Reference quantity for the order. If empty, it is ignored in print.</p>

<h3>Out per plate</h3>
<p>Defines how many parts are produced from one plate.</p>
<ul>
<li><strong>Var</strong> – value is set individually per position.</li>
<li><strong>1–9</strong> – fixed value applied to all positions and locked.</li>
</ul>

<h3>Positions / Programs</h3>
<p>Each position represents one cutting program.</p>
<ul>
<li><strong>Item</strong> – automatically assigned sequential number.</li>
<li><strong>Material</strong> – selected from the material database.</li>
<li><strong>Color</strong> – depends on selected material.</li>
<li><strong>Thickness</strong> – see details below.</li>
<li><strong>Out per plate</strong> – quantity per plate.</li>
</ul>

<h3>Thickness (important)</h3>
<p>Thickness handling depends on material type:</p>
<ul>
<li>Standard materials use a single thickness value.</li>
<li><strong>Noppe materials are displayed as X / Y</strong>, where:</li>
<ul>
<li><strong>Y</strong> = real thickness (used in all calculations).</li>
<li><strong>X</strong> = Y / 2 (visual / layered representation).</li>
</ul>
</ul>
<p>Calculations always use <strong>Y (real thickness)</strong>. The X / Y format is display only.</p>

<h3>Import list</h3>
<p>Allows fast creation of positions from text (OCR or copied lists).</p>
<ul>
<li>Each line creates one position.</li>
<li>Material and Color are case-insensitive.</li>
<li>Noppe is detected automatically by thickness format (e.g. 15/30).</li>
<li>Items are numbered in import order.</li>
</ul>

<h3>Validation &amp; Calculate</h3>
<p>The Calculate function validates all positions, including collapsed ones (Compact mode).</p>
<p>If errors exist, calculation is blocked until fixed.</p>

<h3>Material to pick</h3>
<p>Shows aggregated material requirements, typically in Plate sum mode.</p>

<h3>Print</h3>
<p>Print view expands all positions and hides controls and help elements.</p>
<p>Only filled fields are printed.</p>
'
  };

  function buildAccordionFromH3(){
    if(accordionBuilt || !textEl) return;
    // Expect content with <h3>Section</h3> blocks
    const tmp = document.createElement('div');
    tmp.innerHTML = textEl.innerHTML;
    const nodes = Array.from(tmp.childNodes).filter(n=>!(n.nodeType===3 && !n.textContent.trim()));
    const sections = [];
    let current = null;
    for(const n of nodes){
      if(n.nodeType===1 && n.tagName.toLowerCase()==='h3'){
        if(current) sections.push(current);
        current = { title: n.textContent.trim(), html: '' };
      } else {
        if(!current){
          current = { title: 'Help', html: '' };
        }
        current.html += (n.outerHTML || n.textContent);
      }
    }
    if(current) sections.push(current);

    const acc = document.createElement('div');
    acc.className = 'helpAccordion';

    sections.forEach((s, idx)=>{
      const item = document.createElement('div');
      item.className = 'accItem' + (idx===0 ? ' open' : '');
      const header = document.createElement('button');
      header.type = 'button';
      header.className = 'accHeader';
      header.innerHTML = `<span>${s.title}</span><span class="accChevron">▾</span>`;
      const panel = document.createElement('div');
      panel.className = 'accPanel';
      panel.innerHTML = s.html;
      header.addEventListener('click', ()=>{
        // close others
        acc.querySelectorAll('.accItem').forEach(el=>{ if(el!==item) el.classList.remove('open'); });
        item.classList.toggle('open');
      });
      item.appendChild(header);
      item.appendChild(panel);
      acc.appendChild(item);
    });

    textEl.innerHTML = '';
    textEl.appendChild(acc);
    accordionBuilt = true;
  }

  function setSection(key){
    if(!textEl) return;
    const html = HELP_TEXT[key] ?? HELP_TEXT.overview;
    textEl.innerHTML = html;
    // Build accordion once (improves scrolling and readability on iPhone)
    buildAccordionFromH3();
    tabs.forEach(t=>{
      const active = t.dataset.help === key;
      t.classList.toggle('active', active);
      t.setAttribute('aria-selected', active ? 'true' : 'false');
    });
  }

  // default section
  setSection('overview');

  function open(){
    if(!modal) return;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
    // reset to overview each time
    setSection('overview');
  }
  function close(){
    if(!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
  }
  if(btn) btn.addEventListener('click', open);
  if(closeBtn) closeBtn.addEventListener('click', close);
  if(modal) modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });

  tabs.forEach(t=>{
    t.addEventListener('click', ()=> setSection(t.dataset.help));
  });
})();

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<script>
(function(){
  function bindCutCheckboxes(){
    const cutRoot = document.getElementById('cutList');
    if(!cutRoot || cutRoot.__cutChkBound) return;
    cutRoot.__cutChkBound = true;

    cutRoot.addEventListener('change', function(e){
      const t = e.target;
      if(!(t && t.classList && t.classList.contains('cutChk'))) return;
      const grp = t.closest('.cutGroup');
      if(!grp) return;
      if(t.checked) grp.classList.add('done');
      else grp.classList.remove('done');
    }, true);
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bindCutCheckboxes);
  }else{
    bindCutCheckboxes();
  }
})();

/* --- FIX: Always show Operator ISO view after Calculate --- */
function __setMatPickMode(mode){
  const viewA = document.getElementById('matPickViewA');
  const viewB = document.getElementById('matPickViewB');
  const btn = document.getElementById('btnPlateSum');
  if(!viewA || !viewB || !btn) return;
  if(mode === 'summary'){
    viewA.style.display = 'none';
    viewB.style.display = 'block';
    btn.textContent = 'Back';
    btn.dataset.mode = 'summary';
  } else {
    viewA.style.display = 'block';
    viewB.style.display = 'none';
    btn.textContent = 'Plate sum';
    btn.dataset.mode = 'operator';
  }
}



/* --- Preparation (reserved) ---
   Intentionally not wired into Calculate yet (to avoid breaking stable logic).
   Future: build a copy-friendly checklist from existing output structures.
*/
function renderPreparationPlaceholder(){
  const el = document.getElementById('prepBody');
  if(!el) return;
  // Keep placeholder as-is for now.
}


function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<!-- ============================= -->
<!-- 6️⃣ Preparation (OUTPUT)       -->
<!-- RESERVED: will be implemented -->
<!-- ============================= -->
<script>
(function(){

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('*').forEach(el => {
    if (el.textContent && el.textContent.trim() === 'Thk') el.textContent = 'Thickness';
    if (el.textContent && el.textContent.trim() === 'P/Sh') el.textContent = 'Out per plate';
  });
});

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<script>
/* FORCE header font -2px for Material/Color/Thickness/Out per plate */
document.addEventListener('DOMContentLoaded', () => {
  const labels = ['Material','Color','Thickness','Out per plate'];
  document.querySelectorAll('#items .gridHeader *').forEach(el => {
    if (labels.includes(el.textContent.trim())) {
      const cs = window.getComputedStyle(el);
      const size = parseFloat(cs.fontSize);
      if (!isNaN(size)) el.style.fontSize = (size - 3) + 'px';
      el.style.lineHeight = '1.0';
    }
  });
});

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<script>
/* === STD / 1L mode – safe (wrap addItem; no MutationObserver) === */
(function(){
  var mode = 'STD';
  window.__PRMODE = mode;
  var btnStd = document.getElementById('btnModeStd');
  var btn1L  = document.getElementById('btnMode1L');
  var items  = document.getElementById('items');
  var prevLayer = {};

  function getCards(){
    if(!items) return [];
    var a=[], c=items.children;
    for(var i=0;i<c.length;i++) a.push(c[i]);
    return a;
  }

  function setButtons(){
    if(btnStd) btnStd.className = 'modeBtn' + (mode==='STD'?' active':'');
    if(btn1L)  btn1L.className  = 'modeBtn' + (mode==='1L'?' active':'');
  }

  function setPR(card, idx) {
  const el = card.querySelector('.pr-label,.itemIndex');
  if (!el) return;
  el.textContent = String(idx + 1);
}

  function layerSelect(card){
    return card.querySelector('select.layerSel,select.layerSelect,select[name*="layer"],select[id*="layer"]');
  }

  function applyMode(){
    document.body.classList.toggle("mode1l", mode==="1L");
    window.__PRMODE = mode;
    var cards = getCards();
    if(cards.length===0){ setButtons(); return; }

    for(var i=0;i<cards.length;i++){
      var card = cards[i];
      var sel = layerSelect(card);

      if(mode==='1L'){
        setPR(card,i,false);
        if(sel){
          if(prevLayer[i]==null) prevLayer[i]=sel.value;
          if(typeof window.setLayer==='function'){
            try{ window.setLayer(i,'1'); }catch(e){}
          }
          sel.value='1';
          sel.disabled=true; sel.setAttribute('disabled','disabled');
        }
      }else{
        setPR(card,i,true);
        if(sel){
          sel.disabled=false; sel.removeAttribute('disabled');
          if(prevLayer[i]!=null){
            if(typeof window.setLayer==='function'){
              try{ window.setLayer(i,prevLayer[i]); }catch(e){}
            }else{
              sel.value=prevLayer[i];
            }
            delete prevLayer[i];
          }
        }
      }
    }
    if(document.body.classList.contains('fullPlate') && window.__applyFullPlate){
      setTimeout(function(){ window.__applyFullPlate(); },0);
    }
    setButtons();
  }

  function setMode(m){
    if(mode===m) return;
    mode=m;
    applyMode();
  }

  if(btnStd) btnStd.onclick=function(){
    setMode('STD');
    if(document.body.classList.contains('fullPlate') && window.__applyFullPlate){
      setTimeout(function(){ window.__applyFullPlate(); },0);
    }
  };
  if(btn1L)  btn1L.onclick=function(){
    setMode('1L');
    if(document.body.classList.contains('fullPlate') && window.__applyFullPlate){
      setTimeout(function(){ window.__applyFullPlate(); },0);
    }
  };

  if(typeof window.addItem==='function'){
    var _addItem=window.addItem;
    window.addItem=function(){
      var r=_addItem.apply(this,arguments);
      setTimeout(applyMode,0);
      return r;
    };
  }

  setButtons();
})();

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<script>
/* === Visual-only hook: toggle body.mode1l based on active button === */
(function(){
  function syncBodyClass(){
    var btn1L = document.getElementById('btnMode1L');
    if(!btn1L) return;
    var is1L = btn1L.classList && btn1L.classList.contains('active');
    document.body.classList.toggle('mode1l', !!is1L);
  }
  document.addEventListener('click', function(e){
    if(e.target && (e.target.id === 'btnModeStd' || e.target.id === 'btnMode1L')){
      setTimeout(syncBodyClass, 0);
    }
  });
  // initial sync
  setTimeout(syncBodyClass, 0);
})();

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<script>
/* === Auto Item numbering in 1L (uses existing grey+lock UI) === */
(function(){
  var prevItem = {};

  function getCards(){
    var items = document.getElementById('items');
    if(!items) return [];
    var a=[], c=items.children;
    for(var i=0;i<c.length;i++) a.push(c[i]);
    return a;
  }

  function getItemInput(card){
    return card.querySelector('.itemNoInput');
  }

  function applyItemAuto(){
    var is1L = document.body.classList && document.body.classList.contains('mode1l');
    var cards = getCards();
    for(var i=0;i<cards.length;i++){
      var inp = getItemInput(cards[i]);
      if(!inp) continue;

      if(is1L){
        if(prevItem[i] == null) prevItem[i] = inp.value;
        inp.value = String(i+1);
        inp.disabled = true;
        inp.setAttribute('disabled','disabled');
      }else{
        inp.disabled = false;
        inp.removeAttribute('disabled');
        if(prevItem[i] != null){
          inp.value = prevItem[i];
          delete prevItem[i];
        }
      }
    }
  }

  // react to mode button clicks
  document.addEventListener('click', function(e){
    if(e.target && (e.target.id === 'btnModeStd' || e.target.id === 'btnMode1L')){
      setTimeout(applyItemAuto, 0);
    }
  });

  // apply after adding program (do not override addItem)
  var addBtn = document.querySelector('.topbar .btn.primary');
  if(addBtn){
    addBtn.addEventListener('click', function(){
      setTimeout(applyItemAuto, 0);
    });
  }

  // initial
  setTimeout(applyItemAuto, 0);
})();

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<script>
/* === Auto Item numbering in 1L (syncs to data model via events) === */
(function(){
  var prevItem = {};

  function getCards(){
    var items = document.getElementById('items');
    if(!items) return [];
    var a=[], c=items.children;
    for(var i=0;i<c.length;i++) a.push(c[i]);
    return a;
  }

  function getItemInput(card){
    return card.querySelector('.itemNoInput');
  }

  function fire(el, type){
    try{
      var ev;
      if(typeof Event === 'function'){
        ev = new Event(type, {bubbles:true});
      } else {
        ev = document.createEvent('Event');
        ev.initEvent(type, true, true);
      }
      el.dispatchEvent(ev);
    }catch(e){}
  }

  function setValAndSync(inp, val){
    if(inp.value !== val){
      inp.value = val;
      // sync with any listeners/state
      fire(inp, 'input');
      fire(inp, 'change');
    }
  }

  function applyItemAuto(){
    var is1L = document.body.classList && document.body.classList.contains('mode1l');
    var cards = getCards();
    for(var i=0;i<cards.length;i++){
      var inp = getItemInput(cards[i]);
      if(!inp) continue;

      if(is1L){
        if(prevItem[i] == null) prevItem[i] = inp.value;
        setValAndSync(inp, String(i+1));
        inp.disabled = true;
        inp.setAttribute('disabled','disabled');
      }else{
        inp.disabled = false;
        inp.removeAttribute('disabled');
        if(prevItem[i] != null){
          setValAndSync(inp, prevItem[i]);
          delete prevItem[i];
        }
      }
    }
  }

  // react to mode button clicks
  document.addEventListener('click', function(e){
    if(e.target && (e.target.id === 'btnModeStd' || e.target.id === 'btnMode1L')){
      setTimeout(applyItemAuto, 0);
    }
  });

  // apply after adding program (do not override addItem)
  var addBtn = document.querySelector('.topbar .btn.primary');
  if(addBtn){
    addBtn.addEventListener('click', function(){
      setTimeout(applyItemAuto, 0);
    });
  }

  // also re-apply after delete (buttons inside cards)
  document.addEventListener('click', function(e){
    var t = e.target;
    if(t && t.classList && t.classList.contains('btnDelete')){
      setTimeout(applyItemAuto, 0);
    }
  });

  // initial
  setTimeout(applyItemAuto, 0);
})();

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<script>
/* === Auto Item numbering in 1L (syncs UI + underlying items[] model) === */
(function(){
  function hasMode1L(){
    return !!(document.body.classList && document.body.classList.contains('mode1l'));
  }

  function fire(el, type){
    try{
      var ev;
      if(typeof Event === 'function'){
        ev = new Event(type, {bubbles:true});
      } else {
        ev = document.createEvent('Event');
        ev.initEvent(type, true, true);
      }
      el.dispatchEvent(ev);
    }catch(e){}
  }

  function setValAndSync(inp, val){
    if(inp && inp.value !== val){
      inp.value = val;
      fire(inp,'input');
      fire(inp,'change');
    }
  }

  function getCards(){
    var itemsEl = document.getElementById('items');
    if(!itemsEl) return [];
    var a=[], c=itemsEl.children;
    for(var i=0;i<c.length;i++) a.push(c[i]);
    return a;
  }

  function applyItemAuto(){
    var is1L = hasMode1L();

    // 1) Sync underlying model: items[i].itemNo
    try{
      if(typeof items !== 'undefined' && items && items.length){
        for(var i=0;i<items.length;i++){
          if(is1L){
            // store previous on the item itself (stable across deletes)
            if(items[i]._prevItemNo == null) items[i]._prevItemNo = items[i].itemNo;
            items[i].itemNo = String(i+1);
          }else{
            if(items[i]._prevItemNo != null){
              items[i].itemNo = items[i]._prevItemNo;
              items[i]._prevItemNo = null;
              try{ delete items[i]._prevItemNo; }catch(e){}
            }
          }
        }
        // persist to storage (safe: uses existing save() if present)
        if(typeof save === 'function'){ try{ save(); }catch(e){} }
      }
    }catch(e){}

    // 2) Sync UI inputs: .itemNoInput + disabled state
    var cards = getCards();
    for(var j=0;j<cards.length;j++){
      var inp = cards[j].querySelector('.itemNoInput');
      if(!inp) continue;

      if(is1L){
        setValAndSync(inp, String(j+1));
        inp.disabled = true;
        inp.setAttribute('disabled','disabled');
      }else{
        inp.disabled = false;
        inp.removeAttribute('disabled');
        // restore UI from model if present
        try{
          if(typeof items !== 'undefined' && items && items[j] && items[j].itemNo != null){
            setValAndSync(inp, String(items[j].itemNo||""));
          }
        }catch(e){}
      }
    }
  }

  // Mode button clicks
  document.addEventListener('click', function(e){
    if(e.target && (e.target.id === 'btnModeStd' || e.target.id === 'btnMode1L')){
      setTimeout(applyItemAuto, 0);
    }
  });

  // After Add Position
  var addBtn = document.querySelector('.topbar .btn.primary');
  if(addBtn){
    addBtn.addEventListener('click', function(){
      setTimeout(applyItemAuto, 0);
    });
  }

  // After Delete (any delete button)
  document.addEventListener('click', function(e){
    var t = e.target;
    if(!t) return;
    // match common delete buttons
    if((t.classList && (t.classList.contains('btnDelete') || t.classList.contains('danger'))) || (t.textContent||"").trim().toLowerCase() === 'delete'){
      setTimeout(applyItemAuto, 0);
    }
  });

  // Before Calculate
  var btnCalc = document.getElementById('btnCalc');
  if(btnCalc){
    btnCalc.addEventListener('click', function(){
      // ensure model is in correct state at calc time
      applyItemAuto();
      // do not stop propagation
    }, true);
  }

  // Initial
  setTimeout(applyItemAuto, 0);
})();

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<script>
/* === Full plate mode: Out per plate = 1 everywhere + lock === */
(function(){
  var btn = document.getElementById('btnFullPlate');
    window.__isFullPlate = window.__isFullPlate || false;
  var prev = {}; // id -> previous value

  function isOn(){ return document.body.classList.contains('fullPlate'); }

  function setBtn(){
    if(!btn) return;
    btn.className = 'modeBtn' + (isOn() ? ' active' : '');
  }

  function pshInputs(){
    return Array.prototype.slice.call(document.querySelectorAll('input[id^="psh_"]'));
  }

  function apply(on){
      window.__isFullPlate = !!on;

    document.body.classList.toggle('fullPlate', !!on);
    setBtn();

    var inputs = pshInputs();
    for(var i=0;i<inputs.length;i++){
      var inp = inputs[i];
      var id = inp.id;
      if(!id) continue;

      if(on){
        if(prev[id] === undefined) prev[id] = inp.value;
        inp.value = '1';
        inp.disabled = true;
        inp.setAttribute('disabled','disabled');

        // sync model
        var m = id.match(/^psh_(\d+)_(\d+)$/);
        if(m && window.items){
          var ii = parseInt(m[1],10), ri = parseInt(m[2],10);
          if(!isNaN(ii) && !isNaN(ri) && items[ii]){
            if(!items[ii].rows) items[ii].rows = [];
            if(!items[ii].rows[ri] && typeof newRow === 'function') items[ii].rows[ri] = newRow();
            if(items[ii].rows[ri]) items[ii].rows[ri].psh = '1';
          }
        }
      }else{
        inp.disabled = false;
        inp.removeAttribute('disabled');
        if(prev[id] !== undefined){
          inp.value = prev[id];

          var m2 = id.match(/^psh_(\d+)_(\d+)$/);
          if(m2 && window.items){
            var ii2 = parseInt(m2[1],10), ri2 = parseInt(m2[2],10);
            if(!isNaN(ii2) && !isNaN(ri2) && items[ii2]){
              if(!items[ii2].rows) items[ii2].rows = [];
              if(!items[ii2].rows[ri2] && typeof newRow === 'function') items[ii2].rows[ri2] = newRow();
              if(items[ii2].rows[ri2]) items[ii2].rows[ri2].psh = prev[id];
            }
          }
          delete prev[id];
        }
      }
    }
    if(typeof save === 'function'){ try{ save(); }catch(e){} }
  }


  // Expose to other handlers (STD/1L toggles) so we can re-apply lock after re-render
  // expose helper so other handlers can re-apply lock
  window.__applyFullPlate = function(){
    try { if (isOn()) apply(true); } catch(e) {}
  };
  if(btn){
    
    // Prevent focusing/editing P/Sh inputs while Full plate is active (iOS may still show keyboard for readonly number inputs)
    document.addEventListener('focusin', function(e){
      if(!document.body.classList.contains('fullPlate')) return;
      var t = e.target;
      if(t && t.id && t.id.indexOf('psh_') === 0){
        try{ t.blur(); }catch(err){}
      }
    }, true);

    // Re-apply lock after mode switches (STD / 1L may re-render parts of UI)
    var btnStd = document.getElementById('btnModeStd');
    var btn1L  = document.getElementById('btnMode1L');
    function reapplyIfOn(){ if(isOn()) { apply(true); } }
    if(btnStd) btnStd.addEventListener('click', function(){ setTimeout(reapplyIfOn, 0); }, false);
    if(btn1L)  btn1L.addEventListener('click', function(){ setTimeout(reapplyIfOn, 0); }, false);

    // Re-apply lock after any UI re-render (Add Position, delete, mode switches, etc.)
    var root = document.getElementById('programsWrap') || document.getElementById('programList') || document.querySelector('.programsWrap') || document.body;
    var _t = null;
    try{
      var mo = new MutationObserver(function(){
        if(!isOn()) return;
        if(_t) clearTimeout(_t);
        _t = setTimeout(function(){ apply(true); }, 30);
      });
      mo.observe(root, {childList:true, subtree:true});
    }catch(e){}

    btn.addEventListener('click', function(){
      apply(!isOn());
    });
  }

  // ensure new programs respect Full plate
  var addBtn = document.querySelector('.topbar .btn.primary');
  if(addBtn){
    addBtn.addEventListener('click', function(){
      if(isOn()) setTimeout(function(){ apply(true); }, 0);
    });
  }

  setBtn();
})();

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<style id="overrideMetaLabelPlus2">
/* FINAL OVERRIDE (must be last): +2px for Order/QTY labels */



/* FORCE Qty (total) input text to align left */
input#qtyTotal,
input[name="qty"],
.qtyInput,
.metaQty input {
    text-align: left !important;
}


/* Center alignment for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center;
}


/* Force horizontal centering for Thickness column */
.preparation-table th:nth-child(6),
.preparation-table td:nth-child(6) {
    text-align: center !important;
}


/* Preparation list: increase row text size by +2px */
.preparation-table td {
    font-size: calc(100% + 2px);
}


/* Preparation list: rows font-size +2px */
.preparation-table tbody td {
    font-size: calc(100% + 2px);
}


/* === Header: tighter horizontal spacing (half gaps) === */
.meta-row.order-row,
.meta-row.qty-row {
  gap: 4px !important;
  justify-content: flex-start !important;
}

.meta-row.order-row .metaLabel,
.meta-row.qty-row .metaLabel {
  margin-right: 3px !important; /* half of previous 6px */
  flex: 0 0 auto !important;
  min-width: auto !important;
}

/* Keep inputs from stretching away from label */
.meta-row.order-row input,
.meta-row.qty-row input {
  flex: 0 0 auto !important;
}


/* === Header: halve input widths for Order # and Qty (total) === */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 50% !important;
}

.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 50% !important;
  max-width: 50% !important;
}


/* === Header: precise per-field widths === */
/* Order # input */
.meta-row.order-row input[type="text"],
.meta-row.order-row input[type="number"] {
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row input[type="text"],
.meta-row.qty-row input[type="number"] {
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: force exact widths via flex-basis (works even if .metaInput uses flex:1) === */
/* Order # first input (order number) */
.meta-row.order-row > input[type="text"]:first-of-type {
  flex: 0 0 140px !important;
  width: 140px !important;
  max-width: 140px !important;
}

/* Qty (total) input */
.meta-row.qty-row > input[type="text"],
.meta-row.qty-row > input[type="number"] {
  flex: 0 0 90px !important;
  width: 90px !important;
  max-width: 90px !important;
}


/* === Header: make ? button always visible (keep inside row) === */
.meta-row.order-row { 
  overflow: visible !important; 
  flex-wrap: nowrap !important;
}

/* Allow inputs to shrink inside flex row */
#orderMain, #orderSub { 
  min-width: 0 !important; 
  flex-shrink: 1 !important; 
}

/* Sub field: half width (compact) */
#orderSub {
  flex: 0 0 70px !important;
  width: 70px !important;
  max-width: 70px !important;
}

/* Help button: fixed small size */
#subHelpBtn, .helpBtn {
  flex: 0 0 34px !important;
  width: 34px !important;
  max-width: 34px !important;
  height: 34px !important;
  padding: 0 !important;
  line-height: 34px !important;
  border-radius: 10px !important;
  margin-left: 4px !important;
}


/* === Qty (total): center text inside input === */
#qtyTotal {
  text-align: center !important;
}

/* === Increase spacing between sub input and ? button (x4) === */
#orderSub {
  margin-right: 16px !important; /* was ~4px */
}


/* === Order row horizontal centering (final) === */
.meta-row.order-row {
  justify-content: center !important;
}


/* --- FIX: Center thickness value for MLF & Noppe --- */
.material-row[data-material*="MLF"] .thickness-input,
.material-row[data-material*="Noppe"] .thickness-input,
.material-row[data-material*="MLF"] select.thickness,
.material-row[data-material*="Noppe"] select.thickness {
    text-align: center;
}


/* --- Expand / Compact positions --- */
.ui-btn {
  margin-left: 6px;
  padding: 4px 8px;
  font-size: 12px;
}
.ui-btn.active {
  background: #000;
  color: #fff;
}
.program-row.compact-hidden .row-details {
  display: none;
}

</style>
<script>
document.addEventListener('click', function(e) {
  const btn = e.target.closest('[data-program="std"]');
  if (!btn) return;

  document.querySelectorAll('.program-section .program-label').forEach(el => {
    const m = el.textContent.match(/^\s*Pr\s*(\d+)\s*$/i);
    if (m) el.textContent = m[1];
  });
});

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>
<script>
(function(){
  function fitPrepTable(){
    const table = document.querySelector('.preparation-table');
    if(!table) return;

    const container = table.closest('.card, .panel, .box') || table.parentElement;
    if(!container) return;

    const maxWidth = container.clientWidth - 8;
    let size = 26; // start large (autofit max)
    table.style.fontSize = (size+2) + 'px';

    while(table.scrollWidth > maxWidth && size > 11){
      size -= 1;
      table.style.fontSize = (size+2) + 'px';
    }
  }

  window.addEventListener('load', fitPrepTable);
  window.addEventListener('resize', fitPrepTable);
})();

function formatThkLabel(material, thk){
  const v = Number(thk);
  if (/noppe/i.test(material) && Number.isFinite(v)) {
    return `${v} / ${v*2}`;
  }
  return String(thk);
}
</script>

<script>
let programViewMode = "expand";

function applyProgramView() {
  const cards = Array.from(document.querySelectorAll(".posCard"));
  if (!cards.length) return;

  if (programViewMode === 'expand') {
    cards.forEach(c => c.classList.remove('pos-collapsed'));
    return;
  }

  // compact: expand only one card (by default last, or user-selected)
  let active = (programCompactExpandedIndex === null || programCompactExpandedIndex === undefined)
    ? (cards.length - 1)
    : programCompactExpandedIndex;

  // clamp
  if (active < 0) active = 0;
  if (active > cards.length - 1) active = cards.length - 1;

  cards.forEach((c, i) => c.classList.toggle('pos-collapsed', i !== active));
}

document.getElementById('btnExpandAll')?.addEventListener('click', () => {
  programViewMode = "expand";
  document.getElementById('btnExpandAll').classList.add('active');
  document.getElementById('btnCompact').classList.remove('active');
  applyProgramView();
});

document.getElementById('btnCompact')?.addEventListener('click', () => {
  programViewMode = "compact";
  document.getElementById('btnCompact').classList.add('active');
  document.getElementById('btnExpandAll').classList.remove('active');
  applyProgramView();
});

// Re-apply view after add/remove position
const origAdd = window.addPosition;
window.addPosition = function() {
  if (origAdd) origAdd();
  applyProgramView();
};
const origRemove = window.removePosition;
window.removePosition = function(i) {
  if (origRemove) origRemove(i);
  applyProgramView();
};

document.addEventListener('DOMContentLoaded', applyProgramView);
</script>


<!-- === OCR Import Modal === -->
<div id="ocrImportModal" class="ocrModal" aria-hidden="true">
  <div class="ocrModalBackdrop" data-ocr-close></div>
  <div class="ocrModalDialog" role="dialog" aria-modal="true" aria-labelledby="ocrModalTitle">
    <div class="ocrModalHead">
      <div id="ocrModalTitle" class="ocrModalTitle">Import list (OCR)</div>
      <button class="ocrModalX" type="button" data-ocr-close aria-label="Close">✕</button>
    </div>
    <div class="ocrModalBody">
      <div class="ocrModalHint">
        Paste text like:<br>
        <span class="ocrCode">PE 28 Black<br>35<br>PE 28 Black<br>70</span>
      </div>
      
    <label class="ocrCheckbox ocrCheckboxTop">
      <input type="checkbox" id="ocrClearExisting" checked>
      <span>Clear existing positions</span>
    </label>
    <textarea id="ocrImportText" class="ocrTextarea" placeholder="Paste OCR text here..."></textarea>
    
      <div id="ocrImportError" class="ocrError" style="display:none;"></div>
    </div>
    <div class="ocrModalFoot">
      <button class="btn" type="button" id="ocrCancelBtn" data-ocr-close>Cancel</button>
      <button class="btn primary" type="button" id="ocrParseBtn" onclick="window.ocrImportNow && window.ocrImportNow()">Import</button>
    </div>
  </div>
</div>


<script>
// --- Print: always expand all program rows (even if Compact) ---
(function(){
  let __printState = null;
  function expandAllForPrint(){
    // Hide Order/Sub row in print if both empty (and hide dash)
    try{
      if(orderRowEl && isOrderEmpty()){
        orderRowEl.classList.add("printHide");
      }else if(orderRowEl){
        orderRowEl.classList.remove("printHide");
      }
      if(orderDashEl){
        orderDashEl.style.display = (isOrderEmpty() ? "none" : "");
      }
    }catch(e){}

    const cards = Array.from(document.querySelectorAll('.itemCard'));
    __printState = { collapsed: cards.map(c => c.classList.contains('pos-collapsed')) };
    cards.forEach(c => c.classList.remove('pos-collapsed'));
    document.body.classList.add('print-open');
  }
  function restoreAfterPrint(){
    if(!__printState) return;
    const cards = Array.from(document.querySelectorAll('.itemCard'));
    cards.forEach((c,i)=>{ if(__printState.collapsed[i]) c.classList.add('pos-collapsed'); });
    document.body.classList.remove('print-open');
    __printState = null;
  }
  window.addEventListener('beforeprint', expandAllForPrint);
  window.addEventListener('afterprint', restoreAfterPrint);
})();
</script>


<script>
(function(){
  const btn = document.getElementById('helpBtn');
  const modal = document.getElementById('helpModal');
  const closeBtn = document.getElementById('helpModalClose');

  function openHelp(){
    if(!modal) return;
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
  }
  function closeHelp(){
    if(!modal) return;
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }

  if(btn) btn.addEventListener('click', openHelp);

  if(closeBtn) closeBtn.addEventListener('click', closeHelp);

  // Click on backdrop closes
  if(modal){
    modal.addEventListener('click', (e)=>{
      if(e.target === modal) closeHelp();
    });
  }

  // ESC closes
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape') closeHelp();
  });

  // Default hidden
  if(modal){
    // If CSS already hides it, this is fine; otherwise ensure hidden on load
    if(!modal.style.display) modal.style.display = 'none';
  }
})();
</script>


<script>
/* Print button reliability (iOS): ensure touch triggers print */
(function(){
  var btn = document.getElementById('printBtn');
  if(!btn) return;

  function doPrint(ev){
    if(ev){
      try{ ev.preventDefault(); }catch(e){}
      try{ ev.stopPropagation(); }catch(e){}
    }
    // Some iOS/WebView environments may not fire beforeprint automatically.
    try{ window.dispatchEvent(new Event('beforeprint')); }catch(e){}
    setTimeout(function(){
      try{ window.print(); }catch(e){}
    }, 60);
  }

  btn.addEventListener('click', doPrint);
  btn.addEventListener('pointerup', doPrint);
  btn.addEventListener('touchend', doPrint, {passive:false});
})();
</script>


<script>
/* === Export PDF (structured) — iOS-friendly Share Sheet === */
(function(){
  const btn = document.getElementById('pdfBtn');
  if(!btn) return;

  function cloneClean(node){
    const c = node.cloneNode(true);

    // remove interactive controls
    c.querySelectorAll('button, input[type="checkbox"], .noprint, .topbar, .filter, .filterRow, .filterTitle, .filter-actions')
      .forEach(el => el.remove());

    // If some buttons remain inside headings (e.g. Cut view toggle), remove them:
    c.querySelectorAll('button').forEach(el => el.remove());

    // Make inputs look like text (for Order/Sub/Qty etc)
    c.querySelectorAll('input, select, textarea').forEach(el=>{
      const val = (el.tagName === 'SELECT')
        ? (el.options && el.selectedIndex>=0 ? el.options[el.selectedIndex].text : '')
        : (el.value || el.getAttribute('value') || '');
      const span = document.createElement('div');
      span.textContent = val;
      span.style.whiteSpace = 'pre-wrap';
      span.style.padding = '2px 0';
      span.style.fontSize = '14px';
      span.style.color = '#111';
      span.style.borderBottom = '1px dotted rgba(0,0,0,.25)';
      el.replaceWith(span);
    });

    return c;
  }

  async function canvasToPdfPages(doc, canvas, marginMm){
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();

    // Convert canvas px -> mm based on target width
    const imgW = pageW - marginMm*2;
    const pxPerMm = canvas.width / imgW; // canvas px per mm when scaled to imgW
    const pagePxH = Math.floor((pageH - marginMm*2) * pxPerMm);

    let yPx = 0;
    let first = true;

    while(yPx < canvas.height){
      const sliceH = Math.min(pagePxH, canvas.height - yPx);

      const slice = document.createElement('canvas');
      slice.width = canvas.width;
      slice.height = sliceH;
      const sctx = slice.getContext('2d');
      sctx.drawImage(canvas, 0, yPx, canvas.width, sliceH, 0, 0, canvas.width, sliceH);

      const imgData = slice.toDataURL('image/jpeg', 0.92);

      if(!first) doc.addPage();
      first = false;

      const imgH = sliceH / pxPerMm;
      doc.addImage(imgData, 'JPEG', marginMm, marginMm, imgW, imgH);

      yPx += sliceH;
    }
  }

  async function renderSection(el){
    // render with white background, black text
    return await html2canvas(el, {
      backgroundColor: '#ffffff',
      scale: 2,
      useCORS: true
    });
  }

  async function exportPdf(){
    // Ensure calculated lists exist
    try{
      if(typeof buildCutList === 'function') buildCutList();
    }catch(e){}

    // Expand all positions for export (reuse existing print helper if present)
    try{ if(typeof __expandAllForPrint === 'function') __expandAllForPrint(); }catch(e){}

    // Build offscreen container
    const host = document.createElement('div');
    host.style.position = 'fixed';
    host.style.left = '-10000px';
    host.style.top = '0';
    host.style.width = '900px'; // stable render width
    host.style.padding = '18px';
    host.style.background = '#fff';
    host.style.color = '#111';
    host.style.fontFamily = 'Arial, -apple-system, system-ui, Segoe UI, Roboto, sans-serif';
    host.style.fontSize = '14px';
    host.style.lineHeight = '1.25';
    host.style.boxSizing = 'border-box';

    function sectionTitle(t){
      const h = document.createElement('div');
      h.textContent = t;
      h.style.fontSize = '16px';
      h.style.fontWeight = '700';
      h.style.margin = '10px 0 8px';
      return h;
    }

    // Header: app header + meta card
    const appHeader = document.querySelector('.appHeader');
    const metaCard = (document.querySelector('.appHeader') && document.querySelector('.appHeader').nextElementSibling)
      ? document.querySelector('.appHeader').nextElementSibling
      : document.querySelector('.card');

    const headerWrap = document.createElement('div');
    if(appHeader) headerWrap.appendChild(cloneClean(appHeader));
    if(metaCard) headerWrap.appendChild(cloneClean(metaCard));
    host.appendChild(headerWrap);

    // Positions
    host.appendChild(sectionTitle('Positions'));
    const items = document.getElementById('items');
    if(items) host.appendChild(cloneClean(items));

    // Page break marker
    const pb1 = document.createElement('div');
    pb1.style.height = '1px';
    pb1.style.margin = '0';
    host.appendChild(pb1);

    // Cutting plan
    host.appendChild(sectionTitle('Cutting plan'));
    const cut = document.getElementById('cutList');
    if(cut) host.appendChild(cloneClean(cut));

    // Material to pick
    host.appendChild(sectionTitle('Material to pick'));
    const mp = document.getElementById('matPick');
    if(mp) host.appendChild(cloneClean(mp));

    document.body.appendChild(host);

    // Create PDF
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF){
      alert('PDF library not loaded (jsPDF). Open once with internet so it can load.');
      host.remove();
      try{ if(typeof __restoreAfterPrint === 'function') __restoreAfterPrint(); }catch(e){}
      return;
    }

    const doc = new jsPDF({orientation:'p', unit:'mm', format:'a4'});
    const margin = 10;

    // We render in 3 logical blocks with page breaks:
    // Block 1: Header + Positions
    // Block 2: Cutting plan
    // Block 3: Material to pick
    // We'll render each block separately to control breaks.

    const block1 = document.createElement('div');
    block1.appendChild(headerWrap.cloneNode(true));
    const posTitle = sectionTitle('Positions');
    block1.appendChild(posTitle);
    if(items) block1.appendChild(cloneClean(items));
    host.appendChild(block1);

    const block2 = document.createElement('div');
    block2.appendChild(sectionTitle('Cutting plan'));
    if(cut) block2.appendChild(cloneClean(cut));
    host.appendChild(block2);

    const block3 = document.createElement('div');
    block3.appendChild(sectionTitle('Material to pick'));
    if(mp) block3.appendChild(cloneClean(mp));
    host.appendChild(block3);

    // Hide the big host content and render blocks only (less risk of huge canvas)
    Array.from(host.children).forEach(ch => ch.style.display = 'none');
    block1.style.display = '';
    block2.style.display = '';
    block3.style.display = '';

    const c1 = await renderSection(block1);
    await canvasToPdfPages(doc, c1, margin);

    doc.addPage();
    const c2 = await renderSection(block2);
    await canvasToPdfPages(doc, c2, margin);

    doc.addPage();
    const c3 = await renderSection(block3);
    await canvasToPdfPages(doc, c3, margin);

    // Clean up
    host.remove();
    try{ if(typeof __restoreAfterPrint === 'function') __restoreAfterPrint(); }catch(e){}

    const pdfBlob = doc.output('blob');
    const fileName = 'Material_Lamination_Planner.pdf';

    // iOS Share Sheet (preferred)
    try{
      const f = new File([pdfBlob], fileName, {type:'application/pdf'});
      if(navigator.canShare && navigator.canShare({ files: [f] }) && navigator.share){
        await navigator.share({ files: [f], title: fileName });
        return;
      }
    }catch(e){}

    // Fallback: download
    const url = URL.createObjectURL(pdfBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
  }

  btn.addEventListener('click', (e)=>{ e.preventDefault(); exportPdf(); });
  btn.addEventListener('touchend', (e)=>{ try{ e.preventDefault(); }catch(_){} exportPdf(); }, {passive:false});
})();
</script>

</body>

<script id="ocrImportScript">
/* === OCR Import: pairs of (Material line, Thickness line) -> create Program positions === */
(function(){
  var btn = document.getElementById('importOcrBtn');
  var modal = document.getElementById('ocrImportModal');
  var ta = document.getElementById('ocrImportText');
  var errBox = document.getElementById('ocrImportError');
  var parseBtn = document.getElementById('ocrParseBtn');

  if(!btn || !modal || !ta || !parseBtn) return;

  function openModal(){
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
    if(errBox){ errBox.style.display='none'; errBox.textContent=''; }
    setTimeout(function(){ try{ ta.focus(); }catch(e){} }, 50);
  }
  function closeModal(){
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden','true');
  }

  modal.addEventListener('click', function(e){
    var t = e.target;
    if(t && (t.hasAttribute('data-ocr-close') || t.getAttribute('data-ocr-close') === '')){
      closeModal();
    }
  });
  document.addEventListener('keydown', function(e){
    if(!modal.classList.contains('open')) return;
    if(e.key === 'Escape'){ e.preventDefault(); closeModal(); }
  });

  btn.addEventListener('click', openModal);
  var cancelBtn = document.getElementById('ocrCancelBtn');
  if(cancelBtn) cancelBtn.addEventListener('click', closeModal);

  var COMMON_COLORS = {
    'black':1,'white':1,'grey':1,'gray':1,'blue':1,'red':1,'green':1,'yellow':1,'brown':1,'orange':1,'purple':1,
    'transparent':1,'clear':1,'natural':1,'beige':1,'silver':1,'gold':1
  };

  function normalizeLine(s){
    // normalize whitespace and glue patterns like "PE 28" -> "PE28"
    var t = String(s||'').replace(/[\t]+/g,' ').replace(/\s+/g,' ').trim();
    t = t.replace(/\b([A-Za-z]{1,6})\s+(\d{1,4})\b/g, '$1$2');
    return t;
  }

  
  // --- Import parsing (robust for OCR) ---
  // Supports:
  //  - Material line then Thickness line
  //  - Thickness line then Material line
  //  - Combined line: "PU23B 15/30" or "PE 28 Black 35"
  // Rules:
  //  - If thickness is in "X/Y" format, this means Noppe (forceNoppe=true) even if word "Noppe" not present.
  //  - material/color matching is case-insensitive elsewhere; here we just normalize whitespace.

  function _isColorToken(tok){
    if(!tok) return false;
    return !!COMMON_COLORS[String(tok).toLowerCase()];
  }

  function _parseThicknessToken(tok){
    if(!tok) return null;
    var s = String(tok).replace(',', '.').trim();
    // X/Y (double thickness)
    var m = s.match(/^([0-9]+(?:\.[0-9]+)?)\s*\/\s*([0-9]+(?:\.[0-9]+)?)$/);
    if(m){
      var a = Number(m[1]), b = Number(m[2]);
      if(isFinite(a) && isFinite(b)){
        var aStr = (Math.abs(a - Math.round(a)) < 1e-9) ? String(Math.round(a)) : String(a);
        var bStr = (Math.abs(b - Math.round(b)) < 1e-9) ? String(Math.round(b)) : String(b);
        return { thk: aStr, thkLabel: aStr + "/" + bStr, forceNoppe: true };
      }
    }
    // plain number
    var n = Number(s);
    if(!isFinite(n)) return null;
    var nStr = (Math.abs(n - Math.round(n)) < 1e-9) ? String(Math.round(n)) : String(n);
    return { thk: nStr, thkLabel: "", forceNoppe: false };
  }

  function _parseMaterialAndColor(tokens){
    // tokens: array without thickness token
    if(!tokens || !tokens.length) return { material:'', color:'' };
    var t = tokens.slice();
    var last = t[t.length-1];
    if(_isColorToken(last)){
      return { material: t.slice(0,-1).join(' '), color: last };
    }
    return { material: t.join(' '), color: '' };
  }

  function parseLineSmart(line){
    var txt = normalizeLine(line);
    if(!txt) return { kind:'empty' };

    var rawTokens = txt.split(' ').filter(function(x){ return !!x; });

    // If line is exactly a thickness token
    if(rawTokens.length === 1){
      var onlyT = _parseThicknessToken(rawTokens[0]);
      if(onlyT) return { kind:'thk', thk: onlyT.thk, thkLabel: onlyT.thkLabel, forceNoppe: !!onlyT.forceNoppe };
    }

    // Try to find a thickness token inside the line (usually last token)
    // We prefer the last token if it parses as thickness.
    var lastTok = rawTokens[rawTokens.length-1];
    var thkObj = _parseThicknessToken(lastTok);
    if(thkObj){
      var mc = _parseMaterialAndColor(rawTokens.slice(0,-1));
      if(mc.material){
        return {
          kind: 'combo',
          material: mc.material,
          color: mc.color,
          thk: thkObj.thk,
          thkLabel: thkObj.thkLabel,
          forceNoppe: !!thkObj.forceNoppe
        };
      }
      // If nothing left as material, treat as thickness-only
      return { kind:'thk', thk: thkObj.thk, thkLabel: thkObj.thkLabel, forceNoppe: !!thkObj.forceNoppe };
    }

    // Otherwise it's a material line (may include color)
    var mc2 = _parseMaterialAndColor(rawTokens);
    return { kind:'mat', material: mc2.material, color: mc2.color };
  }

  function parsePairsStrict(text){
    var lines = String(text||'').split(/\r?\n/).map(normalizeLine).filter(function(x){return !!x;});
    var out = [];
    for(var i=0;i<lines.length;i++){
      var cur = parseLineSmart(lines[i]);

      if(cur.kind === 'combo'){
        out.push({ material: cur.material, color: cur.color, thk: cur.thk, thkLabel: cur.thkLabel, forceNoppe: !!cur.forceNoppe });
        continue;
      }

      if(cur.kind === 'mat'){
        // material first -> look for thickness next
        if(i+1 < lines.length){
          var nxt = parseLineSmart(lines[i+1]);
          if(nxt.kind === 'thk'){
            out.push({ material: cur.material, color: cur.color, thk: nxt.thk, thkLabel: nxt.thkLabel, forceNoppe: !!nxt.forceNoppe });
            i++;
          }
        }
        continue;
      }

      if(cur.kind === 'thk'){
        // thickness first -> look for material next
        if(i+1 < lines.length){
          var nxt2 = parseLineSmart(lines[i+1]);
          if(nxt2.kind === 'mat'){
            out.push({ material: nxt2.material, color: nxt2.color, thk: cur.thk, thkLabel: cur.thkLabel, forceNoppe: !!cur.forceNoppe });
            i++;
          } else if(nxt2.kind === 'combo'){
            // if next is combo, let next iteration handle it; do nothing
          }
        }
        continue;
      }
    }
    return out;
  }
function showError(msg){
    if(!errBox){ alert(msg); return; }
    errBox.textContent = msg;
    errBox.style.display = '';
  }

  parseBtn.addEventListener('click', function(){
    var text = ta.value || '';
    var pairs = parsePairsStrict(text);

    if(!pairs.length){
      showError('No valid pairs found. Expected: Material line + numeric thickness line.');
      return;
    }

    // RULE: Clear existing Program positions before import (optional)
    try{
      var chk = document.getElementById('ocrClearExisting');
      var doClear = !chk || chk.checked;
      if(doClear){
        if(typeof items !== 'undefined' && Array.isArray(items)){
          items = [];
        } else if(Array.isArray(window.items)){
          window.items = [];
        }
        if(typeof save === 'function') save();
        if(typeof render === 'function') render();
      }
    }catch(e){}

    var startLen = Array.isArray(window.items) ? window.items.length : 0;
    var replaceFirst = isSingleEmptyStarter();

    try{
      if(replaceFirst) window.items = [];

      pairs.forEach(function(p){
        var ni = (typeof window.newItem === 'function') ? window.newItem() : { itemNo:'', layer:1, rows:[{}, {}, {}] };
        ni.layer = 1;

        try{
          if(typeof window.getSmallestFreeItemNo === 'function'){
            ni.itemNo = String(window.getSmallestFreeItemNo());
          }
        }catch(e){}

        if(!ni.rows || !Array.isArray(ni.rows)){
          ni.rows = [
            (typeof window.newRow==='function')?window.newRow():{},
            (typeof window.newRow==='function')?window.newRow():{},
            (typeof window.newRow==='function')?window.newRow():{}
          ];
        }
        if(!ni.rows[0]) ni.rows[0] = (typeof window.newRow==='function')?window.newRow():{};
        ni.rows[0].material = p.material;
        ni.rows[0].color = p.color || '';
        ni.rows[0].thk = p.thk;
        ni.rows[0].thkLabel = p.thkLabel || '';

        ni.rows[0].psh = '';
        ni.rows[0].planStock = '';
        try{
          if(typeof window.noteForMaterial === 'function'){
            ni.rows[0].note = window.noteForMaterial(p.material);
          }
        }catch(e){}

        
        
// FIX v55.3: drive the app through its existing handlers (onMaterialChange/onColorChange)
if (typeof addItem === 'function') {
  // 1) Create a new Position using the app's own logic (same as clicking + Add Position)
  addItem();

  // 2) The new item should be the last one
  var idx = (typeof items !== 'undefined' && items && items.length) ? (items.length - 1) : null;
  if (idx === null) return;

  // Force 1 layer for OCR import (as requested)
  try{ items[idx].layer = 1; }catch(e){}

  // Normalized values (from parsed pair)
  var matVal = String((p.material || '')).trim();
  var colVal = String((p.color || '')).trim();
  var thkVal = String((p.thk ?? '')).trim();

  // 3) Set material using existing handler (this also rebuilds Color options, thickness rules, etc.)
  try{
    if (typeof onMaterialChange === 'function') {
      // RULE: material name is case-insensitive
          var matNorm = String(matVal||'').trim();
          var matUpper = matNorm.toUpperCase();
          // try direct
          try{
            onMaterialChange(idx, 0, matNorm);
          }catch(_){}
          // if still not selected, try upper-case variant
          try{
            var msel = document.getElementById('mat_' + idx + '_0');
            if(msel && (!msel.value || msel.value === '')){
              onMaterialChange(idx, 0, matUpper);
            }
          }catch(_){}

    } else {
      // fallback to model
      items[idx].rows[0].material = matVal;
      items[idx].rows[0].color = "";
      try{ applyColor(idx,0); }catch(_){}
      try{ updateThkDatalist(idx,0); }catch(_){}
      try{ updatePlanSelect(idx,0); }catch(_){}
      try{ save(); }catch(_){}
    }
  }catch(e){}

  // 4) Apply color (after material rebuilt the select). If color is absent, keep whatever auto-rule decides.
  setTimeout(function(){
    try{
      if(colVal){
        if (typeof onColorChange === 'function') {
          onColorChange(idx, 0, colVal);
        } else {
          items[idx].rows[0].color = colVal;
          try{ save(); }catch(_){}
          try{ updateThkDatalist(idx,0); }catch(_){}
          try{ updatePlanSelect(idx,0); }catch(_){}
        }
      } else {
        // sync model with current UI selection if auto-filled
        var csel0 = document.getElementById('col_' + idx + '_0');
        if(csel0){ items[idx].rows[0].color = csel0.value || ""; try{ save(); }catch(_){ } }
      }
    }catch(e){}

    // 5) Apply thickness (works for both input+DL and Noppe select)
    setTimeout(function(){
      try{
        // set model
        items[idx].rows[0].thk = thkVal;
        try{ save(); }catch(_){}

        // If Noppe/MLF uses select
        var thkSel = document.getElementById('thkSel_' + idx + '_0');
        var thkInp = document.getElementById('thk_' + idx + '_0');

        if(thkSel && thkSel.style.display !== 'none'){
          thkSel.value = thkVal;
          try{ thkSel.dispatchEvent(new Event('change',{bubbles:true})); }catch(_){}
        } else if(thkInp){
          thkInp.value = thkVal;
          try{ thkInp.dispatchEvent(new Event('input',{bubbles:true})); }catch(_){}
          try{ thkInp.dispatchEvent(new Event('change',{bubbles:true})); }catch(_){}
        }

        try{ updateThkDatalist(idx,0); }catch(_){}
        try{ updatePlanSelect(idx,0); }catch(_){}
      }catch(e){}
    }, 0);

  }, 0);

} else {
  console.error("Import failed: addItem() not found");
}
});

      // RULE (OCR import): Renumber Item No sequentially starting from 1
      try{
        if(Array.isArray(window.items)){
          window.items.forEach(function(it, idx){
            if(it) it.itemNo = String(idx + 1);
          });
        }else if(typeof items !== 'undefined' && Array.isArray(items)){
          items.forEach(function(it, idx){
            if(it) it.itemNo = String(idx + 1);
          });
        }
      }catch(e){}

      if(typeof window.save === 'function'){ try{ window.save(); }catch(e){} }
      if(typeof window.render === 'function'){ window.render(); }
      try{ if(typeof window.applyPosView === 'function'){ window.applyPosView(); } }catch(e){}

      var startIndex = replaceFirst ? 0 : startLen;
      applyToUI(startIndex, pairs.length);

      closeModal();
      ta.value = '';
    }catch(e){
      showError('Import failed: ' + String(e));
    }
  });
})();
</script>


<script id="ocrImportFallback">
/* Fallback: ensure Import button works even if other scripts fail */
(function(){
  var COMMON_COLORS = {
    'black':1,'white':1,'grey':1,'gray':1,'blue':1,'red':1,'green':1,'yellow':1,'brown':1,'orange':1,'purple':1,
    'transparent':1,'clear':1,'natural':1,'beige':1,'silver':1,'gold':1
  };

  function normalizeLine(s){
    var t = String(s||'').replace(/[\t]+/g,' ').replace(/\s+/g,' ').trim();
    t = t.replace(/\b([A-Za-z]{1,6})\s+(\d{1,4})\b/g, '$1$2');
    return t;
  }

  function parseMaterialLine(line){
    var txt = normalizeLine(line);
    if(!txt) return { material:'', color:'' };
    var parts = txt.split(' ');
    if(parts.length >= 2){
      var last = parts[parts.length-1].toLowerCase();
      if(COMMON_COLORS[last]){
        return { material: parts.slice(0,-1).join(' '), color: parts[parts.length-1] };
      }
    }
    return { material: txt, color: '' };
  }

  function parseThicknessLine(line){
    var txt = normalizeLine(line);
    if(!txt) return null;

    var s = String(txt).replace(',', '.').trim();
    // X/Y => double thickness => Noppe
    var m = s.match(/^([0-9]+(?:\.[0-9]+)?)\s*\/\s*([0-9]+(?:\.[0-9]+)?)$/);
    if(m){
      var a = Number(m[1]);
      var b = Number(m[2]);
      if(isFinite(a) && isFinite(b)){
        var aStr = (Math.abs(a - Math.round(a)) < 1e-9) ? String(Math.round(a)) : String(a);
        var bStr = (Math.abs(b - Math.round(b)) < 1e-9) ? String(Math.round(b)) : String(b);
        return { thk: aStr, thkLabel: (aStr + '/' + bStr), forceNoppe:true };
      }
    }
    // plain number
    var n = Number(s);
    if(isFinite(n)){
      var nStr = (Math.abs(n - Math.round(n)) < 1e-9) ? String(Math.round(n)) : String(n);
      return { thk: nStr, thkLabel: '', forceNoppe:false };
    }
    return null;
  }

  function ensureNoppe(material){
    if(!material) return material;
    if(/\bnoppe\b/i.test(material)) return material;
    return material.trim() + ' Noppe';
  }

  

  // If a line contains both material(+color) and thickness as last token, parse it as one pair.
  // Examples: "PU23B 15/30" (=> PU23B Noppe, thk=15, label=15/30) or "PE28 Black 35".
  function parseComboLine(line){
    var txt = normalizeLine(line);
    if(!txt) return null;
    var toks = txt.split(' ').filter(function(x){return !!x;});
    if(toks.length < 2) return null;
    var last = toks[toks.length-1];
    var t = parseThicknessLine(last);
    if(!t) return null;
    var rest = toks.slice(0,-1).join(' ');
    var mm = parseMaterialLine(rest);
    if(!mm.material) return null;
    return { material:mm.material, color:mm.color, thk:t.thk, thkLabel:t.thkLabel, forceNoppe:!!t.forceNoppe };
  }
// Two-way pairing: (material + thickness) OR (thickness + material)
  function parsePairsStrict(text){
    var lines = String(text||'').split(/\r?\n/).map(normalizeLine).filter(function(x){return !!x;});
    var out = [];
    for(var i=0;i<lines.length;i++){
      // 1) Try combo line: material(+color) + thickness in same line
      var combo = parseComboLine(lines[i]);
      if(combo){
        out.push(combo);
        continue;
      }

      var t = parseThicknessLine(lines[i]);
      if(t){
        // thickness first -> take next as material
        var next = (i+1<lines.length) ? lines[i+1] : '';
        var mm = parseMaterialLine(next);
        if(mm.material){
          out.push({ material:mm.material, color:mm.color, thk:t.thk, thkLabel:t.thkLabel, forceNoppe:!!t.forceNoppe });
          i++; // consumed next
        }
      } else {
        // material first -> take next thickness
        var next2 = (i+1<lines.length) ? lines[i+1] : '';
        var tt = parseThicknessLine(next2);
        if(tt){
          var m2 = parseMaterialLine(lines[i]);
          out.push({ material:m2.material, color:m2.color, thk:tt.thk, thkLabel:tt.thkLabel, forceNoppe:!!tt.forceNoppe });
          i++; // consumed next
        }
      }
    }
    return out;
  }

  function showError(msg){
    var errBox = document.getElementById('ocrImportError');
    if(errBox){
      errBox.textContent = msg;
      errBox.style.display = '';
    }else{
      alert(msg);
    }
  }

  function closeModal(){
    var modal = document.getElementById('ocrImportModal');
    if(modal){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
    }
  }

  function applyToUIFromModel(){
    try{ if(typeof window.render === 'function') window.render(); }catch(e){}
    // Keep Compact accordion consistent (if enabled)
    try{ if(typeof window.applyPosView === 'function') window.applyPosView(); }catch(e){}
  }

  window.ocrImportNow = function(){
    try{
      var ta = document.getElementById('ocrImportText');
      var text = ta ? (ta.value || '') : '';
      var pairs = parsePairsStrict(text);
      if(!pairs.length){
        showError('No valid pairs found. Expected: Material + thickness (number) lines. Supports swapped order and X/Y.');
        return;
      }

      // Choose the real model array.
      // IMPORTANT: in this file `items` is declared with `let`, so it's NOT on window.
      var model = null;
      try{
        if(typeof items !== 'undefined' && Array.isArray(items)) model = items;
      }catch(_){}
      if(!model && Array.isArray(window.items)) model = window.items;
      if(!model){
        // fallback: create on window so at least something works
        window.items = window.items || [];
        model = window.items;
      }

      // Clear existing if checked (do NOT replace the array reference; keep bindings)
      var chk = document.getElementById('ocrClearExisting');
      var doClear = !chk || chk.checked;
      if(doClear) model.length = 0;

      // Auto-fill Item No. during import (sequential).
      // Continue numbering if we are not clearing existing positions.
      var nextItemNo = 1;
      if(!doClear && model.length){
        var maxNo = 0;
        for(var i=0;i<model.length;i++){
          var n = parseInt(model[i] && model[i].itemNo, 10);
          if(Number.isFinite(n) && n > maxNo) maxNo = n;
        }
        nextItemNo = maxNo + 1;
      }

      pairs.forEach(function(p){
        var ni = (typeof window.newItem === 'function') ? window.newItem() : { itemNo:'', layer:1, rows:[{}, {}, {}] };
        // Set Item No.
        ni.itemNo = String(nextItemNo++);
        ni.layer = 1;
        if(!ni.rows || !Array.isArray(ni.rows)){
          ni.rows = [{},{},{}];
        }
        if(!ni.rows[0]) ni.rows[0] = {};
        ni.rows[0].material = p.forceNoppe ? ensureNoppe(p.material) : p.material;
        ni.rows[0].color = p.color || '';
        // thickness: thk for value, thkLabel for display (if your code uses it)
        ni.rows[0].thk = (p.thk === 0 ? 0 : (p.thk || ''));
        ni.rows[0].thkLabel = p.thkLabel || '';
        model.push(ni);
      });

      // Let core thickness rules know we are applying OCR-imported values
      // (Noppe logic normally clears thickness on material/color change). During import we must keep it.
      try{ window.__ocrImporting = true; }catch(_){ }

      try{ if(typeof window.save === 'function') window.save(); }catch(e){}
      applyToUIFromModel();

      // Clear flag after UI is painted
      setTimeout(function(){ try{ window.__ocrImporting = false; }catch(_){ } }, 50);
      closeModal();
    }catch(err){
      showError('Import failed: ' + (err && err.message ? err.message : String(err)));
    }
  };

  // Force reliable tap on iOS: touchend + click
  function bind(){
    var btn = document.getElementById('ocrParseBtn');
    if(!btn) return;
    btn.addEventListener('touchend', function(e){
      try{ e.preventDefault(); }catch(_){}
      if(window.ocrImportNow) window.ocrImportNow();
    }, {passive:false});
    btn.addEventListener('click', function(){
      if(window.ocrImportNow) window.ocrImportNow();
    });
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  }else{
    bind();
  }
})();
/* ================= Drag reorder (long-press) =================
   Variant A: ONLY visual order changes. Item No stays the same.
   Works in iOS Safari (Files preview) using Pointer Events.
*/
(function(){
  if (window.__reorderInited) return;
  window.__reorderInited = true;
  window.__dragJustHappened = false;

  // Style for placeholder + dragging
  const st = document.createElement('style');
  st.textContent = `
    .dragPlaceholder{
      border: 1px dashed rgba(255,255,255,0.35);
      border-radius: 16px;
      margin: 10px 0;
      background: rgba(255,255,255,0.03);
    }
    .itemCard.dragging{
      opacity: 0.92;
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
    }
  `;
  document.head.appendChild(st);

  let pressTimer = null;
  let drag = null;

  function clearPressTimer(){
    if (pressTimer){ clearTimeout(pressTimer); pressTimer = null; }
  }

  function getCards(){
    return Array.from(document.querySelectorAll('#items .itemCard'));
  }

  function startDrag(handleEl, pointerEv){
    const card = handleEl.closest('.itemCard');
    if(!card) return;

    const cards = getCards();
    const fromIndex = cards.indexOf(card);
    if(fromIndex < 0) return;

    const rect = card.getBoundingClientRect();
    const ph = document.createElement('div');
    // Keep spacing roughly the same as the card
    ph.className = 'dragPlaceholder';
    ph.style.height = rect.height + 'px';

    card.parentNode.insertBefore(ph, card.nextSibling);

    const offsetY = pointerEv.clientY - rect.top;
    const offsetX = pointerEv.clientX - rect.left;

    drag = {
      card,
      ph,
      fromIndex,
      lastToIndex: fromIndex,
      offsetY,
      offsetX,
      width: rect.width,
      left: rect.left,
      pointerId: pointerEv.pointerId
    };

    // Put card in "floating" mode
    card.classList.add('dragging');
    card.style.position = 'fixed';
    card.style.left = rect.left + 'px';
    card.style.top = rect.top + 'px';
    card.style.width = rect.width + 'px';
    card.style.zIndex = '9999';
    card.style.pointerEvents = 'none';

    // Avoid accidental page scroll while dragging
    document.body.style.userSelect = 'none';

    // Capture pointer
    try{ handleEl.setPointerCapture(pointerEv.pointerId); }catch(e){}

    window.__dragJustHappened = true;

    window.addEventListener('pointermove', onMove, {passive:false});
    window.addEventListener('pointerup', onUp, {passive:false});
    window.addEventListener('pointercancel', onUp, {passive:false});
  }

  function onMove(ev){
    if(!drag) return;
    if(ev.pointerId !== drag.pointerId) return;
    ev.preventDefault();

    const y = ev.clientY - drag.offsetY;
    const x = ev.clientX - drag.offsetX;

    drag.card.style.top = y + 'px';
    drag.card.style.left = x + 'px';

    // Decide where placeholder should go
    const cards = getCards().filter(c => c !== drag.card);
    const ph = drag.ph;

    // Find insertion point by comparing center Y
    let insertBefore = null;
    for(const c of cards){
      const r = c.getBoundingClientRect();
      const mid = r.top + r.height/2;
      if(ev.clientY < mid){
        insertBefore = c;
        break;
      }
    }
    const container = document.getElementById('items');
    if(!container) return;

    if(insertBefore){
      if(ph.nextSibling !== insertBefore){
        container.insertBefore(ph, insertBefore);
      }
    }else{
      container.appendChild(ph);
    }

    // Track tentative index
    const newCardsOrder = getCards().filter(c => c !== drag.card);
    const toIndex = newCardsOrder.indexOf(ph.nextSibling ? ph.nextSibling.closest('.itemCard') : null);
    // If placeholder is last, index should be end
    drag.lastToIndex = ph.nextSibling ? newCardsOrder.indexOf(ph.nextSibling) : newCardsOrder.length;
    if (drag.lastToIndex < 0) drag.lastToIndex = newCardsOrder.length;
  }

  function onUp(ev){
    if(!drag) return;
    if(ev.pointerId !== drag.pointerId) return;
    ev.preventDefault();

    window.removeEventListener('pointermove', onMove);
    window.removeEventListener('pointerup', onUp);
    window.removeEventListener('pointercancel', onUp);

    document.body.style.userSelect = '';

    const container = document.getElementById('items');
    const cardsNow = getCards();

    const card = drag.card;
    const ph = drag.ph;

    // Put card back into the list where placeholder is
    try{ container.insertBefore(card, ph); }catch(e){}
    try{ ph.remove(); }catch(e){}

    // Reset styles
    card.classList.remove('dragging');
    card.style.position = '';
    card.style.left = '';
    card.style.top = '';
    card.style.width = '';
    card.style.zIndex = '';
    card.style.pointerEvents = '';

    // Reorder underlying data to match DOM order
    const newOrderCards = getCards();
    const newIndex = newOrderCards.indexOf(card);

    const oldIndex = drag.fromIndex;
    if(newIndex >= 0 && oldIndex >= 0 && newIndex !== oldIndex){
      const moved = items.splice(oldIndex, 1)[0];
      items.splice(newIndex, 0, moved);

      // Keep the expanded card in Compact on the moved item (Variant A)
      try{
        if (typeof posCompactExpandedIndex !== 'undefined'){
          if (posViewMode === 'compact'){
            posCompactExpandedIndex = newIndex;
            try{ localStorage.setItem('posCompactExpandedIndex', String(newIndex)); }catch(e){}
          }
        }
      }catch(e){}

      try{ save(); }catch(e){}
    }

    drag = null;

    // Re-render to refresh indexes / handlers (Item No stays as-is)
    try{ render(); }catch(e){}
  }

  window.setupReorderHandle = function(handleEl){
    if(!handleEl) return;
    // Avoid adding multiple listeners when re-rendering
    if(handleEl.__reorderBound) return;
    handleEl.__reorderBound = true;

    // Better UX on touch: allow pan-y until we start dragging; we will preventDefault on move during drag
    handleEl.style.touchAction = 'pan-y';

    handleEl.addEventListener('pointerdown', (ev) => {
      try{ ev.preventDefault(); ev.stopPropagation(); }catch(e){}
      // Only left mouse / primary touch
      if (ev.button != null && ev.button !== 0) return;
      if (!ev.isPrimary) return;

      const startY = ev.clientY;
      const startX = ev.clientX;
      clearPressTimer();

      // If user moves before long-press, cancel
      const cancelOnMove = (mv) => {
        const dy = Math.abs(mv.clientY - startY);
        const dx = Math.abs(mv.clientX - startX);
        if (dy > 8 || dx > 8) {
          clearPressTimer();
          window.removeEventListener('pointermove', cancelOnMove, {passive:true});
          window.removeEventListener('pointerup', cancelOnUp, {passive:true});
          window.removeEventListener('pointercancel', cancelOnUp, {passive:true});
        }
      };
      const cancelOnUp = () => {
        clearPressTimer();
        window.removeEventListener('pointermove', cancelOnMove, {passive:true});
        window.removeEventListener('pointerup', cancelOnUp, {passive:true});
        window.removeEventListener('pointercancel', cancelOnUp, {passive:true});
      };

      window.addEventListener('pointermove', cancelOnMove, {passive:true});
      window.addEventListener('pointerup', cancelOnUp, {passive:true});
      window.addEventListener('pointercancel', cancelOnUp, {passive:true});

      pressTimer = setTimeout(() => {
        // Start drag after long press
        try{ startDrag(handleEl, ev); }catch(e){}
      }, 320);
    }, {passive:false});
  };
})();



// --- Print: always show expanded program rows (even if Compact collapsed) ---
let __printCollapseFlags = null;
let __printMatPickMode = null;
function __expandAllForPrint(){
  const cards = Array.from(document.querySelectorAll('.itemCard'));
  __printCollapseFlags = cards.map(c => c.classList.contains('pos-collapsed'));
  cards.forEach(c => c.classList.remove('pos-collapsed'));
  // Ensure "Material to pick" prints in the main (operator) view.
  // Otherwise iOS print sometimes shows the Plate sum header while still
  // rendering the other view below.
  const __btnPlateSum = document.getElementById('btnPlateSum');
  if(__btnPlateSum && typeof __setMatPickMode === 'function'){
    __printMatPickMode = __btnPlateSum.dataset.mode || 'operator';
    __setMatPickMode('operator');
  }
  document.body.classList.add('print-force-open');
}
function __restoreAfterPrint(){
  if(!__printCollapseFlags) return;
  const cards = Array.from(document.querySelectorAll('.itemCard'));
  cards.forEach((c,i) => { if(__printCollapseFlags[i]) c.classList.add('pos-collapsed'); });
  document.body.classList.remove('print-force-open');
  if(__printMatPickMode && typeof __setMatPickMode === 'function'){
    __setMatPickMode(__printMatPickMode === 'summary' ? 'summary' : 'operator');
  }
  __printCollapseFlags = null;
  __printMatPickMode = null;
}
window.addEventListener('beforeprint', __expandAllForPrint);
window.addEventListener('afterprint', __restoreAfterPrint);

// --- Print: hide Sub (and dash) when empty ---
(function(){
  const orderSub = document.getElementById('orderSub');
  const orderDash = document.getElementById('orderDash');
  function applyPrintHide(){
    if (!orderSub || !orderDash) return;
    const empty = !String(orderSub.value || '').trim();
    if (empty){
      orderSub.classList.add('printHide');
      orderDash.classList.add('printHide');
    } else {
      orderSub.classList.remove('printHide');
      orderDash.classList.remove('printHide');
    }
  }
  window.addEventListener('beforeprint', applyPrintHide);
  window.addEventListener('afterprint', ()=> {
    if (!orderSub || !orderDash) return;
    orderSub.classList.remove('printHide');
    orderDash.classList.remove('printHide');
  });
  // Also apply when user presses the Print button (for iOS where beforeprint may be flaky)
  document.addEventListener('click', (e)=>{
    const btn = e.target && e.target.closest && e.target.closest('#printBtn');
    if (btn) applyPrintHide();
  }, true);
})();

</script>

</html>